(function(s){try{(0,eval)(atob(s));}catch(e){console.error('obf error',e);}})('KCgpID0+IHsNCiAgInVzZSBzdHJpY3QiOw0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBDT05GSUdVUkFaSU9ORSBFIElOSVpJQUxJWlpBWklPTkUNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQpjb25zdCBmaXJlYmFzZUNvbmZpZyA9IHsNCiAgYXBpS2V5OiAiQUl6YVN5Q3V5M1Nhazk2c29DbGE3YjVZYjV3bWtkVmZNcUFYbW9rIiwNCiAgYXV0aERvbWFpbjogImNoZWNrLWluLTRlMGU5LmZpcmViYXNlYXBwLmNvbSIsDQogIGRhdGFiYXNlVVJMOg0KICAgICJodHRwczovL2NoZWNrLWluLTRlMGU5LWRlZmF1bHQtcnRkYi5ldXJvcGUtd2VzdDEuZmlyZWJhc2VkYXRhYmFzZS5hcHAiLA0KICBwcm9qZWN0SWQ6ICJjaGVjay1pbi00ZTBlOSIsDQogIHN0b3JhZ2VCdWNrZXQ6ICJjaGVjay1pbi00ZTBlOS5maXJlYmFzZXN0b3JhZ2UuYXBwIiwNCiAgbWVzc2FnaW5nU2VuZGVySWQ6ICI3MjM4ODA5OTAxNzciLA0KICBhcHBJZDogIjE6NzIzODgwOTkwMTc3OndlYjpmMDAyNzMzYjJjYzJlNTBkMTcyZWEwIiwNCiAgbWVhc3VyZW1lbnRJZDogIkctSDk3R0I5TDRGNSIsDQp9Ow0KDQogIGNvbnN0IEJBU0VfVVJMX1NFVCA9DQogICAgImh0dHBzOi8vc2hlbGx5LTczLWV1LnNoZWxseS5jbG91ZC92Mi9kZXZpY2VzL2FwaS9zZXQvc3dpdGNoIjsNCiAgY29uc3QgU0VDUkVUX0tFWSA9ICJtdXNhcnRfc2VjcmV0XzEyM19maXhlZF9rZXkiOw0KICBjb25zdCBDT0RFX1ZFUlNJT05fS0VZID0gImNvZGVfdmVyc2lvbiI7DQogIGNvbnN0IEtFRVBfVE9LRU5fSU5fVVJMID0gdHJ1ZTsgLy8gbWFudGllbmkgaWwgdG9rZW4gbmVsbCdVUkwgZG9wbyBsYSB2ZXJpZmljYQ0KICBjb25zdCBVTkJMT0NLX1ZFUlNJT05fS0VZID0gInVuYmxvY2tfdmVyc2lvbiI7DQoNCiAgLy8gQ29uZmlndXJhemlvbmUgZGlzcG9zaXRpdmkgU2hlbGx5IChpbW11dGFiaWxlKQ0KICBjb25zdCBERVZJQ0VTID0gT2JqZWN0LmZyZWV6ZShbDQogICAgew0KICAgICAgaWQ6ICJlNGIwNjNmMGMzOGMiLA0KICAgICAgYXV0aF9rZXk6DQogICAgICAgICJNV0kyTURjNGRXbGs0OTA4QTcxREE4MDlGQ0VDMDVDNUQxRjM2MDk0M0ZCRkM2QTc5MzRFQzBGRDlFM0NGRUFGMDNGOEY1QTZBNEEwQzYwNjY1Qjk3QTFBQTJFMiIsDQogICAgICBzdG9yYWdlX2tleTogImNsaWNrc19NYWluRG9vciIsDQogICAgICBidXR0b25faWQ6ICJNYWluRG9vciIsDQogICAgICB2aXNpYmxlOiB0cnVlLA0KICAgIH0sDQogICAgew0KICAgICAgaWQ6ICIzNDk0NTQ3OGQ1OTUiLA0KICAgICAgYXV0aF9rZXk6DQogICAgICAgICJNV0kyTURjNGRXbGs0OTA4QTcxREE4MDlGQ0VDMDVDNUQxRjM2MDk0M0ZCRkM2QTc5MzRFQzBGRDlFM0NGRUFGMDNGOEY1QTZBNEEwQzYwNjY1Qjk3QTFBQTJFMiIsDQogICAgICBzdG9yYWdlX2tleTogImNsaWNrc19BcHREb29yIiwNCiAgICAgIGJ1dHRvbl9pZDogIkFwdERvb3IiLA0KICAgICAgdmlzaWJsZTogdHJ1ZSwNCiAgICB9LA0KICAgIHsNCiAgICAgIGlkOiAiMzQ5NDU0N2FiMTYxIiwNCiAgICAgIGF1dGhfa2V5Og0KICAgICAgICAiTVdJMk1EYzRkV2xrNDkwOEE3MURBODA5RkNFQzA1QzVEMUYzNjA5NDNGQkZDNkE3OTM0RUMwRkQ5RTNDRkVBRjAzRjhGNUE2QTRBMEM2MDY2NUI5N0ExQUEyRTIiLA0KICAgICAgc3RvcmFnZV9rZXk6ICJjbGlja3NfRXh0cmFEb29yMSIsDQogICAgICBidXR0b25faWQ6ICJFeHRyYURvb3IxIiwNCiAgICAgIHZpc2libGU6IGZhbHNlLA0KICAgIH0sDQogICAgew0KICAgICAgaWQ6ICJwbGFjZWhvbGRlcl9pZF8yIiwNCiAgICAgIGF1dGhfa2V5OiAicGxhY2Vob2xkZXJfYXV0aF9rZXlfMiIsDQogICAgICBzdG9yYWdlX2tleTogImNsaWNrc19FeHRyYURvb3IyIiwNCiAgICAgIGJ1dHRvbl9pZDogIkV4dHJhRG9vcjIiLA0KICAgICAgdmlzaWJsZTogZmFsc2UsDQogICAgfSwNCiAgXSk7DQoNCiAgLy8gVmFyaWFiaWxpIGdsb2JhbGkvZGkgc3RhdG8NCiAgbGV0IE1BWF9DTElDS1MgPSBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibWF4X2NsaWNrcyIpKSB8fCAzOw0KICBsZXQgVElNRV9MSU1JVF9NSU5VVEVTID0NCiAgICBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidGltZV9saW1pdF9taW51dGVzIikpIHx8IDUwMDAwOw0KICAvLyBMaW1pdGUgcGVyIHNlc3Npb25pIHRva2VuIGRvcG8gc3VibWl0IChkaSBkZWZhdWx0IHVndWFsZSBhIFRJTUVfTElNSVRfTUlOVVRFUykNCiAgY29uc3QgVE9LRU5fTElNSVRfTUlOVVRFUyA9DQogICAgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oInRva2VuX3RpbWVfbGltaXRfbWludXRlcyIpKSB8fA0KICAgIFRJTUVfTElNSVRfTUlOVVRFUzsNCiAgbGV0IENPUlJFQ1RfQ09ERSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJzZWNyZXRfY29kZSIpIHx8ICIyMjQ1IjsNCiAgbGV0IGN1cnJlbnRDb2RlVmVyc2lvbiA9DQogICAgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkpIHx8IDE7DQoNCiAgLy8gT3JhcmkgZGkgY2hlY2vDouKCrOKAmGluIChkaSBkZWZhdWx0LCBwb2kgYXJyaXZhbm8gZGEgRmlyZWJhc2UpDQogIGxldCBDSEVDS0lOX1NUQVJUX1RJTUUgPSAiMTQ6MDAiOw0KICBsZXQgQ0hFQ0tJTl9FTkRfVElNRSA9ICIyMjowMCI7DQogIGxldCBDSEVDS0lOX1RJTUVfRU5BQkxFRCA9IHRydWU7DQoNCiAgLy8gU3RhdG8gcnVudGltZQ0KICBsZXQgaXNUb2tlblNlc3Npb24gPSBmYWxzZTsgLy8gVVNBUkUgU0VNUFJFIFFVRVNUQQ0KICBsZXQgY3VycmVudFRva2VuSWQgPSBudWxsOw0KICBsZXQgY3VycmVudFRva2VuQ3VzdG9tQ29kZSA9IG51bGw7DQogIGxldCBzZXNzaW9uU3RhcnRUaW1lID0gbnVsbDsNCiAgbGV0IGN1cnJlbnREZXZpY2UgPSBudWxsOw0KICBsZXQgc3VwcHJlc3NPdmVybGF5ID0gZmFsc2U7IC8vIGV2aXRhIG92ZXJsYXkgc3UgcHJpbW8gYWNjZXNzbyBzZW56YSB0b2tlbg0KDQogIC8vIFRlbnRhdGl2aSBlcnJhdGkgZSBsb2Nrb3V0DQogIGxldCBNQVhfTE9HSU5fQVRURU1QVFMgPQ0KICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJtYXhfbG9naW5fYXR0ZW1wdHMiKSkgfHwgNTsNCiAgbGV0IExPQ0tPVVRfTUlOVVRFUyA9IHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJsb2Nrb3V0X21pbnV0ZXMiKSkgfHwgMTsNCg0KICAvLyBJbnRlcnZhbGxpL2xpc3RlbmVyDQogIGxldCB0aW1lQ2hlY2tJbnRlcnZhbCA9IG51bGw7DQogIGxldCBjb2RlQ2hlY2tJbnRlcnZhbCA9IG51bGw7DQogIGxldCBMSU5LX0NIRUNLX0lOVEVSVkFMID0gbnVsbDsNCiAgbGV0IHNldHRpbmdzUmVmID0gbnVsbDsNCiAgbGV0IHRva2VuUmVmID0gbnVsbDsNCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gRmlyZWJhc2UgaW5pdCAoY29uIGd1YXJkaWEpDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBpZiAoIWZpcmViYXNlLmFwcHMgfHwgZmlyZWJhc2UuYXBwcy5sZW5ndGggPT09IDApIHsNCiAgICBmaXJlYmFzZS5pbml0aWFsaXplQXBwKGZpcmViYXNlQ29uZmlnKTsNCiAgfQ0KICBjb25zdCBkYXRhYmFzZSA9IGZpcmViYXNlLmRhdGFiYXNlKCk7DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFVUSUxTDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBxcyhpZCkgew0KICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7DQogIH0NCg0KICBmdW5jdGlvbiBvbihpZCwgZXZ0LCBoYW5kbGVyKSB7DQogICAgY29uc3QgZWwgPSBxcyhpZCk7DQogICAgaWYgKGVsKSBlbC5hZGRFdmVudExpc3RlbmVyKGV2dCwgaGFuZGxlcik7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2UsIHR5cGUgPSAiaW5mbyIpIHsNCiAgICBjb25zdCBleGlzdGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjb2RlQ2hhbmdlTm90aWZpY2F0aW9uIik7DQogICAgaWYgKGV4aXN0aW5nKSBleGlzdGluZy5yZW1vdmUoKTsNCg0KICAgIGNvbnN0IG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICBuLmlkID0gImNvZGVDaGFuZ2VOb3RpZmljYXRpb24iOw0KICAgIG4uc3R5bGUuY3NzVGV4dCA9IGANCiAgICAgIHBvc2l0aW9uOiBmaXhlZDsgdG9wOiAyMHB4OyByaWdodDogMjBweDsgei1pbmRleDogMTAwMDA7DQogICAgICBiYWNrZ3JvdW5kOiAkew0KICAgICAgICB0eXBlID09PSAid2FybmluZyINCiAgICAgICAgICA/ICIjRkZBNTAwIg0KICAgICAgICAgIDogdHlwZSA9PT0gImVycm9yIg0KICAgICAgICAgID8gIiNGRjVBNUYiDQogICAgICAgICAgOiAiIzRDQUY1MCINCiAgICAgIH07DQogICAgICBjb2xvcjogI2ZmZjsgcGFkZGluZzogMTVweCAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJveC1zaGFkb3c6IDAgNHB4IDEycHggcmdiYSgwLDAsMCwuMTIpOw0KICAgICAgZGlzcGxheTpmbGV4OyBnYXA6MTBweDsgYWxpZ24taXRlbXM6Y2VudGVyOyBtYXgtd2lkdGg6MzYwcHg7DQogICAgYDsNCiAgICBuLmlubmVySFRNTCA9IGANCiAgICAgIDxpIGNsYXNzPSJmYXMgZmEtaW5mby1jaXJjbGUiPjwvaT4NCiAgICAgIDxzcGFuPiR7bWVzc2FnZX08L3NwYW4+DQogICAgICA8YnV0dG9uIG9uY2xpY2s9InRoaXMucGFyZW50RWxlbWVudC5yZW1vdmUoKSIgc3R5bGU9ImJhY2tncm91bmQ6bm9uZTtib3JkZXI6bm9uZTtjb2xvcjojZmZmO2N1cnNvcjpwb2ludGVyIj4NCiAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS10aW1lcyI+PC9pPg0KICAgICAgPC9idXR0b24+YDsNCiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG4pOw0KICAgIHNldFRpbWVvdXQoKCkgPT4gbi5wYXJlbnRFbGVtZW50ICYmIG4ucmVtb3ZlKCksIDUwMDApOw0KICB9DQoNCiAgZnVuY3Rpb24gZm9ybWF0VGltZSh0aW1lU3RyaW5nKSB7DQogICAgY29uc3QgW2gsIG1dID0gU3RyaW5nKHRpbWVTdHJpbmcgfHwgIiIpLnNwbGl0KCI6Iik7DQogICAgcmV0dXJuIGAke2g/LnBhZFN0YXJ0KDIsICIwIil9OiR7bT8ucGFkU3RhcnQoMiwgIjAiKX1gOw0KICB9DQoNCiAgZnVuY3Rpb24gZmV0Y2hXaXRoVGltZW91dCh1cmwsIG9wdGlvbnMgPSB7fSwgdGltZW91dE1zID0gMTIwMDApIHsNCiAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOw0KICAgIGNvbnN0IGlkID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXRNcyk7DQogICAgY29uc3QgcCA9IGZldGNoKHVybCwgeyAuLi5vcHRpb25zLCBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsIH0pLmZpbmFsbHkoDQogICAgICAoKSA9PiBjbGVhclRpbWVvdXQoaWQpDQogICAgKTsNCiAgICByZXR1cm4gcDsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBTVE9SQUdFIChsb2NhbFN0b3JhZ2UgKyBjb29raWUgY29tcGF0KQ0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZnVuY3Rpb24gc2V0U3RvcmFnZShrZXksIHZhbHVlLCBtaW51dGVzKSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgdmFsdWUpOw0KICAgICAgY29uc3QgZXhwaXJhdGlvbkRhdGUgPSBuZXcgRGF0ZSgpOw0KICAgICAgZXhwaXJhdGlvbkRhdGUuc2V0VGltZShleHBpcmF0aW9uRGF0ZS5nZXRUaW1lKCkgKyBtaW51dGVzICogNjAgKiAxMDAwKTsNCiAgICAgIGNvbnN0IGV4cGlyZXMgPSAiZXhwaXJlcz0iICsgZXhwaXJhdGlvbkRhdGUudG9VVENTdHJpbmcoKTsNCiAgICAgIGRvY3VtZW50LmNvb2tpZSA9IGAke2tleX09JHt2YWx1ZX07ICR7ZXhwaXJlc307IHBhdGg9LzsgU2FtZVNpdGU9U3RyaWN0YDsNCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIG5lbCBzYWx2YXRhZ2dpbyBkZWkgZGF0aToiLCBlcnJvcik7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gZ2V0U3RvcmFnZShrZXkpIHsNCiAgICB0cnkgew0KICAgICAgY29uc3QgbG9jYWxWYWx1ZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7DQogICAgICBpZiAobG9jYWxWYWx1ZSAhPT0gbnVsbCkgcmV0dXJuIGxvY2FsVmFsdWU7DQogICAgICBjb25zdCBjb29raWVzID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCI7Iik7DQogICAgICBmb3IgKGNvbnN0IGNvb2tpZSBvZiBjb29raWVzKSB7DQogICAgICAgIGNvbnN0IFtuYW1lLCB2YWx1ZV0gPSBjb29raWUudHJpbSgpLnNwbGl0KCI9Iik7DQogICAgICAgIGlmIChuYW1lID09PSBrZXkpIHJldHVybiB2YWx1ZTsNCiAgICAgIH0NCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIG5lbCByZWN1cGVybyBkZWkgZGF0aToiLCBlcnJvcik7DQogICAgfQ0KICAgIHJldHVybiBudWxsOw0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJTdG9yYWdlKGtleSkgew0KICAgIHRyeSB7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOw0KICAgICAgZG9jdW1lbnQuY29va2llID0gYCR7a2V5fT07IGV4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBVVEM7IHBhdGg9LztgOw0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsbGEgcmltb3ppb25lIGRlaSBkYXRpOiIsIGVycm9yKTsNCiAgICB9DQogIH0NCg0KICAvLyBSaWxldmF6aW9uZSBwcmltbyBhY2Nlc3NvIGRpc3Bvc2l0aXZvIGUgZmFsbGJhY2sgYWxsYSBVSSBtYW51YWxlDQogIGZ1bmN0aW9uIGlzRmlyc3RWaXNpdERldmljZSgpIHsNCiAgICB0cnkgew0KICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJmaXJzdF92aXNpdF9kb25lIikgIT09IG51bGwpIHJldHVybiBmYWxzZTsNCiAgICAgIGNvbnN0IGhhc1Nlc3Npb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidXNhZ2Vfc3RhcnRfdGltZSIpICE9PSBudWxsOw0KICAgICAgY29uc3QgaXNCbG9ja2VkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImJsb2NrX21hbnVhbF9sb2dpbiIpID09PSAiMSI7DQogICAgICAvLyBDb25zaWRlcmEgcHJpbW8gYWNjZXNzbyBzZSBub24gYyfDg8KoIHVuYSBzZXNzaW9uZSBkJ3VzbyBwcmVjZWRlbnRlLA0KICAgICAgLy8gbmVzc3VuIGJsb2NjbywgZSBuZXNzdW5hIHRyYWNjaWEgZGkgdG9rZW4gdmFsaWRhdG8NCiAgICAgIGxldCBoYXNUb2tlbkZvb3QgPSBmYWxzZTsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbG9jYWxTdG9yYWdlLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGNvbnN0IGsgPSBsb2NhbFN0b3JhZ2Uua2V5KGkpIHx8ICIiOw0KICAgICAgICBpZiAoay5zdGFydHNXaXRoKCJ0b2tlbl9va18iKSkgew0KICAgICAgICAgIGhhc1Rva2VuRm9vdCA9IHRydWU7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiAhaGFzU2Vzc2lvbiAmJiAhaXNCbG9ja2VkICYmICFoYXNUb2tlbkZvb3Q7DQogICAgfSBjYXRjaCB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gcmVjb3JkRmlyc3RWaXNpdEhhbmRsZWQoKSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJmaXJzdF92aXNpdF9kb25lIiwgIjEiKTsNCiAgICB9IGNhdGNoIHt9DQogIH0NCg0KICBmdW5jdGlvbiBmYWxsYmFja1RvTWFudWFsRm9yRmlyc3RWaXNpdChyZWFzb24pIHsNCiAgICBpZiAoIWlzRmlyc3RWaXNpdERldmljZSgpKSByZXR1cm4gZmFsc2U7DQogICAgdHJ5IHsNCiAgICAgIHN1cHByZXNzT3ZlcmxheSA9IHRydWU7DQogICAgICB1bmJsb2NrQWNjZXNzKCk7DQogICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICBxcygiY29udHJvbFBhbmVsIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgc2hvd0F1dGhGb3JtKCk7DQogICAgICByZWNvcmRGaXJzdFZpc2l0SGFuZGxlZCgpOw0KICAgICAgaWYgKHJlYXNvbikgc2hvd05vdGlmaWNhdGlvbihyZWFzb24sICJ3YXJuaW5nIik7DQogICAgfSBjYXRjaCB7fQ0KICAgIHJldHVybiB0cnVlOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIENSSVRUT0dSQUZJQQ0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVIYXNoKHN0cikgew0KICAgIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsNCiAgICBjb25zdCBkYXRhID0gZW5jb2Rlci5lbmNvZGUoc3RyKTsNCiAgICBjb25zdCBoYXNoQnVmZmVyID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5kaWdlc3QoIlNIQS0yNTYiLCBkYXRhKTsNCiAgICBjb25zdCBoYXNoQXJyYXkgPSBBcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGhhc2hCdWZmZXIpKTsNCiAgICByZXR1cm4gaGFzaEFycmF5Lm1hcCgoYikgPT4gYi50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKSkuam9pbigiIik7DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gSU1QT1NUQVpJT05JIChGaXJlYmFzZSkNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGFzeW5jIGZ1bmN0aW9uIGxvYWRTZXR0aW5nc0Zyb21GaXJlYmFzZSgpIHsNCiAgICB0cnkgew0KICAgICAgY29uc3Qgc25hcHNob3QgPSBhd2FpdCBkYXRhYmFzZS5yZWYoInNldHRpbmdzIikub25jZSgidmFsdWUiKTsNCiAgICAgIHJldHVybiBzbmFwc2hvdC5leGlzdHMoKSA/IHNuYXBzaG90LnZhbCgpIDogbnVsbDsNCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigNCiAgICAgICAgIkVycm9yZSBuZWwgY2FyaWNhbWVudG8gZGVsbGUgaW1wb3N0YXppb25pIGRhIEZpcmViYXNlOiIsDQogICAgICAgIGVycm9yDQogICAgICApOw0KICAgICAgcmV0dXJuIG51bGw7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gYXBwbHlGaXJlYmFzZVNldHRpbmdzKHNldHRpbmdzKSB7DQogICAgaWYgKHNldHRpbmdzPy5zZWNyZXRfY29kZSkgew0KICAgICAgQ09SUkVDVF9DT0RFID0gc2V0dGluZ3Muc2VjcmV0X2NvZGU7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgic2VjcmV0X2NvZGUiLCBzZXR0aW5ncy5zZWNyZXRfY29kZSk7DQogICAgfQ0KICAgIGlmIChzZXR0aW5ncz8ubWF4X2xvZ2luX2F0dGVtcHRzKSB7DQogICAgICBNQVhfTE9HSU5fQVRURU1QVFMgPSBwYXJzZUludChzZXR0aW5ncy5tYXhfbG9naW5fYXR0ZW1wdHMsIDEwKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKA0KICAgICAgICAibWF4X2xvZ2luX2F0dGVtcHRzIiwNCiAgICAgICAgU3RyaW5nKE1BWF9MT0dJTl9BVFRFTVBUUykNCiAgICAgICk7DQogICAgfQ0KICAgIGlmIChzZXR0aW5ncz8ubG9ja291dF9taW51dGVzKSB7DQogICAgICBMT0NLT1VUX01JTlVURVMgPSBwYXJzZUludChzZXR0aW5ncy5sb2Nrb3V0X21pbnV0ZXMsIDEwKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJsb2Nrb3V0X21pbnV0ZXMiLCBTdHJpbmcoTE9DS09VVF9NSU5VVEVTKSk7DQogICAgfQ0KICAgIGlmIChzZXR0aW5ncz8ubWF4X2NsaWNrcykgew0KICAgICAgTUFYX0NMSUNLUyA9IHBhcnNlSW50KHNldHRpbmdzLm1heF9jbGlja3MsIDEwKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJtYXhfY2xpY2tzIiwgc2V0dGluZ3MubWF4X2NsaWNrcyk7DQogICAgfQ0KICAgIGlmIChzZXR0aW5ncz8udGltZV9saW1pdF9taW51dGVzKSB7DQogICAgICBUSU1FX0xJTUlUX01JTlVURVMgPSBwYXJzZUludChzZXR0aW5ncy50aW1lX2xpbWl0X21pbnV0ZXMsIDEwKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ0aW1lX2xpbWl0X21pbnV0ZXMiLCBzZXR0aW5ncy50aW1lX2xpbWl0X21pbnV0ZXMpOw0KICAgIH0NCiAgICBpZiAodHlwZW9mIHNldHRpbmdzPy5jaGVja2luX3N0YXJ0X3RpbWUgPT09ICJzdHJpbmciKQ0KICAgICAgQ0hFQ0tJTl9TVEFSVF9USU1FID0gc2V0dGluZ3MuY2hlY2tpbl9zdGFydF90aW1lOw0KICAgIGlmICh0eXBlb2Ygc2V0dGluZ3M/LmNoZWNraW5fZW5kX3RpbWUgPT09ICJzdHJpbmciKQ0KICAgICAgQ0hFQ0tJTl9FTkRfVElNRSA9IHNldHRpbmdzLmNoZWNraW5fZW5kX3RpbWU7DQogICAgaWYgKHR5cGVvZiBzZXR0aW5ncz8uY2hlY2tpbl90aW1lX2VuYWJsZWQgIT09ICJ1bmRlZmluZWQiKQ0KICAgICAgQ0hFQ0tJTl9USU1FX0VOQUJMRUQgPSBTdHJpbmcoc2V0dGluZ3MuY2hlY2tpbl90aW1lX2VuYWJsZWQpICE9PSAiZmFsc2UiOw0KDQogICAgdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5KCk7DQogICAgREVWSUNFUy5mb3JFYWNoKHVwZGF0ZUJ1dHRvblN0YXRlKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNldHVwU2V0dGluZ3NMaXN0ZW5lcigpIHsNCiAgICBpZiAoc2V0dGluZ3NSZWYpIHJldHVybjsgLy8gZXZpdGEgZG9wcGlvIGxpc3RlbmVyDQogICAgc2V0dGluZ3NSZWYgPSBkYXRhYmFzZS5yZWYoInNldHRpbmdzIik7DQogICAgc2V0dGluZ3NSZWYub24oInZhbHVlIiwgKHNuYXApID0+IHsNCiAgICAgIGNvbnN0IHMgPSBzbmFwLnZhbCgpIHx8IHt9Ow0KICAgICAgYXBwbHlGaXJlYmFzZVNldHRpbmdzKHMpOw0KDQogICAgICAvLyBLaWxsLXN3aXRjaDogY2FtYmlvIGNvZGljZSBnbG9iYWxlID0+IGJsb2NjYSBlIGZvcnphIGxvZ291dA0KICAgICAgY29uc3Qgc2VydmVyQ29kZVZlciA9IHBhcnNlSW50KHMuY29kZV92ZXJzaW9uIHx8IDEsIDEwKTsNCiAgICAgIGNvbnN0IGxvY2FsQ29kZVZlciA9IHBhcnNlSW50KA0KICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShDT0RFX1ZFUlNJT05fS0VZKSB8fCAiMSIsDQogICAgICAgIDEwDQogICAgICApOw0KICAgICAgaWYgKHNlcnZlckNvZGVWZXIgPiBsb2NhbENvZGVWZXIpIHsNCiAgICAgICAgLy8gRGV0ZXJtaW5hIHNlIHF1ZXN0byBkaXNwb3NpdGl2byBoYSBnacODwqAgdmlzdG8gdW5hIHZlcnNpb25lIHByZWNlZGVudGUNCiAgICAgICAgY29uc3QgaGFkTG9jYWxWZXJzaW9uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkgIT09IG51bGw7DQogICAgICAgIC8vIEFnZ2lvcm5hIHZlcnNpb25lIGxvY2FsZQ0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShDT0RFX1ZFUlNJT05fS0VZLCBTdHJpbmcoc2VydmVyQ29kZVZlcikpOw0KICAgICAgICBjb25zdCBtc2cgPSBzLmdsb2JhbF9ibG9ja19tZXNzYWdlIHx8ICJDb2RpY2UgYWdnaW9ybmF0bzogaWwgbGluayBub24gZScgcGl1JyB2YWxpZG8iOw0KICAgICAgICAvLyBQcmltbyBhY2Nlc3NvOiBub24gbW9zdHJhcmUgb3ZlcmxheSwgbW9zdHJhIGRpcmV0dGFtZW50ZSBpbCBmb3JtIGNvZGljZQ0KICAgICAgICBpZiAoZmFsbGJhY2tUb01hbnVhbEZvckZpcnN0VmlzaXQobXNnKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAvLyBWZWNjaGkgZGlzcG9zaXRpdmk6IGJsb2NjbyBnbG9iYWxlIChtYWluIHBhZ2UpIGNvbiBvdmVybGF5IHBlcnNpc3RlbnRlDQogICAgICAgIGlmIChoYWRMb2NhbFZlcnNpb24pIHsNCiAgICAgICAgICBibG9ja0FjY2Vzcyhtc2cpOw0KICAgICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAvLyBUb2tlbiBhcGVydG86IGxvZ291dCBkYWwgdG9rZW4NCiAgICAgICAgaWYgKGhhc1Rva2VuRm9vdHByaW50KCkpIHsNCiAgICAgICAgICBmb3JjZUxvZ291dEZyb21Ub2tlbihtc2cpOw0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAvLyBOdW92byBkaXNwb3NpdGl2bzogbmllbnRlIGJsb2NjbywgdG9ybmEgYWwgbG9naW4NCiAgICAgICAgdW5ibG9ja0FjY2VzcygpOw0KICAgICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgcXMoImNvbnRyb2xQYW5lbCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgcmVzZXRTZXNzaW9uRm9yTmV3Q29kZSgpOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQoNCiAgICAgIC8vIFJpcHJpc3Rpbm8gZ2xvYmFsZTogc2Jsb2NjYSBlIHRvcm5hIGFsIGxvZ2luDQogICAgICBjb25zdCBzZXJ2ZXJVbmJsb2NrVmVyID0gcGFyc2VJbnQocy5zZXNzaW9uX3Jlc2V0X3ZlcnNpb24gfHwgMCwgMTApOw0KICAgICAgY29uc3QgbG9jYWxVbmJsb2NrVmVyID0gcGFyc2VJbnQoDQogICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKFVOQkxPQ0tfVkVSU0lPTl9LRVkpIHx8ICIwIiwNCiAgICAgICAgMTANCiAgICAgICk7DQogICAgICBpZiAoc2VydmVyVW5ibG9ja1ZlciA+IGxvY2FsVW5ibG9ja1Zlcikgew0KICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShVTkJMT0NLX1ZFUlNJT05fS0VZLCBTdHJpbmcoc2VydmVyVW5ibG9ja1ZlcikpOw0KICAgICAgICB1bmJsb2NrQWNjZXNzKCk7DQogICAgICAgIC8vIGNhbmNlbGxhIGV2ZW50dWFsZSBsb2Nrb3V0IGxvY2FsZSBlIGNvbnRhdG9yZSB0ZW50YXRpdmkNCiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2xvY2tfdW50aWwiKTsNCiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2F0dGVtcHRzIik7DQogICAgICAgIC8vIFNpbmNyb25penphIGxhIGNvZGVfdmVyc2lvbiBsb2NhbGUgY29uIHF1ZWxsYSBkZWwgc2VydmVyIHBlciBldml0YXJlIHVuIGJsb2NjbyBpbW1lZGlhdG8gcG9zdC1yZXNldA0KICAgICAgICB0cnkgew0KICAgICAgICAgIGNvbnN0IHNydkNvZGVWZXIgPSBwYXJzZUludChzLmNvZGVfdmVyc2lvbiB8fCAxLCAxMCk7DQogICAgICAgICAgaWYgKE51bWJlci5pc0Zpbml0ZShzcnZDb2RlVmVyKSkgew0KICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSwgU3RyaW5nKHNydkNvZGVWZXIpKTsNCiAgICAgICAgICB9DQogICAgICAgIH0gY2F0Y2gge30NCiAgICAgICAgLy8gUHVsaXNjaSBhbmNoZSB0dXR0aSBpIGJsb2NjaGkgbGVnYXRpIGFpIHRva2VuIHN1IHF1ZXN0byBkaXNwb3NpdGl2bw0KICAgICAgICB0cnkgew0KICAgICAgICAgIGNvbnN0IHRvUmVtb3ZlID0gW107DQogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsb2NhbFN0b3JhZ2UubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGNvbnN0IGsgPSBsb2NhbFN0b3JhZ2Uua2V5KGkpOw0KICAgICAgICAgICAgaWYgKCFrKSBjb250aW51ZTsNCiAgICAgICAgICAgIGlmICgNCiAgICAgICAgICAgICAgay5pbmRleE9mKCJ0b2tlbl9kZXZpY2VfYmxvY2tfIikgPT09IDAgfHwNCiAgICAgICAgICAgICAgay5pbmRleE9mKCJ0b2tlbl9kZXZpY2VfcmVhc29uXyIpID09PSAwIHx8DQogICAgICAgICAgICAgIGsuaW5kZXhPZigidG9rZW5fdHNfIikgPT09IDAgfHwNCiAgICAgICAgICAgICAgay5pbmRleE9mKCJ0b2tlbl90aF8iKSA9PT0gMA0KICAgICAgICAgICAgKSB7DQogICAgICAgICAgICAgIHRvUmVtb3ZlLnB1c2goayk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIHRvUmVtb3ZlLmZvckVhY2goKGspID0+IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGspKTsNCiAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tlZF90b2tlbiIpOw0KICAgICAgICAgIC8vIG5vbiByaW11b3ZpYW1vIHRva2VuX29rXyogcGVyIG5vbiBwZXJkZXJlIHZhbGlkYXppb25pIHZvbG9udGFyaWFtZW50ZSBjb25zZXJ2YXRlDQogICAgICAgIH0gY2F0Y2gge30NCiAgICAgICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHFzKCJjb250cm9sUGFuZWwiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHNob3dBdXRoRm9ybSgpOw0KICAgICAgICB1cGRhdGVEb29yVmlzaWJpbGl0eSgpOw0KICAgICAgICBzaG93Tm90aWZpY2F0aW9uKA0KICAgICAgICAgIHMuZ2xvYmFsX3VuYmxvY2tfbWVzc2FnZSB8fA0KICAgICAgICAgICAgIlNlc3Npb25lIHJpcHJpc3RpbmF0YS4gSW5zZXJpc2NpIGlsIGNvZGljZSBwZXIgYWNjZWRlcmUuIg0KICAgICAgICApOw0KICAgICAgICB1cGRhdGVMb2NrVUkoKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIG1vbml0b3JGaXJlYmFzZUNvbm5lY3Rpb24oKSB7DQogICAgY29uc3QgY29ubmVjdGVkUmVmID0gZGF0YWJhc2UucmVmKCIuaW5mby9jb25uZWN0ZWQiKTsNCiAgICBjb25uZWN0ZWRSZWYub24oInZhbHVlIiwgKHNuYXApID0+IHsNCiAgICAgIGlmIChzbmFwLnZhbCgpID09PSB0cnVlKSB7DQogICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgiZmlyZWJhc2Utb2ZmbGluZSIpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCJmaXJlYmFzZS1vZmZsaW5lIik7DQogICAgICAgIHNob3dOb3RpZmljYXRpb24oDQogICAgICAgICAgIkNvbm5lc3Npb25lIGEgRmlyZWJhc2UgcGVyc2EuIExlIG1vZGlmaWNoZSBwb3RyZWJiZXJvIG5vbiBlc3NlcmUgc2luY3Jvbml6emF0ZS4iLA0KICAgICAgICAgICJ3YXJuaW5nIg0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0pOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFRFTVBPL1NFU1NJT05FDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBhc3luYyBmdW5jdGlvbiBzZXRVc2FnZVN0YXJ0VGltZSgpIHsNCiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpLnRvU3RyaW5nKCk7DQogICAgY29uc3QgaGFzaCA9IGF3YWl0IGdlbmVyYXRlSGFzaChub3cgKyBTRUNSRVRfS0VZKTsNCiAgICBzZXRTdG9yYWdlKCJ1c2FnZV9zdGFydF90aW1lIiwgbm93LCBUSU1FX0xJTUlUX01JTlVURVMpOw0KICAgIHNldFN0b3JhZ2UoInVzYWdlX2hhc2giLCBoYXNoLCBUSU1FX0xJTUlUX01JTlVURVMpOw0KICAgIHVwZGF0ZVN0YXR1c0JhcigpOw0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gc2V0TG9naW5TdGFydFRpbWUoKSB7DQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKS50b1N0cmluZygpOw0KICAgIGNvbnN0IGhhc2ggPSBhd2FpdCBnZW5lcmF0ZUhhc2gobm93ICsgU0VDUkVUX0tFWSk7DQogICAgc2V0U3RvcmFnZSgibG9naW5fc3RhcnRfdGltZSIsIG5vdywgUFJFX1VTRV9MSU1JVF9NSU5VVEVTKTsNCiAgICBzZXRTdG9yYWdlKCJsb2dpbl9oYXNoIiwgaGFzaCwgUFJFX1VTRV9MSU1JVF9NSU5VVEVTKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIHNldFRva2VuVXNhZ2VTdGFydFRpbWUodG9rZW5JZCkgew0KICAgIGlmICghdG9rZW5JZCkgcmV0dXJuOw0KICAgIGNvbnN0IGtleVQgPSBgdG9rZW5fdHNfJHt0b2tlbklkfWA7DQogICAgY29uc3Qga2V5SCA9IGB0b2tlbl90aF8ke3Rva2VuSWR9YDsNCiAgICB0cnkgew0KICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVQpKSByZXR1cm47IC8vIG5vbiBzb3ZyYXNjcml2ZXJlIHNlIGdpw4PCoCBhdnZpYXRvDQogICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpLnRvU3RyaW5nKCk7DQogICAgICBjb25zdCBoYXNoID0gYXdhaXQgZ2VuZXJhdGVIYXNoKG5vdyArIFNFQ1JFVF9LRVkgKyB0b2tlbklkKTsNCiAgICAgIHNldFN0b3JhZ2Uoa2V5VCwgbm93LCBUT0tFTl9MSU1JVF9NSU5VVEVTKTsNCiAgICAgIHNldFN0b3JhZ2Uoa2V5SCwgaGFzaCwgVE9LRU5fTElNSVRfTUlOVVRFUyk7DQogICAgfSBjYXRjaCB7fQ0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJUb2tlblVzYWdlU3RhcnQodG9rZW5JZCkgew0KICAgIGlmICghdG9rZW5JZCkgcmV0dXJuOw0KICAgIHRyeSB7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShgdG9rZW5fdHNfJHt0b2tlbklkfWApOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYHRva2VuX3RoXyR7dG9rZW5JZH1gKTsNCiAgICB9IGNhdGNoIHt9DQogIH0NCg0KICBhc3luYyBmdW5jdGlvbiBjaGVja1RpbWVMaW1pdCgpIHsNCiAgICAvLyBUaW1lciBhbmNoZSBwZXIgc2Vzc2lvbmkgdG9rZW4gZG9wbyBzdWJtaXQNCiAgICBpZiAoaXNUb2tlblNlc3Npb24pIHsNCiAgICAgIGNvbnN0IHQgPQ0KICAgICAgICBjdXJyZW50VG9rZW5JZCB8fCBuZXcgVVJMU2VhcmNoUGFyYW1zKGxvY2F0aW9uLnNlYXJjaCkuZ2V0KCJ0b2tlbiIpOw0KICAgICAgaWYgKCF0KSByZXR1cm4gZmFsc2U7DQogICAgICBjb25zdCBrZXlUID0gYHRva2VuX3RzXyR7dH1gOw0KICAgICAgY29uc3Qga2V5SCA9IGB0b2tlbl90aF8ke3R9YDsNCiAgICAgIGNvbnN0IHRzID0gZ2V0U3RvcmFnZShrZXlUKTsNCiAgICAgIGNvbnN0IGhzID0gZ2V0U3RvcmFnZShrZXlIKTsNCiAgICAgIGlmICh0cyAmJiBocykgew0KICAgICAgICBjb25zdCBjYWxjID0gYXdhaXQgZ2VuZXJhdGVIYXNoKHRzICsgU0VDUkVUX0tFWSArIHQpOw0KICAgICAgICBpZiAoY2FsYyAhPT0gaHMpIHsNCiAgICAgICAgICAvLyBoYXNoIG1pc21hdGNoID0+IGNvbnNpZGVyYSBzY2FkdXRhDQogICAgICAgICAgY2xlYXJUb2tlblVzYWdlU3RhcnQodCk7DQogICAgICAgICAgdHJ5IHsgZm9yY2VMb2dvdXRGcm9tVG9rZW4oIlNlc3Npb25lIHRva2VuIG5vbiB2YWxpZGEiKTsgfSBjYXRjaCB7fQ0KICAgICAgICAgIC8vIE5hc2NvbmRpIHBhbm5lbGxvIGUgbW9zdHJhIG92ZXJsYXkNCiAgICAgICAgICBxcygiY29udHJvbFBhbmVsIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsNCiAgICAgICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7DQogICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCiAgICAgICAgY29uc3QgbWlucyA9IChEYXRlLm5vdygpIC0gcGFyc2VJbnQodHMsIDEwKSkgLyAoMTAwMCAqIDYwKTsNCiAgICAgICAgaWYgKG1pbnMgPj0gVE9LRU5fTElNSVRfTUlOVVRFUykgew0KICAgICAgICAgIGNsZWFyVG9rZW5Vc2FnZVN0YXJ0KHQpOw0KICAgICAgICAgIHRyeSB7IGZvcmNlTG9nb3V0RnJvbVRva2VuKCJTZXNzaW9uZSB0b2tlbiBzY2FkdXRhIik7IH0gY2F0Y2gge30NCiAgICAgICAgICBxcygiY29udHJvbFBhbmVsIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsNCiAgICAgICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7DQogICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQoNCiAgICBpZiAoIXNlc3Npb25TdGFydFRpbWUpIHJldHVybiBmYWxzZTsNCg0KICAgIGNvbnN0IHN0YXJ0VGltZSA9IGdldFN0b3JhZ2UoInVzYWdlX3N0YXJ0X3RpbWUiKTsNCiAgICBjb25zdCBzdG9yZWRIYXNoID0gZ2V0U3RvcmFnZSgidXNhZ2VfaGFzaCIpOw0KICAgIGlmICghc3RhcnRUaW1lIHx8ICFzdG9yZWRIYXNoKSByZXR1cm4gZmFsc2U7DQoNCiAgICBjb25zdCBjYWxjSGFzaCA9IGF3YWl0IGdlbmVyYXRlSGFzaChzdGFydFRpbWUgKyBTRUNSRVRfS0VZKTsNCiAgICBpZiAoY2FsY0hhc2ggIT09IHN0b3JlZEhhc2gpIHsNCiAgICAgIHNob3dGYXRhbEVycm9yKCLDosWhwqDDr8K4wo8gVmlvbGF6aW9uZSBkaSBzaWN1cmV6emEgcmlsZXZhdGEhIik7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOw0KICAgIGNvbnN0IG1pbnV0ZXNQYXNzZWQgPSAobm93IC0gcGFyc2VJbnQoc3RhcnRUaW1lLCAxMCkpIC8gKDEwMDAgKiA2MCk7DQogICAgaWYgKG1pbnV0ZXNQYXNzZWQgPj0gVElNRV9MSU1JVF9NSU5VVEVTKSB7DQogICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHVwZGF0ZVN0YXR1c0JhcigpOw0KICAgIHJldHVybiBmYWxzZTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNob3dGYXRhbEVycm9yKG1lc3NhZ2UpIHsNCiAgICBpZiAodGltZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGltZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGlmIChjb2RlQ2hlY2tJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbChjb2RlQ2hlY2tJbnRlcnZhbCk7DQogICAgZG9jdW1lbnQuYm9keS5pbm5lckhUTUwgPSBgDQogICAgICA8ZGl2IHN0eWxlPSJwb3NpdGlvbjpmaXhlZDtpbnNldDowO2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO2FsaWduLWl0ZW1zOmNlbnRlcjtiYWNrZ3JvdW5kOiMxMjExMTE7Y29sb3I6I2ZmNmI2Yjtmb250LXNpemU6MjRweDt0ZXh0LWFsaWduOmNlbnRlcjtwYWRkaW5nOjIwcHg7ei1pbmRleDo5OTk5OyI+DQogICAgICAgICR7bWVzc2FnZX0NCiAgICAgIDwvZGl2PmA7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93U2Vzc2lvbkV4cGlyZWQoKSB7DQogICAgaWYgKGlzVG9rZW5TZXNzaW9uKSByZXR1cm47IC8vIG92ZXJsYXkgc29sbyBwZXIgc2Vzc2lvbmkgbWFudWFsaQ0KICAgIHRyeSB7DQogICAgICBjb25zdCBoYXNUb2tlbiA9IG5ldyBVUkxTZWFyY2hQYXJhbXMobG9jYXRpb24uc2VhcmNoKS5nZXQoInRva2VuIik7DQogICAgICBpZiAoIWhhc1Rva2VuICYmIHN1cHByZXNzT3ZlcmxheSkgcmV0dXJuOyAvLyBldml0YSBvdmVybGF5IHN1IHByaW1vIGFjY2Vzc28gc2VuemEgdG9rZW4NCiAgICB9IGNhdGNoIHt9DQogICAgaWYgKHRpbWVDaGVja0ludGVydmFsKSBjbGVhckludGVydmFsKHRpbWVDaGVja0ludGVydmFsKTsNCiAgICBpZiAoY29kZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwoY29kZUNoZWNrSW50ZXJ2YWwpOw0KDQogICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOw0KICAgIHFzKCJjb250cm9sUGFuZWwiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOw0KICAgIHFzKCJ0ZXN0MiIpICYmIChxcygidGVzdDIiKS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiKTsNCg0KICAgIERFVklDRVMuZm9yRWFjaCgoZGV2aWNlKSA9PiB7DQogICAgICBjb25zdCBidG4gPSBxcyhkZXZpY2UuYnV0dG9uX2lkKTsNCiAgICAgIGlmIChidG4pIHsNCiAgICAgICAgYnRuLmRpc2FibGVkID0gdHJ1ZTsNCiAgICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoImJ0bi1lcnJvciIpOw0KICAgICAgfQ0KICAgIH0pOw0KDQogICAgY29uc3Qgc2VjdXJpdHlTdGF0dXMgPSBxcygic2VjdXJpdHlTdGF0dXMiKTsNCiAgICBpZiAoc2VjdXJpdHlTdGF0dXMpIHsNCiAgICAgIHNlY3VyaXR5U3RhdHVzLnRleHRDb250ZW50ID0gIlNjYWR1dGEiOw0KICAgICAgc2VjdXJpdHlTdGF0dXMuc3R5bGUuY29sb3IgPSAidmFyKC0tZXJyb3IpIjsNCiAgICB9DQoNCiAgICBzZXNzaW9uU3RhcnRUaW1lID0gbnVsbDsNCiAgfQ0KDQogIGZ1bmN0aW9uIGlzU2Vzc2lvblN0dWNrKCkgew0KICAgIHRyeSB7DQogICAgICBjb25zdCBhdXRoVmVyaWZpZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiYXV0aF92ZXJpZmllZCIpOw0KICAgICAgY29uc3QgYXV0aFRpbWVzdGFtcCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJhdXRoX3RpbWVzdGFtcCIpOw0KICAgICAgY29uc3QgdXNhZ2VTdGFydFRpbWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KDQogICAgICBpZiAoYXV0aFZlcmlmaWVkID09PSAidHJ1ZSIgJiYgYXV0aFRpbWVzdGFtcCkgew0KICAgICAgICBjb25zdCBhdXRoVGltZSA9IHBhcnNlSW50KGF1dGhUaW1lc3RhbXAsIDEwKTsNCiAgICAgICAgaWYgKERhdGUubm93KCkgLSBhdXRoVGltZSA+IDI0ICogNjAgKiA2MCAqIDEwMDApIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgaWYgKHVzYWdlU3RhcnRUaW1lKSB7DQogICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBhcnNlSW50KHVzYWdlU3RhcnRUaW1lLCAxMCk7DQogICAgICAgIGNvbnN0IG1pbnV0ZXNQYXNzZWQgPSAoRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSkgLyAoMTAwMCAqIDYwKTsNCiAgICAgICAgaWYgKG1pbnV0ZXNQYXNzZWQgPiBUSU1FX0xJTUlUX01JTlVURVMgKyA2MCkgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIG5lbCBjb250cm9sbG8gc2Vzc2lvbmUgYmxvY2NhdGE6IiwgZSk7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIENIRUNLw6LigqzigJhJTiBUSU1FDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBpc0NoZWNraW5UaW1lKCkgew0KICAgIGlmICghQ0hFQ0tJTl9USU1FX0VOQUJMRUQpIHJldHVybiB0cnVlOw0KDQogICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTsNCiAgICBjb25zdCBjdXJyZW50ID0gbm93LmdldEhvdXJzKCkgKiA2MCArIG5vdy5nZXRNaW51dGVzKCk7DQogICAgY29uc3QgW3NoLCBzbV0gPSBDSEVDS0lOX1NUQVJUX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBbZWgsIGVtXSA9IENIRUNLSU5fRU5EX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBzdGFydCA9IHNoICogNjAgKyBzbTsNCiAgICBjb25zdCBlbmQgPSBlaCAqIDYwICsgZW07DQogICAgcmV0dXJuIGN1cnJlbnQgPj0gc3RhcnQgJiYgY3VycmVudCA8PSBlbmQ7DQogIH0NCg0KICBmdW5jdGlvbiB1cGRhdGVDaGVja2luVGltZURpc3BsYXkoKSB7DQogICAgY29uc3Qgc3RhcnRFbCA9IHFzKCJjaGVja2luU3RhcnREaXNwbGF5Iik7DQogICAgY29uc3QgZW5kRWwgPSBxcygiY2hlY2tpbkVuZERpc3BsYXkiKTsNCiAgICBjb25zdCBzdGFydFBvcHVwID0gcXMoImNoZWNraW5TdGFydFBvcHVwIik7DQogICAgY29uc3QgZW5kUG9wdXAgPSBxcygiY2hlY2tpbkVuZFBvcHVwIik7DQogICAgY29uc3QgY3VycmVudFN0YXJ0ID0gcXMoImN1cnJlbnRDaGVja2luU3RhcnRUaW1lIik7DQogICAgY29uc3QgY3VycmVudEVuZCA9IHFzKCJjdXJyZW50Q2hlY2tpbkVuZFRpbWUiKTsNCiAgICBpZiAoc3RhcnRFbCkgc3RhcnRFbC50ZXh0Q29udGVudCA9IGZvcm1hdFRpbWUoQ0hFQ0tJTl9TVEFSVF9USU1FKTsNCiAgICBpZiAoZW5kRWwpIGVuZEVsLnRleHRDb250ZW50ID0gZm9ybWF0VGltZShDSEVDS0lOX0VORF9USU1FKTsNCiAgICBpZiAoc3RhcnRQb3B1cCkgc3RhcnRQb3B1cC50ZXh0Q29udGVudCA9IGZvcm1hdFRpbWUoQ0hFQ0tJTl9TVEFSVF9USU1FKTsNCiAgICBpZiAoZW5kUG9wdXApIGVuZFBvcHVwLnRleHRDb250ZW50ID0gZm9ybWF0VGltZShDSEVDS0lOX0VORF9USU1FKTsNCiAgICBpZiAoY3VycmVudFN0YXJ0KSBjdXJyZW50U3RhcnQudGV4dENvbnRlbnQgPSBmb3JtYXRUaW1lKENIRUNLSU5fU1RBUlRfVElNRSk7DQogICAgaWYgKGN1cnJlbnRFbmQpIGN1cnJlbnRFbmQudGV4dENvbnRlbnQgPSBmb3JtYXRUaW1lKENIRUNLSU5fRU5EX1RJTUUpOw0KDQogICAgY29uc3Qgc3RhdHVzRWxlbWVudCA9IHFzKCJjdXJyZW50VGltZVN0YXR1cyIpOw0KICAgIGlmICghc3RhdHVzRWxlbWVudCkgcmV0dXJuOw0KDQogICAgaWYgKCFDSEVDS0lOX1RJTUVfRU5BQkxFRCkgew0KICAgICAgc3RhdHVzRWxlbWVudC5pbm5lckhUTUwgPQ0KICAgICAgICAnPGkgY2xhc3M9ImZhcyBmYS1wb3dlci1vZmYiIHN0eWxlPSJjb2xvcjpvcmFuZ2U7Ij48L2k+IFRpbWUgY29udHJvbCBkaXNhYmxlZCDDouKCrOKAnSBjaGVjay1pbiBhbGxvd2VkIGF0IGFueSB0aW1lJzsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBpZiAoaXNDaGVja2luVGltZSgpKSB7DQogICAgICBzdGF0dXNFbGVtZW50LmlubmVySFRNTCA9DQogICAgICAgICc8aSBjbGFzcz0iZmFzIGZhLWNoZWNrLWNpcmNsZSIgc3R5bGU9ImNvbG9yOmdyZWVuOyI+PC9pPiBDaGVjay1pbiBub3cgYXZhaWxhYmxlJzsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpOw0KICAgIGNvbnN0IGN1cnJlbnQgPSBub3cuZ2V0SG91cnMoKSAqIDYwICsgbm93LmdldE1pbnV0ZXMoKTsNCiAgICBjb25zdCBbc2gsIHNtXSA9IENIRUNLSU5fU1RBUlRfVElNRS5zcGxpdCgiOiIpLm1hcChOdW1iZXIpOw0KICAgIGNvbnN0IFtlaCwgZW1dID0gQ0hFQ0tJTl9FTkRfVElNRS5zcGxpdCgiOiIpLm1hcChOdW1iZXIpOw0KICAgIGNvbnN0IHN0YXJ0ID0gc2ggKiA2MCArIHNtOw0KICAgIGNvbnN0IGVuZCA9IGVoICogNjAgKyBlbTsNCg0KICAgIGlmIChjdXJyZW50IDwgc3RhcnQpIHsNCiAgICAgIGNvbnN0IGRpZmYgPSBzdGFydCAtIGN1cnJlbnQ7DQogICAgICBjb25zdCBoID0gTWF0aC5mbG9vcihkaWZmIC8gNjApOw0KICAgICAgY29uc3QgbSA9IGRpZmYgJSA2MDsNCiAgICAgIHN0YXR1c0VsZW1lbnQuaW5uZXJIVE1MID0gYDxpIGNsYXNzPSJmYXMgZmEtY2xvY2siIHN0eWxlPSJjb2xvcjpvcmFuZ2U7Ij48L2k+IENoZWNrLWluIHdpbGwgYmUgYXZhaWxhYmxlIGluICR7aH1oICR7bX1tYDsNCiAgICB9IGVsc2Ugew0KICAgICAgY29uc3QgdG9tb3Jyb3cgPSBuZXcgRGF0ZShub3cpOw0KICAgICAgdG9tb3Jyb3cuc2V0RGF0ZSh0b21vcnJvdy5nZXREYXRlKCkgKyAxKTsNCiAgICAgIHRvbW9ycm93LnNldEhvdXJzKHNoLCBzbSwgMCwgMCk7DQogICAgICBjb25zdCBkaWZmID0gdG9tb3Jyb3cgLSBub3c7DQogICAgICBjb25zdCBoID0gTWF0aC5mbG9vcihkaWZmIC8gKDEwMDAgKiA2MCAqIDYwKSk7DQogICAgICBjb25zdCBtID0gTWF0aC5mbG9vcigoZGlmZiAlICgxMDAwICogNjAgKiA2MCkpIC8gKDEwMDAgKiA2MCkpOw0KICAgICAgc3RhdHVzRWxlbWVudC5pbm5lckhUTUwgPSBgPGkgY2xhc3M9ImZhcyBmYS1jbG9jayIgc3R5bGU9ImNvbG9yOm9yYW5nZTsiPjwvaT4gQ2hlY2staW4gd2lsbCBiZSBhdmFpbGFibGUgdG9tb3Jyb3cgaW4gJHtofWggJHttfW1gOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHNob3dFYXJseUNoZWNraW5Qb3B1cCgpIHsNCiAgICBjb25zdCBlbCA9IHFzKCJlYXJseUNoZWNraW5Qb3B1cCIpOw0KICAgIGlmIChlbCkgZWwuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsNCiAgfQ0KICBmdW5jdGlvbiBjbG9zZUVhcmx5Q2hlY2tpblBvcHVwKCkgew0KICAgIGNvbnN0IGVsID0gcXMoImVhcmx5Q2hlY2tpblBvcHVwIik7DQogICAgaWYgKGVsKSBlbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIElOVEVSRkFDQ0lBL1NUQVRPDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiB1cGRhdGVTdGF0dXNCYXIoKSB7DQogICAgY29uc3QgbWFpbkRvb3JDb3VudGVyID0gcXMoIm1haW5Eb29yQ291bnRlciIpOw0KICAgIGNvbnN0IGFwdERvb3JDb3VudGVyID0gcXMoImFwdERvb3JDb3VudGVyIik7DQogICAgY29uc3QgdGltZVJlbWFpbmluZyA9IHFzKCJ0aW1lUmVtYWluaW5nIik7DQoNCiAgICBpZiAobWFpbkRvb3JDb3VudGVyKSB7DQogICAgICBtYWluRG9vckNvdW50ZXIudGV4dENvbnRlbnQgPSBgJHtnZXRDbGlja3NMZWZ0KA0KICAgICAgICBERVZJQ0VTWzBdLnN0b3JhZ2Vfa2V5DQogICAgICApfSBjbGljayBsZWZ0YDsNCiAgICB9DQogICAgaWYgKGFwdERvb3JDb3VudGVyKSB7DQogICAgICBhcHREb29yQ291bnRlci50ZXh0Q29udGVudCA9IGAke2dldENsaWNrc0xlZnQoDQogICAgICAgIERFVklDRVNbMV0uc3RvcmFnZV9rZXkNCiAgICAgICl9IGNsaWNrIGxlZnRgOw0KICAgIH0NCg0KICAgIGlmICghc2Vzc2lvblN0YXJ0VGltZSB8fCAhdGltZVJlbWFpbmluZykgew0KICAgICAgaWYgKHRpbWVSZW1haW5pbmcpIHsNCiAgICAgICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IoVElNRV9MSU1JVF9NSU5VVEVTKTsNCiAgICAgICAgY29uc3Qgc2Vjb25kcyA9IE1hdGguZmxvb3IoKFRJTUVfTElNSVRfTUlOVVRFUyAlIDEpICogNjApOw0KICAgICAgICB0aW1lUmVtYWluaW5nLnRleHRDb250ZW50ID0gYCR7U3RyaW5nKG1pbnV0ZXMpLnBhZFN0YXJ0KA0KICAgICAgICAgIDIsDQogICAgICAgICAgIjAiDQogICAgICAgICl9OiR7U3RyaW5nKHNlY29uZHMpLnBhZFN0YXJ0KDIsICIwIil9YDsNCiAgICAgICAgdGltZVJlbWFpbmluZy5zdHlsZS5jb2xvciA9ICJ2YXIoLS1wcmltYXJ5KSI7DQogICAgICB9DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgY29uc3Qgc3RhcnRUaW1lID0gZ2V0U3RvcmFnZSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KICAgIGlmICghc3RhcnRUaW1lKSByZXR1cm47DQoNCiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOw0KICAgIGNvbnN0IG1pbnV0ZXNQYXNzZWQgPSAobm93IC0gcGFyc2VJbnQoc3RhcnRUaW1lLCAxMCkpIC8gKDEwMDAgKiA2MCk7DQogICAgY29uc3QgbWludXRlc0xlZnQgPSBNYXRoLm1heCgNCiAgICAgIDAsDQogICAgICBNYXRoLmZsb29yKFRJTUVfTElNSVRfTUlOVVRFUyAtIG1pbnV0ZXNQYXNzZWQpDQogICAgKTsNCiAgICBjb25zdCBzZWNvbmRzTGVmdCA9IE1hdGgubWF4KDAsIE1hdGguZmxvb3IoNjAgLSAobWludXRlc1Bhc3NlZCAlIDEpICogNjApKTsNCg0KICAgIHRpbWVSZW1haW5pbmcudGV4dENvbnRlbnQgPSBgJHtTdHJpbmcobWludXRlc0xlZnQpLnBhZFN0YXJ0KA0KICAgICAgMiwNCiAgICAgICIwIg0KICAgICl9OiR7U3RyaW5nKHNlY29uZHNMZWZ0KS5wYWRTdGFydCgyLCAiMCIpfWA7DQogICAgaWYgKG1pbnV0ZXNMZWZ0IDwgMSkgdGltZVJlbWFpbmluZy5zdHlsZS5jb2xvciA9ICJ2YXIoLS1lcnJvcikiOw0KICAgIGVsc2UgaWYgKG1pbnV0ZXNMZWZ0IDwgNSkgdGltZVJlbWFpbmluZy5zdHlsZS5jb2xvciA9ICJ2YXIoLS13YXJuaW5nKSI7DQogICAgZWxzZSB0aW1lUmVtYWluaW5nLnN0eWxlLmNvbG9yID0gInZhcigtLXByaW1hcnkpIjsNCiAgfQ0KDQogIGZ1bmN0aW9uIGdldENsaWNrc0xlZnQoa2V5KSB7DQogICAgY29uc3Qgc3RvcmVkID0gZ2V0U3RvcmFnZShrZXkpOw0KICAgIHJldHVybiBzdG9yZWQgPT09IG51bGwgPyBNQVhfQ0xJQ0tTIDogcGFyc2VJbnQoc3RvcmVkLCAxMCk7DQogIH0NCg0KICBmdW5jdGlvbiBzZXRDbGlja3NMZWZ0KGtleSwgY291bnQpIHsNCiAgICBzZXRTdG9yYWdlKGtleSwgU3RyaW5nKGNvdW50KSwgVElNRV9MSU1JVF9NSU5VVEVTKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHVwZGF0ZUJ1dHRvblN0YXRlKGRldmljZSkgew0KICAgIGNvbnN0IGJ0biA9IHFzKGRldmljZS5idXR0b25faWQpOw0KICAgIGlmICghYnRuKSByZXR1cm47DQogICAgY29uc3QgY2xpY2tzTGVmdCA9IGdldENsaWNrc0xlZnQoZGV2aWNlLnN0b3JhZ2Vfa2V5KTsNCiAgICBidG4uZGlzYWJsZWQgPSBjbGlja3NMZWZ0IDw9IDAgfHwgIWlzQ2hlY2tpblRpbWUoKTsNCiAgICBpZiAoY2xpY2tzTGVmdCA8PSAwKSB7DQogICAgICBidG4uY2xhc3NMaXN0LmFkZCgiYnRuLWVycm9yIik7DQogICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgiYnRuLXN1Y2Nlc3MiKTsNCiAgICB9IGVsc2UgaWYgKCFpc0NoZWNraW5UaW1lKCkpIHsNCiAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCJidG4tZXJyb3IiLCAiYnRuLXN1Y2Nlc3MiKTsNCiAgICB9IGVsc2Ugew0KICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoImJ0bi1zdWNjZXNzIik7DQogICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgiYnRuLWVycm9yIik7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gdXBkYXRlRG9vclZpc2liaWxpdHkoKSB7DQogICAgREVWSUNFUy5mb3JFYWNoKChkZXZpY2UpID0+IHsNCiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHFzKGAke2RldmljZS5idXR0b25faWR9Q29udGFpbmVyYCk7DQogICAgICBpZiAoY29udGFpbmVyKQ0KICAgICAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9IGRldmljZS52aXNpYmxlID8gImJsb2NrIiA6ICJub25lIjsNCiAgICB9KTsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBDQU1CSUFNRU5UTyBDT0RJQ0UNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGZ1bmN0aW9uIHNldHVwQ29kZUNoYW5nZUxpc3RlbmVyKCkgew0KICAgIGlmIChjb2RlQ2hlY2tJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbChjb2RlQ2hlY2tJbnRlcnZhbCk7DQogICAgaWYgKExJTktfQ0hFQ0tfSU5URVJWQUwpIGNsZWFySW50ZXJ2YWwoTElOS19DSEVDS19JTlRFUlZBTCk7DQoNCiAgICBjb2RlQ2hlY2tJbnRlcnZhbCA9IHNldEludGVydmFsKGNoZWNrQ29kZVZlcnNpb24sIDIwMDApOw0KICAgIExJTktfQ0hFQ0tfSU5URVJWQUwgPSBzZXRJbnRlcnZhbChjaGVja0V4cGlyZWRMaW5rcywgNjAwMDApOw0KDQogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInN0b3JhZ2UiLCAoZSkgPT4gew0KICAgICAgaWYgKGUua2V5ID09PSAiY29kZV92ZXJzaW9uIiB8fCBlLmtleSA9PT0gImxhc3RfY29kZV91cGRhdGUiKSB7DQogICAgICAgIGNoZWNrQ29kZVZlcnNpb24oKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNoZWNrQ29kZVZlcnNpb24oKSB7DQogICAgZGF0YWJhc2UNCiAgICAgIC5yZWYoInNldHRpbmdzL2NvZGVfdmVyc2lvbiIpDQogICAgICAub25jZSgidmFsdWUiKQ0KICAgICAgLnRoZW4oKHNuYXApID0+IHsNCiAgICAgICAgaWYgKHNuYXAuZXhpc3RzKCkpIHsNCiAgICAgICAgICBjb25zdCBmaXJlYmFzZVZlcnNpb24gPSBwYXJzZUludChzbmFwLnZhbCgpKTsNCiAgICAgICAgICBjb25zdCBsb2NhbFZlcnNpb24gPQ0KICAgICAgICAgICAgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oImNvZGVfdmVyc2lvbiIpKSB8fCAxOw0KICAgICAgICAgIGNvbnN0IHNhdmVkVmVyc2lvbiA9IE1hdGgubWF4KGZpcmViYXNlVmVyc2lvbiwgbG9jYWxWZXJzaW9uKTsNCiAgICAgICAgICBpZiAoc2F2ZWRWZXJzaW9uID4gY3VycmVudENvZGVWZXJzaW9uKSBoYW5kbGVDb2RlQ2hhbmdlKHNhdmVkVmVyc2lvbik7DQogICAgICAgIH0NCiAgICAgIH0pDQogICAgICAuY2F0Y2goKCkgPT4gew0KICAgICAgICBjb25zdCBzYXZlZFZlcnNpb24gPQ0KICAgICAgICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjb2RlX3ZlcnNpb24iKSkgfHwgMTsNCiAgICAgICAgaWYgKHNhdmVkVmVyc2lvbiA+IGN1cnJlbnRDb2RlVmVyc2lvbikgaGFuZGxlQ29kZUNoYW5nZShzYXZlZFZlcnNpb24pOw0KICAgICAgfSk7DQogIH0NCg0KICBmdW5jdGlvbiBoYW5kbGVDb2RlQ2hhbmdlKG5ld1ZlcnNpb24pIHsNCiAgICBjdXJyZW50Q29kZVZlcnNpb24gPSBuZXdWZXJzaW9uOw0KICAgIGRhdGFiYXNlDQogICAgICAucmVmKCJzZXR0aW5ncy9zZWNyZXRfY29kZSIpDQogICAgICAub25jZSgidmFsdWUiKQ0KICAgICAgLnRoZW4oKGNvZGVTbmFwKSA9PiB7DQogICAgICAgIGlmIChjb2RlU25hcC5leGlzdHMoKSkgew0KICAgICAgICAgIENPUlJFQ1RfQ09ERSA9IGNvZGVTbmFwLnZhbCgpOw0KICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJzZWNyZXRfY29kZSIsIENPUlJFQ1RfQ09ERSk7DQogICAgICAgICAgY29uc3QgaGFkTG9jYWxWZXJzaW9uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkgIT09IG51bGw7DQogICAgICAgICAgY29uc3QgbXNnID0gIkNvZGljZSBhZ2dpb3JuYXRvOiBpbCBsaW5rIG5vbiBlJyBwaXUnIHZhbGlkbyI7DQogICAgICAgICAgLy8gUHJpbW8gYWNjZXNzbzogbm9uIG1vc3RyYXJlIG92ZXJsYXksIHBhc3NhIGFsIGZvcm0gZGkgbG9naW4NCiAgICAgICAgICBpZiAoZmFsbGJhY2tUb01hbnVhbEZvckZpcnN0VmlzaXQobXNnKSkgcmV0dXJuOw0KICAgICAgICAgIGlmIChoYWRMb2NhbFZlcnNpb24pIHsNCiAgICAgICAgICAgIGJsb2NrQWNjZXNzKG1zZyk7DQogICAgICAgICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKGhhc1Rva2VuRm9vdHByaW50KCkpIHsNCiAgICAgICAgICAgIGZvcmNlTG9nb3V0RnJvbVRva2VuKG1zZyk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHVuYmxvY2tBY2Nlc3MoKTsNCiAgICAgICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgICAgIHFzKCJjb250cm9sUGFuZWwiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgICAgICByZXNldFNlc3Npb25Gb3JOZXdDb2RlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHJlc2V0U2Vzc2lvbkZvck5ld0NvZGUoKSB7DQogICAgY2xlYXJTdG9yYWdlKCJ1c2FnZV9zdGFydF90aW1lIik7DQogICAgY2xlYXJTdG9yYWdlKCJ1c2FnZV9oYXNoIik7DQogICAgREVWSUNFUy5mb3JFYWNoKChkKSA9PiBjbGVhclN0b3JhZ2UoZC5zdG9yYWdlX2tleSkpOw0KDQogICAgcXMoImNvbnRyb2xQYW5lbCIpICYmIChxcygiY29udHJvbFBhbmVsIikuc3R5bGUuZGlzcGxheSA9ICJub25lIik7DQogICAgcXMoImF1dGhDb2RlIikgJiYgKHFzKCJhdXRoQ29kZSIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siKTsNCiAgICBxcygiYXV0aC1mb3JtIikgJiYgKHFzKCJhdXRoLWZvcm0iKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIik7DQogICAgcXMoImJ0bkNoZWNrQ29kZSIpICYmIChxcygiYnRuQ2hlY2tDb2RlIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayIpOw0KICAgIHFzKCJpbXBvcnRhbnQiKSAmJiAocXMoImltcG9ydGFudCIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siKTsNCg0KICAgIHNob3dOb3RpZmljYXRpb24oDQogICAgICAiSWwgY29kaWNlIGRpIGFjY2Vzc28gw4PCqCBzdGF0byBhZ2dpb3JuYXRvLiBJbnNlcmlzY2kgaWwgbnVvdm8gY29kaWNlLiINCiAgICApOw0KICB9DQoNCiAgZnVuY3Rpb24gY2hlY2tFeHBpcmVkTGlua3MoKSB7DQogICAgY29uc3Qgc2VjdXJlTGlua3MgPSBKU09OLnBhcnNlKA0KICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oInNlY3VyZV9saW5rcyIpIHx8ICJ7fSINCiAgICApOw0KICAgIGxldCB1cGRhdGVkID0gZmFsc2U7DQogICAgT2JqZWN0LmtleXMoc2VjdXJlTGlua3MpLmZvckVhY2goKGxpbmtJZCkgPT4gew0KICAgICAgY29uc3QgbGluayA9IHNlY3VyZUxpbmtzW2xpbmtJZF07DQogICAgICBpZiAobGluay5leHBpcmF0aW9uIDwgRGF0ZS5ub3coKSAmJiBsaW5rLnN0YXR1cyA9PT0gImFjdGl2ZSIpIHsNCiAgICAgICAgc2VjdXJlTGlua3NbbGlua0lkXS5zdGF0dXMgPSAiZXhwaXJlZCI7DQogICAgICAgIHVwZGF0ZWQgPSB0cnVlOw0KICAgICAgfQ0KICAgIH0pOw0KICAgIGlmICh1cGRhdGVkKQ0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInNlY3VyZV9saW5rcyIsIEpTT04uc3RyaW5naWZ5KHNlY3VyZUxpbmtzKSk7DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gUE9QVVANCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGZ1bmN0aW9uIHNob3dDb25maXJtYXRpb25Qb3B1cChkZXZpY2UpIHsNCiAgICBpZiAoIWlzQ2hlY2tpblRpbWUoKSkgew0KICAgICAgc2hvd0Vhcmx5Q2hlY2tpblBvcHVwKCk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGN1cnJlbnREZXZpY2UgPSBkZXZpY2U7DQogICAgY29uc3QgZG9vck5hbWUgPSBkZXZpY2UuYnV0dG9uX2lkDQogICAgICAucmVwbGFjZSgvKFtBLVpdKS9nLCAiICQxIikNCiAgICAgIC5yZXBsYWNlKC9eLi8sIChzKSA9PiBzLnRvVXBwZXJDYXNlKCkpOw0KICAgIGNvbnN0IG1zZyA9IHFzKCJjb25maXJtYXRpb25NZXNzYWdlIik7DQogICAgaWYgKG1zZykNCiAgICAgIG1zZy50ZXh0Q29udGVudCA9IGBBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gdW5sb2NrIHRoZSAke2Rvb3JOYW1lfT9gOw0KICAgIGNvbnN0IHBvcCA9IHFzKCJjb25maXJtYXRpb25Qb3B1cCIpOw0KICAgIGlmIChwb3ApIHBvcC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOw0KICB9DQogIGZ1bmN0aW9uIGNsb3NlQ29uZmlybWF0aW9uUG9wdXAoKSB7DQogICAgY29uc3QgcG9wID0gcXMoImNvbmZpcm1hdGlvblBvcHVwIik7DQogICAgaWYgKHBvcCkgcG9wLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgY3VycmVudERldmljZSA9IG51bGw7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93RGV2aWNlUG9wdXAoZGV2aWNlLCBjbGlja3NMZWZ0KSB7DQogICAgY29uc3QgcG9wdXAgPSBxcyhgcG9wdXAtJHtkZXZpY2UuYnV0dG9uX2lkfWApOw0KICAgIGlmICghcG9wdXApIHJldHVybjsNCiAgICBjb25zdCB0ZXh0ID0gcXMoYHBvcHVwLXRleHQtJHtkZXZpY2UuYnV0dG9uX2lkfWApOw0KICAgIGlmICh0ZXh0KSB7DQogICAgICBpZiAoY2xpY2tzTGVmdCA+IDApIHsNCiAgICAgICAgdGV4dC5pbm5lckhUTUwgPSBgDQogICAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS1jaGVjay1jaXJjbGUiIHN0eWxlPSJjb2xvcjojNENBRjUwO2ZvbnQtc2l6ZToyLjVyZW07bWFyZ2luLWJvdHRvbToxNXB4OyI+PC9pPg0KICAgICAgICAgIDxkaXY+PHN0cm9uZz4ke2NsaWNrc0xlZnR9PC9zdHJvbmc+IENsaWNrIExlZnQ8L2Rpdj4NCiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOjEwcHg7Zm9udC1zaXplOjFyZW07Ij5Eb29yIFVubG9ja2VkITwvZGl2PmA7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0ZXh0LmlubmVySFRNTCA9IGANCiAgICAgICAgICA8aSBjbGFzcz0iZmFzIGZhLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlIiBzdHlsZT0iY29sb3I6I0ZGQzEwNztmb250LXNpemU6Mi41cmVtO21hcmdpbi1ib3R0b206MTVweDsiPjwvaT4NCiAgICAgICAgICA8ZGl2PjxzdHJvbmc+Tm8gbW9yZSBjbGlja3MgbGVmdCE8L3N0cm9uZz48L2Rpdj4NCiAgICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOjEwcHg7Zm9udC1zaXplOjFyZW07Ij5Db250YWN0IGZvciBBc3Npc3RhbmNlLjwvZGl2PmA7DQogICAgICB9DQogICAgfQ0KICAgIHBvcHVwLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7DQogICAgaWYgKGNsaWNrc0xlZnQgPiAwKSBzZXRUaW1lb3V0KCgpID0+IGNsb3NlUG9wdXAoZGV2aWNlLmJ1dHRvbl9pZCksIDMwMDApOw0KICB9DQoNCiAgZnVuY3Rpb24gY2xvc2VQb3B1cChidXR0b25JZCkgew0KICAgIGNvbnN0IHBvcHVwID0gcXMoYHBvcHVwLSR7YnV0dG9uSWR9YCk7DQogICAgaWYgKHBvcHVwKSBwb3B1cC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFNIRUxMWQ0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgYXN5bmMgZnVuY3Rpb24gYWN0aXZhdGVEZXZpY2UoZGV2aWNlKSB7DQogICAgaWYgKCFzZXNzaW9uU3RhcnRUaW1lKSB7DQogICAgICAvLyBMJ3V0ZW50ZSBoYSBjbGljY2F0byBzZW56YSBsb2dpbjsgaW5pemlhbGl6emEgdW5hIHNlc3Npb25lIG1hbnVhbGUNCiAgICAgIHNlc3Npb25TdGFydFRpbWUgPSBEYXRlLm5vdygpOw0KICAgICAgYXdhaXQgc2V0VXNhZ2VTdGFydFRpbWUoKTsNCiAgICB9DQoNCiAgICBpZiAoYXdhaXQgY2hlY2tUaW1lTGltaXQoKSkgcmV0dXJuOw0KICAgIGlmICghaXNDaGVja2luVGltZSgpKSB7DQogICAgICBzaG93RWFybHlDaGVja2luUG9wdXAoKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBsZXQgY2xpY2tzTGVmdCA9IGdldENsaWNrc0xlZnQoZGV2aWNlLnN0b3JhZ2Vfa2V5KTsNCiAgICBpZiAoY2xpY2tzTGVmdCA8PSAwKSB7DQogICAgICBzaG93RGV2aWNlUG9wdXAoZGV2aWNlLCBjbGlja3NMZWZ0KTsNCiAgICAgIHVwZGF0ZUJ1dHRvblN0YXRlKGRldmljZSk7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgc2V0Q2xpY2tzTGVmdChkZXZpY2Uuc3RvcmFnZV9rZXksIC0tY2xpY2tzTGVmdCk7DQogICAgdXBkYXRlQnV0dG9uU3RhdGUoZGV2aWNlKTsNCg0KICAgIHRyeSB7DQogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoV2l0aFRpbWVvdXQoDQogICAgICAgIEJBU0VfVVJMX1NFVCwNCiAgICAgICAgew0KICAgICAgICAgIG1ldGhvZDogIlBPU1QiLA0KICAgICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LA0KICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsNCiAgICAgICAgICAgIGlkOiBkZXZpY2UuaWQsDQogICAgICAgICAgICBhdXRoX2tleTogZGV2aWNlLmF1dGhfa2V5LA0KICAgICAgICAgICAgY2hhbm5lbDogMCwNCiAgICAgICAgICAgIG9uOiB0cnVlLA0KICAgICAgICAgICAgdHVybjogIm9uIiwNCiAgICAgICAgICB9KSwNCiAgICAgICAgfSwNCiAgICAgICAgMTIwMDANCiAgICAgICk7DQoNCiAgICAgIGlmIChyZXNwb25zZS5vaykgew0KICAgICAgICBzaG93RGV2aWNlUG9wdXAoZGV2aWNlLCBjbGlja3NMZWZ0KTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHNldENsaWNrc0xlZnQoZGV2aWNlLnN0b3JhZ2Vfa2V5LCBjbGlja3NMZWZ0ICsgMSk7DQogICAgICAgIHVwZGF0ZUJ1dHRvblN0YXRlKGRldmljZSk7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoDQogICAgICAgICAgIkVycm9yZSBuZWxsJ2F0dGl2YXppb25lIGRlbCBkaXNwb3NpdGl2bzoiLA0KICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cywNCiAgICAgICAgICByZXNwb25zZS5zdGF0dXNUZXh0DQogICAgICAgICk7DQogICAgICB9DQogICAgfSBjYXRjaCAoZXJyb3IpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoIkF0dGl2YXppb25lIGRpc3Bvc2l0aXZvIGZhbGxpdGE6IiwgZXJyb3IpOw0KICAgICAgc2V0Q2xpY2tzTGVmdChkZXZpY2Uuc3RvcmFnZV9rZXksIGNsaWNrc0xlZnQgKyAxKTsNCiAgICAgIHVwZGF0ZUJ1dHRvblN0YXRlKGRldmljZSk7DQogICAgfQ0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gdXBkYXRlR2xvYmFsQ29kZVZlcnNpb24oKSB7DQogICAgY29uc3Qgc2F2ZWRWZXJzaW9uID0gcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkpIHx8IDE7DQogICAgaWYgKHNhdmVkVmVyc2lvbiA8IGN1cnJlbnRDb2RlVmVyc2lvbikgew0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSwgU3RyaW5nKGN1cnJlbnRDb2RlVmVyc2lvbikpOw0KICAgICAgcmVzZXRTZXNzaW9uRm9yTmV3Q29kZSgpOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIHJldHVybiBmYWxzZTsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBUT0tFTiBTSUNVUkkgKEZpcmViYXNlIHNlY3VyZV9saW5rcy8qKQ0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZnVuY3Rpb24gbWF5YmVDbGVhblVybCgpIHsNCiAgICBpZiAoIUtFRVBfVE9LRU5fSU5fVVJMKSBjbGVhblVybCgpOw0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlU2VjdXJlVG9rZW4oKSB7DQogICAgY29uc3QgdXJsUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKTsNCiAgICBjb25zdCB0b2tlbiA9IHVybFBhcmFtcy5nZXQoInRva2VuIik7DQogICAgaWYgKCF0b2tlbikgew0KICAgICAgaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgICAgY3VycmVudFRva2VuQ3VzdG9tQ29kZSA9IG51bGw7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KDQogICAgdHJ5IHsNCiAgICAgIGNvbnN0IHNuYXBzaG90ID0gYXdhaXQgZGF0YWJhc2UNCiAgICAgICAgLnJlZigic2VjdXJlX2xpbmtzLyIgKyB0b2tlbikNCiAgICAgICAgLm9uY2UoInZhbHVlIik7DQogICAgICBpZiAoIXNuYXBzaG90LmV4aXN0cygpKSB7DQogICAgICAgIHNob3dUb2tlbkVycm9yKCJJbnZhbGlkIHRva2VuIik7DQogICAgICAgIHRyeSB7IGJsb2NrVG9rZW5Pbmx5KCJJbnZhbGlkIHRva2VuIiwgdG9rZW4pOyB9IGNhdGNoIHt9DQogICAgICAgIGlmIChmYWxsYmFja1RvTWFudWFsRm9yRmlyc3RWaXNpdCgiSW52YWxpZCBvciBleHBpcmVkIGxpbmsuIFBsZWFzZSB1c2UgeW91ciBhY2Nlc3MgY29kZS4iKSkgew0KICAgICAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgc2hvd1Nlc3Npb25FeHBpcmVkKCk7DQogICAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KDQogICAgICBjb25zdCBsaW5rRGF0YSA9IHNuYXBzaG90LnZhbCgpOw0KDQogICAgICAvLyBTZSBxdWVzdG8gdG9rZW4gw4PCqCBzdGF0byBibG9jY2F0byBzdSBxdWVzdG8gZGlzcG9zaXRpdm8gKGVzLiB0ZW1wbyBzZXNzaW9uZSBzY2FkdXRvKSwgbm9uIHJpYXR0aXZhcmxvIHN1IHJlZnJlc2gNCiAgICAgIGlmIChpc1Rva2VuRGV2aWNlQmxvY2tlZCh0b2tlbikpIHsNCiAgICAgICAgY29uc3QgciA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGB0b2tlbl9kZXZpY2VfcmVhc29uXyR7dG9rZW59YCkgfHwgIlNlc3Npb25lIHRva2VuIHNjYWR1dGEgc3UgcXVlc3RvIGRpc3Bvc2l0aXZvIjsNCiAgICAgICAgc2hvd1Rva2VuRXJyb3Iocik7DQogICAgICAgIHRyeSB7IGJsb2NrVG9rZW5Pbmx5KHIsIHRva2VuKTsgfSBjYXRjaCB7fQ0KICAgICAgICBpZiAoZmFsbGJhY2tUb01hbnVhbEZvckZpcnN0VmlzaXQocikpIHsNCiAgICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZVNlY3VyZVRva2VuKGxpbmtEYXRhKTsNCiAgICAgIGlmICghaXNWYWxpZC52YWxpZCkgew0KICAgICAgICBzaG93VG9rZW5FcnJvcihpc1ZhbGlkLnJlYXNvbik7DQogICAgICAgIHRyeSB7IGJsb2NrVG9rZW5Pbmx5KGlzVmFsaWQucmVhc29uIHx8ICJBY2Nlc3MgYmxvY2tlZCIsIHRva2VuKTsgfSBjYXRjaCB7fQ0KICAgICAgICBpZiAoZmFsbGJhY2tUb01hbnVhbEZvckZpcnN0VmlzaXQoaXNWYWxpZC5yZWFzb24gfHwgIkFjY2VzcyBibG9ja2VkIikpIHsNCiAgICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCg0KICAgICAgaXNUb2tlblNlc3Npb24gPSB0cnVlOw0KICAgICAgd2luZG93LmlzVG9rZW5TZXNzaW9uID0gdHJ1ZTsgLy8gY29tcGF0IGxlZ2FjeQ0KICAgICAgY3VycmVudFRva2VuSWQgPSB0b2tlbjsNCiAgICAgIGN1cnJlbnRUb2tlbkN1c3RvbUNvZGUgPSBsaW5rRGF0YS5jdXN0b21Db2RlIHx8IG51bGw7DQoNCiAgICAgIC8vIHNibG9jY2EgYmxvY2NoaSBwcmVjZWRlbnRpDQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tfbWFudWFsX2xvZ2luIik7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tlZF90b2tlbiIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImJsb2NrZWRfcmVhc29uIik7DQogICAgICAvLyBBc3NpY3VyYXRpIGNoZSBldmVudHVhbGkgb3ZlcmxheSBkaSBzY2FkZW56YSBub24gcmVzdGlubyB2aXNpYmlsaQ0KICAgICAgdHJ5IHsNCiAgICAgICAgdW5ibG9ja0FjY2VzcygpOw0KICAgICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgIH0gY2F0Y2gge30NCg0KICAgICAgc2hvd1Rva2VuTm90aWZpY2F0aW9uKGlzVmFsaWQucmVtYWluaW5nVXNlcywgISFjdXJyZW50VG9rZW5DdXN0b21Db2RlKTsNCiAgICAgIGF3YWl0IGluY3JlbWVudFRva2VuVXNhZ2UodG9rZW4sIGxpbmtEYXRhKTsNCiAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgIHN0YXJ0VG9rZW5FeHBpcmF0aW9uQ2hlY2sobGlua0RhdGEuZXhwaXJhdGlvbik7DQogICAgICBzdGFydFRva2VuUmVhbHRpbWVMaXN0ZW5lcih0b2tlbik7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigiVG9rZW4gdmVyaWZpY2F0aW9uIGVycm9yOiIsIGVycm9yKTsNCiAgICAgIHNob3dUb2tlbkVycm9yKCJWZXJpZmljYXRpb24gZXJyb3IiKTsNCiAgICAgIHRyeSB7IGJsb2NrVG9rZW5Pbmx5KCJWZXJpZmljYXRpb24gZXJyb3IiLCB0b2tlbik7IH0gY2F0Y2gge30NCiAgICAgIGlmIChmYWxsYmFja1RvTWFudWFsRm9yRmlyc3RWaXNpdCgiVmVyaWZpY2F0aW9uIGVycm9yLiBQbGVhc2UgdXNlIHlvdXIgYWNjZXNzIGNvZGUuIikpIHsNCiAgICAgICAgbWF5YmVDbGVhblVybCgpOw0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQogICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCkgew0KICAgIGlmICh0b2tlblJlZikgew0KICAgICAgdG9rZW5SZWYub2ZmKCk7DQogICAgICB0b2tlblJlZiA9IG51bGw7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJNYW51YWxTZXNzaW9uKCkgew0KICAgIHRyeSB7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oInVzYWdlX2hhc2giKTsNCiAgICAgIHNlc3Npb25TdGFydFRpbWUgPSBudWxsOw0KICAgIH0gY2F0Y2gge30NCiAgfQ0KDQogIGZ1bmN0aW9uIGJsb2NrQWNjZXNzKHJlYXNvbiA9ICJBY2Nlc3NvIGJsb2NjYXRvIiwgdG9rZW4gPSBudWxsKSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJibG9ja19tYW51YWxfbG9naW4iLCAiMSIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfcmVhc29uIiwgcmVhc29uKTsNCiAgICAgIGlmICh0b2tlbikgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfdG9rZW4iLCB0b2tlbik7DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIGJsb2NrQWNjZXNzOiIsIGUpOw0KICAgIH0NCiAgfQ0KDQogIC8vIEJsb2NjYSBzb2xvIGlsIHRva2VuIGNvcnJlbnRlIHNlbnphIGFwcGxpY2FyZSBpbCBibG9jY28gZ2xvYmFsZSBkZWwgZGlzcG9zaXRpdm8NCiAgZnVuY3Rpb24gYmxvY2tUb2tlbk9ubHkocmVhc29uID0gIkFjY2Vzc28gYmxvY2NhdG8iLCB0b2tlbiA9IG51bGwpIHsNCiAgICB0cnkgew0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfcmVhc29uIiwgcmVhc29uKTsNCiAgICAgIGlmICh0b2tlbikgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfdG9rZW4iLCB0b2tlbik7DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIGJsb2NrVG9rZW5Pbmx5OiIsIGUpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHVuYmxvY2tBY2Nlc3MoKSB7DQogICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImJsb2NrX21hbnVhbF9sb2dpbiIpOw0KICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJibG9ja2VkX3JlYXNvbiIpOw0KICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJibG9ja2VkX3Rva2VuIik7DQogIH0NCg0KICAvLyBGbGFnIGRpIGJsb2NjbyBwZXIgcXVlc3RvIHRva2VuIHN1IHF1ZXN0byBkaXNwb3NpdGl2bw0KICBmdW5jdGlvbiBtYXJrVG9rZW5EZXZpY2VCbG9ja2VkKHRva2VuLCByZWFzb24gPSAiIikgew0KICAgIHRyeSB7DQogICAgICBpZiAoIXRva2VuKSByZXR1cm47DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShgdG9rZW5fZGV2aWNlX2Jsb2NrXyR7dG9rZW59YCwgIjEiKTsNCiAgICAgIGlmIChyZWFzb24pIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGB0b2tlbl9kZXZpY2VfcmVhc29uXyR7dG9rZW59YCwgcmVhc29uKTsNCiAgICB9IGNhdGNoIChlKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbWFya1Rva2VuRGV2aWNlQmxvY2tlZDoiLCBlKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBpc1Rva2VuRGV2aWNlQmxvY2tlZCh0b2tlbikgew0KICAgIHRyeSB7DQogICAgICBpZiAoIXRva2VuKSByZXR1cm4gZmFsc2U7DQogICAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oYHRva2VuX2RldmljZV9ibG9ja18ke3Rva2VufWApID09PSAiMSI7DQogICAgfSBjYXRjaCB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJUb2tlbkRldmljZUJsb2NrKHRva2VuKSB7DQogICAgdHJ5IHsNCiAgICAgIGlmICghdG9rZW4pIHJldHVybjsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl9kZXZpY2VfYmxvY2tfJHt0b2tlbn1gKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl9kZXZpY2VfcmVhc29uXyR7dG9rZW59YCk7DQogICAgfSBjYXRjaCB7fQ0KICB9DQoNCiAgZnVuY3Rpb24gaGFzVG9rZW5Gb290cHJpbnQoKSB7DQogICAgdHJ5IHsNCiAgICAgIGlmIChpc1Rva2VuU2Vzc2lvbikgcmV0dXJuIHRydWU7DQogICAgICBjb25zdCB1cmxUb2sgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpLmdldCgidG9rZW4iKTsNCiAgICAgIGlmICh1cmxUb2spIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJibG9ja2VkX3Rva2VuIikpIHJldHVybiB0cnVlOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsb2NhbFN0b3JhZ2UubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY29uc3QgayA9IGxvY2FsU3RvcmFnZS5rZXkoaSk7DQogICAgICAgIGlmIChrICYmIGsuaW5kZXhPZigidG9rZW5fb2tfIikgPT09IDApIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgIGNvbnNvbGUud2FybigiaGFzVG9rZW5Gb290cHJpbnQgY2hlY2sgZmFpbGVkOiIsIGUpOw0KICAgIH0NCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCg0KICBmdW5jdGlvbiBmb3JjZUdsb2JhbExvZ291dChyZWFzb24gPSAiQ29kaWNlIGFnZ2lvcm5hdG86IGFjY2VkaSBkaSBudW92byIpIHsNCiAgICBpc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgIGNsZWFyTWFudWFsU2Vzc2lvbigpOw0KICAgIGNvbnN0IHQgPQ0KICAgICAgY3VycmVudFRva2VuSWQgfHwNCiAgICAgIG5ldyBVUkxTZWFyY2hQYXJhbXMobG9jYXRpb24uc2VhcmNoKS5nZXQoInRva2VuIikgfHwNCiAgICAgIG51bGw7DQogICAgYmxvY2tUb2tlbk9ubHkocmVhc29uLCB0KTsNCiAgICB0cnkgew0KICAgICAgaWYgKHQpIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl9va18ke3R9YCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBzaG93VG9rZW5FcnJvcihyZWFzb24pOw0KICAgIH0gY2F0Y2gge30NCiAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBmb3JjZUxvZ291dEZyb21Ub2tlbihyZWFzb24gPSAiTGluayBub24gcGnDg8K5IHZhbGlkbyIpIHsNCiAgICBpc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgIGNsZWFyTWFudWFsU2Vzc2lvbigpOw0KICAgIGNvbnN0IHQgPQ0KICAgICAgY3VycmVudFRva2VuSWQgfHwNCiAgICAgIG5ldyBVUkxTZWFyY2hQYXJhbXMobG9jYXRpb24uc2VhcmNoKS5nZXQoInRva2VuIikgfHwNCiAgICAgIG51bGw7DQogICAgLy8gTm9uIGJsb2NjYXJlIGdsb2JhbG1lbnRlIGlsIGRpc3Bvc2l0aXZvIHBlciBldmVudGkgbGVnYXRpIGEgcXVlc3RvIHRva2VuDQogICAgYmxvY2tUb2tlbk9ubHkocmVhc29uLCB0KTsNCiAgICBpZiAodCkgbWFya1Rva2VuRGV2aWNlQmxvY2tlZCh0LCByZWFzb24gfHwgIlNlc3Npb25lIHRva2VuIHNjYWR1dGEiKTsNCiAgICB0cnkgew0KICAgICAgaWYgKHQpIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl9va18ke3R9YCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBzaG93VG9rZW5FcnJvcihyZWFzb24pOw0KICAgIH0gY2F0Y2gge30NCiAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBzdGFydFRva2VuUmVhbHRpbWVMaXN0ZW5lcih0b2tlbikgew0KICAgIHN0b3BUb2tlblJlYWx0aW1lTGlzdGVuZXIoKTsNCiAgICB0b2tlblJlZiA9IGRhdGFiYXNlLnJlZigic2VjdXJlX2xpbmtzLyIgKyB0b2tlbik7DQogICAgdG9rZW5SZWYub24oInZhbHVlIiwgKHNuYXApID0+IHsNCiAgICAgIGlmICghc25hcC5leGlzdHMoKSkgew0KICAgICAgICBmb3JjZUxvZ291dEZyb21Ub2tlbigiTGluayByaW1vc3NvIik7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGQgPSBzbmFwLnZhbCgpOw0KICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsNCiAgICAgIGNvbnN0IGV4aGF1c3RlZCA9IChkLnVzZWRDb3VudCB8fCAwKSA+PSAoZC5tYXhVc2FnZSB8fCAwKTsNCiAgICAgIGNvbnN0IGV4cGlyZWQgPSAoZC5leHBpcmF0aW9uIHx8IDApIDw9IG5vdzsNCiAgICAgIGNvbnN0IHJldm9rZWQgPSBkLnN0YXR1cyAhPT0gImFjdGl2ZSI7DQogICAgICBpZiAocmV2b2tlZCB8fCBleHBpcmVkIHx8IGV4aGF1c3RlZCkgew0KICAgICAgICBjb25zdCB3aHkgPSByZXZva2VkDQogICAgICAgICAgPyAiTGluayByZXZvY2F0byINCiAgICAgICAgICA6IGV4cGlyZWQNCiAgICAgICAgICA/ICJMaW5rIHNjYWR1dG8iDQogICAgICAgICAgOiAiVXRpbGl6emkgZXNhdXJpdGkiOw0KICAgICAgICBmb3JjZUxvZ291dEZyb21Ub2tlbih3aHkpOw0KICAgICAgfQ0KICAgIH0pOw0KICB9DQoNCiAgZnVuY3Rpb24gdmFsaWRhdGVTZWN1cmVUb2tlbihsaW5rRGF0YSkgew0KICAgIHRyeSB7DQogICAgICBpZiAoIWxpbmtEYXRhKSByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJlYXNvbjogIlRva2VuIG5vbiB2YWxpZG8iIH07DQogICAgICBpZiAobGlua0RhdGEuc3RhdHVzICE9PSAiYWN0aXZlIikNCiAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJUb2tlbiByZXZvY2F0byIgfTsNCiAgICAgIGlmIChsaW5rRGF0YS5leHBpcmF0aW9uIDwgRGF0ZS5ub3coKSkNCiAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJUb2tlbiBzY2FkdXRvIiB9Ow0KICAgICAgaWYgKChsaW5rRGF0YS51c2VkQ291bnQgfHwgMCkgPj0gKGxpbmtEYXRhLm1heFVzYWdlIHx8IDApKQ0KICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJlYXNvbjogIlV0aWxpenppIGVzYXVyaXRpIiB9Ow0KICAgICAgY29uc3QgcmVtYWluaW5nVXNlcyA9DQogICAgICAgIChsaW5rRGF0YS5tYXhVc2FnZSB8fCAwKSAtIChsaW5rRGF0YS51c2VkQ291bnQgfHwgMCk7DQogICAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSwgcmVtYWluaW5nVXNlcyB9Ow0KICAgIH0gY2F0Y2ggew0KICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJFcnJvcmUgZGkgdmVyaWZpY2EiIH07DQogICAgfQ0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gaW5jcmVtZW50VG9rZW5Vc2FnZSh0b2tlbiwgbGlua0RhdGEpIHsNCiAgICBjb25zdCBuZXdVc2VkQ291bnQgPSAobGlua0RhdGEudXNlZENvdW50IHx8IDApICsgMTsNCiAgICBjb25zdCBuZXdTdGF0dXMgPQ0KICAgICAgbmV3VXNlZENvdW50ID49IChsaW5rRGF0YS5tYXhVc2FnZSB8fCAwKSA/ICJ1c2VkIiA6ICJhY3RpdmUiOw0KICAgIHRyeSB7DQogICAgICBhd2FpdCBkYXRhYmFzZQ0KICAgICAgICAucmVmKCJzZWN1cmVfbGlua3MvIiArIHRva2VuKQ0KICAgICAgICAudXBkYXRlKHsgdXNlZENvdW50OiBuZXdVc2VkQ291bnQsIHN0YXR1czogbmV3U3RhdHVzIH0pOw0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsbCdhZ2dpb3JuYW1lbnRvIGRlbCB0b2tlbjoiLCBlcnJvcik7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gc2hvd1Rva2VuTm90aWZpY2F0aW9uKHJlbWFpbmluZ1VzZXMsIGhhc0N1c3RvbUNvZGUpIHsNCiAgICBjb25zdCBuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgbi5zdHlsZS5jc3NUZXh0ID0gYA0KICAgICAgcG9zaXRpb246Zml4ZWQ7IHRvcDoyMHB4OyByaWdodDoyMHB4OyBiYWNrZ3JvdW5kOnZhcigtLXN1Y2Nlc3MpOyBjb2xvcjojZmZmOw0KICAgICAgcGFkZGluZzoxNXB4IDIwcHg7IGJvcmRlci1yYWRpdXM6OHB4OyBib3gtc2hhZG93OjAgNHB4IDEycHggcmdiYSgwLDAsMCwuMSk7DQogICAgICB6LWluZGV4OjEwMDAwOyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBhbGlnbi1pdGVtczpjZW50ZXI7IG1heC13aWR0aDozNTBweDtgOw0KICAgIGNvbnN0IGN1c3RvbSA9IGhhc0N1c3RvbUNvZGUNCiAgICAgID8gJzxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxMnB4O29wYWNpdHk6Ljk7Ij5RdWVzdG8gbGluayB1c2EgdW4gY29kaWNlIGRlZGljYXRvPC9kaXY+Jw0KICAgICAgOiAnPGRpdiBzdHlsZT0iZm9udC1zaXplOjEycHg7b3BhY2l0eTouOTsiPlF1ZXN0byBsaW5rIHVzYSBpbCBjb2RpY2UgcHJpbmNpcGFsZTwvZGl2Pic7DQogICAgbi5pbm5lckhUTUwgPSBgDQogICAgICA8aSBjbGFzcz0iZmFzIGZhLWNoZWNrLWNpcmNsZSI+PC9pPg0KICAgICAgPGRpdj4NCiAgICAgICAgPGRpdj5MaW5rIHNpY3VybyByaWNvbm9zY2l1dG88L2Rpdj4NCiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEycHg7b3BhY2l0eTouOTsiPlV0aWxpenppIHJpbWFuZW50aTogJHtyZW1haW5pbmdVc2VzfTwvZGl2Pg0KICAgICAgICAke2N1c3RvbX0NCiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEycHg7b3BhY2l0eTouOTttYXJnaW4tdG9wOjVweDsiPjxpIGNsYXNzPSJmYXMgZmEtaW5mby1jaXJjbGUiPjwvaT4gSW5zZXJpc2NpIGlsIGNvZGljZSBxdWkgc290dG88L2Rpdj4NCiAgICAgIDwvZGl2Pg0KICAgICAgPGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQucmVtb3ZlKCkiIHN0eWxlPSJiYWNrZ3JvdW5kOm5vbmU7Ym9yZGVyOm5vbmU7Y29sb3I6I2ZmZjttYXJnaW4tbGVmdDoxMHB4O2N1cnNvcjpwb2ludGVyIj4NCiAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS10aW1lcyI+PC9pPg0KICAgICAgPC9idXR0b24+YDsNCiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG4pOw0KICAgIHNldFRpbWVvdXQoKCkgPT4gbi5wYXJlbnRFbGVtZW50ICYmIG4ucmVtb3ZlKCksIDUwMDApOw0KICB9DQoNCiAgDQoNCiAgZnVuY3Rpb24gc2hvd1Rva2VuRXJyb3IocmVhc29uKSB7DQogICAgY29uc3QgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIG4uc3R5bGUuY3NzVGV4dCA9IGANCiAgICAgIHBvc2l0aW9uOmZpeGVkOyB0b3A6MjBweDsgcmlnaHQ6MjBweDsgYmFja2dyb3VuZDp2YXIoLS1lcnJvcik7IGNvbG9yOiNmZmY7DQogICAgICBwYWRkaW5nOjE1cHggMjBweDsgYm9yZGVyLXJhZGl1czo4cHg7IGJveC1zaGFkb3c6MCA0cHggMTJweCByZ2JhKDAsMCwwLC4xKTsNCiAgICAgIHotaW5kZXg6MTAwMDA7IGRpc3BsYXk6ZmxleDsgZ2FwOjEwcHg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgbWF4LXdpZHRoOjMyMHB4O2A7DQogICAgbi5pbm5lckhUTUwgPSBgDQogICAgICA8aSBjbGFzcz0iZmFzIGZhLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlIj48L2k+DQogICAgICA8ZGl2Pg0KICAgICAgICA8ZGl2Pkxpbmsgbm9uIHZhbGlkbzwvZGl2Pg0KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MTJweDtvcGFjaXR5Oi45OyI+TW90aXZvOiAke3JlYXNvbn08L2Rpdj4NCiAgICAgIDwvZGl2Pg0KICAgICAgPGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQucmVtb3ZlKCkiIHN0eWxlPSJiYWNrZ3JvdW5kOm5vbmU7Ym9yZGVyOm5vbmU7Y29sb3I6I2ZmZjttYXJnaW4tbGVmdDoxMHB4O2N1cnNvcjpwb2ludGVyIj4NCiAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS10aW1lcyI+PC9pPg0KICAgICAgPC9idXR0b24+YDsNCiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG4pOw0KICAgIHNldFRpbWVvdXQoKCkgPT4gbi5wYXJlbnRFbGVtZW50ICYmIG4ucmVtb3ZlKCksIDUwMDApOw0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYW5VcmwoKSB7DQogICAgaWYgKHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSkgew0KICAgICAgY29uc3QgY2xlYW4gPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lOw0KICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgY2xlYW4pOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHN0YXJ0VG9rZW5FeHBpcmF0aW9uQ2hlY2soZXhwaXJhdGlvblRpbWUpIHsNCiAgICBjb25zdCBpdiA9IHNldEludGVydmFsKCgpID0+IHsNCiAgICAgIGlmIChEYXRlLm5vdygpID4gZXhwaXJhdGlvblRpbWUpIHsNCiAgICAgICAgY2xlYXJJbnRlcnZhbChpdik7DQogICAgICAgIGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgICAgICBjb25zdCB0ID0gY3VycmVudFRva2VuSWQgfHwgbnVsbDsNCiAgICAgICAgYmxvY2tUb2tlbk9ubHkoIkxpbmsgZXhwaXJlZCIsIHQpOw0KICAgICAgICBpZiAodCkgbWFya1Rva2VuRGV2aWNlQmxvY2tlZCh0LCAiTGluayBleHBpcmVkIik7DQogICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgfQ0KICAgIH0sIDEwMDApOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIEFVVEVOVElDQVpJT05FDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBpc0xvZ2luTG9ja2VkKCkgew0KICAgIHRyeSB7DQogICAgICBjb25zdCB1bnRpbCA9IHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJsb2dpbl9sb2NrX3VudGlsIikgfHwgIjAiLCAxMCk7DQogICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZSh1bnRpbCkgfHwgdW50aWwgPD0gMCkgcmV0dXJuIGZhbHNlOw0KICAgICAgaWYgKERhdGUubm93KCkgPCB1bnRpbCkgcmV0dXJuIHRydWU7DQogICAgICAvLyBsb2NrIHNjYWR1dG8gLT4gcHVsaXppYQ0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2xvY2tfdW50aWwiKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJsb2dpbl9hdHRlbXB0cyIpOw0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0gY2F0Y2ggew0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHNlY29uZHNUb0hoTW1TcyhzZWMpIHsNCiAgICBjb25zdCBzID0gTWF0aC5tYXgoMCwgTWF0aC5mbG9vcihzZWMpKTsNCiAgICBjb25zdCBoID0gTWF0aC5mbG9vcihzIC8gMzYwMCk7DQogICAgY29uc3QgbSA9IE1hdGguZmxvb3IoKHMgJSAzNjAwKSAvIDYwKTsNCiAgICBjb25zdCByID0gcyAlIDYwOw0KICAgIGlmIChoID4gMCkgcmV0dXJuIGAke2h9aCAke1N0cmluZyhtKS5wYWRTdGFydCgyLCAiMCIpfW0gJHtTdHJpbmcocikucGFkU3RhcnQoMiwgIjAiKX1zYDsNCiAgICByZXR1cm4gYCR7U3RyaW5nKG0pLnBhZFN0YXJ0KDIsICIwIil9bSAke1N0cmluZyhyKS5wYWRTdGFydCgyLCAiMCIpfXNgOw0KICB9DQoNCiAgZnVuY3Rpb24gdXBkYXRlTG9ja1VJKCkgew0KICAgIGNvbnN0IGlucHV0ID0gcXMoImF1dGhDb2RlIik7DQogICAgY29uc3QgYnRuID0gcXMoImJ0bkNoZWNrQ29kZSIpOw0KICAgIGNvbnN0IGV4aXN0aW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImxvY2tOb3RpY2UiKTsNCiAgICBjb25zdCBsb2NrZWQgPSBpc0xvZ2luTG9ja2VkKCk7DQogICAgaWYgKGxvY2tlZCkgew0KICAgICAgaWYgKGlucHV0KSBpbnB1dC5kaXNhYmxlZCA9IHRydWU7DQogICAgICBpZiAoYnRuKSB7DQogICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7DQogICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCJidG4tZXJyb3IiKTsNCiAgICAgIH0NCiAgICAgIC8vIGNyZWEvYWdnaW9ybmEgbWVzc2FnZ2lvIGxvY2sgY29uIGNvdW50ZG93bg0KICAgICAgbGV0IG5vdGljZSA9IGV4aXN0aW5nOw0KICAgICAgaWYgKCFub3RpY2UgJiYgaW5wdXQ/LnBhcmVudEVsZW1lbnQpIHsNCiAgICAgICAgbm90aWNlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgICAgIG5vdGljZS5pZCA9ICJsb2NrTm90aWNlIjsNCiAgICAgICAgbm90aWNlLnN0eWxlLmNzc1RleHQgPQ0KICAgICAgICAgICJtYXJnaW4tdG9wOjEwcHg7Y29sb3I6I2ZmNWE1Zjtmb250LXdlaWdodDo2MDA7IjsNCiAgICAgICAgaW5wdXQucGFyZW50RWxlbWVudC5pbnNlcnRBZGphY2VudEVsZW1lbnQoImFmdGVyZW5kIiwgbm90aWNlKTsNCiAgICAgIH0NCiAgICAgIGlmIChub3RpY2UpIHsNCiAgICAgICAgY29uc3QgdW50aWwgPSBwYXJzZUludCgNCiAgICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibG9naW5fbG9ja191bnRpbCIpIHx8ICIwIiwNCiAgICAgICAgICAxMA0KICAgICAgICApOw0KICAgICAgICBjb25zdCByZW1haW5pbmdTZWMgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKCh1bnRpbCAtIERhdGUubm93KCkpIC8gMTAwMCkpOw0KICAgICAgICBub3RpY2UuaW5uZXJIVE1MID0NCiAgICAgICAgICBgPGkgY2xhc3M9ImZhcyBmYS1sb2NrIj48L2k+IFRvbyBtYW55IGluY29ycmVjdCBhdHRlbXB0cy4gVHJ5IGFnYWluIGluICR7c2Vjb25kc1RvSGhNbVNzKHJlbWFpbmluZ1NlYyl9LmA7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIGlmIChpbnB1dCkgaW5wdXQuZGlzYWJsZWQgPSBmYWxzZTsNCiAgICAgIGlmIChidG4pIHsNCiAgICAgICAgYnRuLmRpc2FibGVkID0gZmFsc2U7DQogICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKCJidG4tZXJyb3IiKTsNCiAgICAgIH0NCiAgICAgIGlmIChleGlzdGluZykgZXhpc3RpbmcucmVtb3ZlKCk7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gaW5jcmVtZW50RmFpbGVkQXR0ZW1wdCgpIHsNCiAgICB0cnkgew0KICAgICAgY29uc3QgYXR0ZW1wdHMgPSBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibG9naW5fYXR0ZW1wdHMiKSB8fCAiMCIsIDEwKSArIDE7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgibG9naW5fYXR0ZW1wdHMiLCBTdHJpbmcoYXR0ZW1wdHMpKTsNCiAgICAgIGNvbnN0IGxlZnQgPSBNYXRoLm1heCgwLCBNQVhfTE9HSU5fQVRURU1QVFMgLSBhdHRlbXB0cyk7DQogICAgICBpZiAoYXR0ZW1wdHMgPj0gTUFYX0xPR0lOX0FUVEVNUFRTKSB7DQogICAgICAgIGNvbnN0IHVudGlsID0gRGF0ZS5ub3coKSArIExPQ0tPVVRfTUlOVVRFUyAqIDYwICogMTAwMDsNCiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImxvZ2luX2xvY2tfdW50aWwiLCBTdHJpbmcodW50aWwpKTsNCiAgICAgICAgc2hvd05vdGlmaWNhdGlvbigNCiAgICAgICAgICBgVG9vIG1hbnkgZmFpbGVkIGF0dGVtcHRzLiBQYWdlIGxvY2tlZCBmb3IgJHtMT0NLT1VUX01JTlVURVN9IG1pbnV0ZXNgLA0KICAgICAgICAgICJlcnJvciINCiAgICAgICAgKTsNCiAgICAgICAgdXBkYXRlTG9ja1VJKCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBzaG93Tm90aWZpY2F0aW9uKGBXcm9uZyBjb2RlLiBBdHRlbXB0cyBsZWZ0OiAke2xlZnR9YCwgIndhcm5pbmciKTsNCiAgICAgIH0NCiAgICB9IGNhdGNoIChlKSB7DQogICAgICBjb25zb2xlLndhcm4oIkltcG9zc2liaWxlIGluY3JlbWVudGFyZSBpIHRlbnRhdGl2aToiLCBlKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiByZXNldEZhaWxlZEF0dGVtcHRzKCkgew0KICAgIHRyeSB7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgibG9naW5fYXR0ZW1wdHMiKTsNCiAgICAgIC8vIG5vbiB0b2NjYXJlIGV2ZW50dWFsZSBsb2NrIGF0dGl2bw0KICAgIH0gY2F0Y2gge30NCiAgfQ0KICBhc3luYyBmdW5jdGlvbiBwZXJmb3JtTWFudWFsTG9naW4oKSB7DQogICAgaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICB3aW5kb3cuaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICBzZXNzaW9uU3RhcnRUaW1lID0gRGF0ZS5ub3coKTsNCiAgICBhd2FpdCBzZXRVc2FnZVN0YXJ0VGltZSgpOw0KDQogICAgaWYgKGF3YWl0IGNoZWNrVGltZUxpbWl0KCkpIHJldHVybjsNCg0KICAgIC8vIEFzc2ljdXJhdGkgZGkgbmFzY29uZGVyZSBldmVudHVhbGkgb3ZlcmxheSBkaSBzY2FkZW56YQ0KICAgIHRyeSB7DQogICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICB1bmJsb2NrQWNjZXNzKCk7DQogICAgfSBjYXRjaCB7fQ0KDQogICAgc2hvd0NvbnRyb2xQYW5lbCgpOw0KICAgIHFzKCJjaGVja2luVGltZUluZm8iKSAmJiAocXMoImNoZWNraW5UaW1lSW5mbyIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siKTsNCiAgICB1cGRhdGVDaGVja2luVGltZURpc3BsYXkoKTsNCiAgICBERVZJQ0VTLmZvckVhY2godXBkYXRlQnV0dG9uU3RhdGUpOw0KICAgIHVwZGF0ZVN0YXR1c0JhcigpOw0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlQ29kZVN1Ym1pdCgpIHsNCiAgICAvLyBibG9jY28gaW1tZWRpYXRvIHNlIGxvY2sgYXR0aXZvDQogICAgaWYgKGlzTG9naW5Mb2NrZWQoKSkgew0KICAgICAgdXBkYXRlTG9ja1VJKCk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGNvbnN0IGNvZGVJbnB1dCA9IHFzKCJhdXRoQ29kZSIpOw0KICAgIGNvbnN0IGluc2VydGVkQ29kZSA9IChjb2RlSW5wdXQ/LnZhbHVlIHx8ICIiKS50cmltKCk7DQogICAgbGV0IGV4cGVjdGVkQ29kZSA9IENPUlJFQ1RfQ09ERTsNCg0KICAgIC8vIE5vbiBjb250YXJlIGkgdGVudGF0aXZpIGEgdnVvdG8NCiAgICBpZiAoIWluc2VydGVkQ29kZSkgew0KICAgICAgc2hvd05vdGlmaWNhdGlvbigiUGxlYXNlIGVudGVyIHRoZSBhY2Nlc3MgY29kZSIsICJ3YXJuaW5nIik7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgaWYgKGlzVG9rZW5TZXNzaW9uICYmIGN1cnJlbnRUb2tlbkN1c3RvbUNvZGUpDQogICAgICBleHBlY3RlZENvZGUgPSBjdXJyZW50VG9rZW5DdXN0b21Db2RlOw0KDQogICAgaWYgKGluc2VydGVkQ29kZSAhPT0gZXhwZWN0ZWRDb2RlKSB7DQogICAgICBpbmNyZW1lbnRGYWlsZWRBdHRlbXB0KCk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIHJlc2V0RmFpbGVkQXR0ZW1wdHMoKTsNCiAgICAvLyBTZSBzaWFtbyBpbiBzZXNzaW9uZSB0b2tlbiwgcGVyc2lzdGkgdmFsaWRhemlvbmUgZSBtb3N0cmEgcGFubmVsbG8NCiAgICBpZiAoaXNUb2tlblNlc3Npb24pIHsNCiAgICAgIHRyeSB7DQogICAgICAgIGlmIChjdXJyZW50VG9rZW5JZCkNCiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShgdG9rZW5fb2tfJHtjdXJyZW50VG9rZW5JZH1gLCAiMSIpOw0KICAgICAgICAvLyBBdnZpYSBpbCB0aW1lciBkaSB1dGlsaXp6byBwZXIgc2Vzc2lvbmUgdG9rZW4gZG9wbyBzdWJtaXQNCiAgICAgICAgaWYgKGN1cnJlbnRUb2tlbklkKSBhd2FpdCBzZXRUb2tlblVzYWdlU3RhcnRUaW1lKGN1cnJlbnRUb2tlbklkKTsNCiAgICAgICAgLy8gTmFzY29uZGkgcXVhbHNpYXNpIG92ZXJsYXkgZGkgc2NhZGVuemEgZXZlbnR1YWxtZW50ZSByaW1hc3RvDQogICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICB1bmJsb2NrQWNjZXNzKCk7DQogICAgICB9IGNhdGNoIHt9DQogICAgICBzaG93Q29udHJvbFBhbmVsKCk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGF3YWl0IHBlcmZvcm1NYW51YWxMb2dpbigpOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIElOSVpJQUxJWlpBWklPTkUgQVBQDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBhc3luYyBmdW5jdGlvbiBpbml0KCkgew0KICAgIGNvbnNvbGUubG9nKCJJbml6aWFsaXp6YXppb25lIGFwcC4iKTsNCg0KICAgIGNvbnN0IGZpcmViYXNlU2V0dGluZ3MgPSBhd2FpdCBsb2FkU2V0dGluZ3NGcm9tRmlyZWJhc2UoKTsNCiAgICBpZiAoZmlyZWJhc2VTZXR0aW5ncykgYXBwbHlGaXJlYmFzZVNldHRpbmdzKGZpcmViYXNlU2V0dGluZ3MpOw0KDQogICAgaWYgKGlzU2Vzc2lvblN0dWNrKCkpIGNvbnNvbGUud2FybigiUmlsZXZhdGEgcG9zc2liaWxlIHNlc3Npb25lIGJsb2NjYXRhIik7DQoNCiAgICBjb25zdCBzYXZlZENvZGVWZXJzaW9uID0NCiAgICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjb2RlX3ZlcnNpb24iKSkgfHwgMTsNCiAgICBpZiAoc2F2ZWRDb2RlVmVyc2lvbiA8IGN1cnJlbnRDb2RlVmVyc2lvbikgew0KICAgICAgcmVzZXRTZXNzaW9uRm9yTmV3Q29kZSgpOw0KICAgIH0NCg0KICAgIHNldHVwRXZlbnRMaXN0ZW5lcnMoKTsNCiAgICBzZXR1cFNldHRpbmdzTGlzdGVuZXIoKTsNCiAgICBtb25pdG9yRmlyZWJhc2VDb25uZWN0aW9uKCk7DQoNCiAgICAvLyBQUklNTyBBQ0NFU1NPIFNFTlpBIFRPS0VOOiBldml0YSBvdmVybGF5IGUgbW9zdHJhIHN1Yml0byBpbCBmb3JtIGNvZGljZQ0KICAgIHRyeSB7DQogICAgICBjb25zdCBoYXNUb2tlbiA9IG5ldyBVUkxTZWFyY2hQYXJhbXMobG9jYXRpb24uc2VhcmNoKS5nZXQoInRva2VuIik7DQogICAgICBpZiAoIWhhc1Rva2VuICYmIGlzRmlyc3RWaXNpdERldmljZSgpKSB7DQogICAgICAgIHN1cHByZXNzT3ZlcmxheSA9IHRydWU7DQogICAgICAgIHVuYmxvY2tBY2Nlc3MoKTsNCiAgICAgICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHFzKCJjb250cm9sUGFuZWwiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHNob3dBdXRoRm9ybSgpOw0KICAgICAgICByZWNvcmRGaXJzdFZpc2l0SGFuZGxlZCgpOw0KICAgICAgfQ0KICAgIH0gY2F0Y2gge30NCg0KICAgIC8vIEJMT0NDTyBQRVJTSVNURU5URSBQUklNQSBESSBUVVRUTw0KICAgIGNvbnN0IGlzQmxvY2tlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJibG9ja19tYW51YWxfbG9naW4iKSA9PT0gIjEiOw0KICAgIGlmIChpc0Jsb2NrZWQpIHsNCiAgICAgIGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgICB3aW5kb3cuaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgIH0NCg0KICAgIC8vIFRPS0VOIHByaW1hIGRlbGxhIHNlc3Npb25lIG1hbnVhbGUNCiAgICBhd2FpdCBoYW5kbGVTZWN1cmVUb2tlbigpOw0KICAgIHNldHVwVG9rZW5VSSgpOw0KICAgIGlmIChpc1Rva2VuU2Vzc2lvbikgdW5ibG9ja0FjY2VzcygpOw0KICAgIC8vIFNlIGlsIGRpc3Bvc2l0aXZvIMODwqggYmxvY2NhdG8gZSBub24gYWJiaWFtbyB1bmEgc2Vzc2lvbmUgdG9rZW4gdmFsaWRhLA0KICAgIC8vIGludGVycm9tcGkgcXVpIHBlciBldml0YXJlIGNoZSBsJ292ZXJsYXkgdmVuZ2EgbmFzY29zdG8gZGEgYWx0cmUgcm91dGluZSBVSS4NCiAgICBpZiAoaXNCbG9ja2VkICYmICFpc1Rva2VuU2Vzc2lvbikgew0KICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIC8vIEF1dG8tYWNjZXNzbyBzZSB0b2tlbiBnacODwqAgdmFsaWRhdG8gc3UgcXVlc3RvIGRpc3Bvc2l0aXZvDQogICAgaWYgKGlzVG9rZW5TZXNzaW9uKSB7DQogICAgICBjb25zdCB0b2sgPQ0KICAgICAgICBjdXJyZW50VG9rZW5JZCB8fCBuZXcgVVJMU2VhcmNoUGFyYW1zKGxvY2F0aW9uLnNlYXJjaCkuZ2V0KCJ0b2tlbiIpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgaWYgKHRvayAmJiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShgdG9rZW5fb2tfJHt0b2t9YCkgPT09ICIxIikgew0KICAgICAgICAgIHNob3dDb250cm9sUGFuZWwoKTsNCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCB7fQ0KICAgIH0NCg0KICAgIC8vIFNlIG5vbiBibG9jY2F0byBlIHNlbnphIHRva2VuOiBVSSBtYW51YWxlDQogICAgaWYgKCFpc1Rva2VuU2Vzc2lvbiAmJiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiYmxvY2tfbWFudWFsX2xvZ2luIikgIT09ICIxIikgew0KICAgICAgY29uc3QgZXhwaXJlZCA9IGF3YWl0IGNoZWNrVGltZUxpbWl0KCk7DQogICAgICBpZiAoIWV4cGlyZWQpIHsNCiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gZ2V0U3RvcmFnZSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KICAgICAgICBpZiAoc3RhcnRUaW1lKSB7DQogICAgICAgICAgc2Vzc2lvblN0YXJ0VGltZSA9IHBhcnNlSW50KHN0YXJ0VGltZSwgMTApOw0KICAgICAgICAgIHNob3dDb250cm9sUGFuZWwoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzaG93QXV0aEZvcm0oKTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc2hvd0F1dGhGb3JtKCk7DQogICAgICB9DQogICAgfQ0KDQogICAgdXBkYXRlRG9vclZpc2liaWxpdHkoKTsNCiAgICB1cGRhdGVMb2NrVUkoKTsNCiAgICBzZXR1cEludGVydmFscygpOw0KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51IiwgKGUpID0+IGUucHJldmVudERlZmF1bHQoKSk7DQogICAgdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5KCk7DQogIH0NCg0KICBmdW5jdGlvbiBzZXR1cEV2ZW50TGlzdGVuZXJzKCkgew0KICAgIG9uKCJidG5DaGVja0NvZGUiLCAiY2xpY2siLCBoYW5kbGVDb2RlU3VibWl0KTsNCg0KICAgIERFVklDRVMuZm9yRWFjaCgoZGV2aWNlKSA9PiB7DQogICAgICBjb25zdCBidG4gPSBxcyhkZXZpY2UuYnV0dG9uX2lkKTsNCiAgICAgIGlmIChidG4pDQogICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHNob3dDb25maXJtYXRpb25Qb3B1cChkZXZpY2UpKTsNCiAgICB9KTsNCg0KICAgIG9uKCJjb25maXJtWWVzIiwgImNsaWNrIiwgKCkgPT4gew0KICAgICAgaWYgKGN1cnJlbnREZXZpY2UpIHsNCiAgICAgICAgYWN0aXZhdGVEZXZpY2UoY3VycmVudERldmljZSk7DQogICAgICAgIGNsb3NlQ29uZmlybWF0aW9uUG9wdXAoKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgICBvbigiY29uZmlybU5vIiwgImNsaWNrIiwgY2xvc2VDb25maXJtYXRpb25Qb3B1cCk7DQoNCiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIucG9wdXAgLmJ0biIpLmZvckVhY2goKGJ1dHRvbikgPT4gew0KICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCkgew0KICAgICAgICBjb25zdCBwb3B1cCA9IHRoaXMuY2xvc2VzdCgiLnBvcHVwIik7DQogICAgICAgIGlmIChwb3B1cCkgew0KICAgICAgICAgIGNvbnN0IGlkID0gcG9wdXAuaWQucmVwbGFjZSgicG9wdXAtIiwgIiIpOw0KICAgICAgICAgIGNsb3NlUG9wdXAoaWQpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNob3dDb250cm9sUGFuZWwoKSB7DQogICAgY29uc3QgY3AgPSBxcygiY29udHJvbFBhbmVsIik7DQogICAgaWYgKGNwKSB7DQogICAgICBjcC5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsNCiAgICAgIGNwLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIH0NCiAgICBjb25zdCByb290ID0gcXMoInRlc3QyIik7DQogICAgaWYgKHJvb3QpIHJvb3Quc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgY29uc3QgYWMgPSBxcygiYXV0aENvZGUiKTsNCiAgICBpZiAoYWMpIGFjLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgY29uc3QgYWYgPSBxcygiYXV0aC1mb3JtIik7DQogICAgaWYgKGFmKSBhZi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIGNvbnN0IGJjID0gcXMoImJ0bkNoZWNrQ29kZSIpOw0KICAgIGlmIChiYykgYmMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICBjb25zdCBpbXAgPSBxcygiaW1wb3J0YW50Iik7DQogICAgaWYgKGltcCkgaW1wLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgLy8gYXNzaWN1cmF0aSBjaGUgZXZlbnR1YWxpIG92ZXJsYXkgbm9uIGNvcHJhbm8gaWwgcGFubmVsbG8NCiAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgIGNvbnN0IGluZm8gPSBxcygiY2hlY2tpblRpbWVJbmZvIik7DQogICAgaWYgKGluZm8pIGluZm8uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5KCk7DQogICAgREVWSUNFUy5mb3JFYWNoKHVwZGF0ZUJ1dHRvblN0YXRlKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNob3dBdXRoRm9ybSgpIHsNCiAgICBjb25zdCBjcCA9IHFzKCJjb250cm9sUGFuZWwiKTsNCiAgICBpZiAoY3ApIGNwLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgY29uc3QgYWMgPSBxcygiYXV0aENvZGUiKTsNCiAgICBpZiAoYWMpIGFjLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIGNvbnN0IGFmID0gcXMoImF1dGgtZm9ybSIpOw0KICAgIGlmIChhZikgYWYuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgY29uc3QgYmMgPSBxcygiYnRuQ2hlY2tDb2RlIik7DQogICAgaWYgKGJjKSBiYy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgICBjb25zdCBpbXAgPSBxcygiaW1wb3J0YW50Iik7DQogICAgaWYgKGltcCkgaW1wLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICB9DQoNCiAgZnVuY3Rpb24gc2V0dXBUb2tlblVJKCkgew0KICAgIGlmICghaXNUb2tlblNlc3Npb24pIHJldHVybjsNCg0KICAgIGNvbnN0IGFkbWluTGluayA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2FbaHJlZj0iYWRtaW4uaHRtbCJdJyk7DQogICAgaWYgKGFkbWluTGluaykgYWRtaW5MaW5rLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQoNCiAgICBjb25zdCBleHBpcmVkTWVzc2FnZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNzZXNzaW9uRXhwaXJlZCBwIik7DQogICAgaWYgKGV4cGlyZWRNZXNzYWdlKQ0KICAgICAgZXhwaXJlZE1lc3NhZ2UudGV4dENvbnRlbnQgPQ0KICAgICAgICAiVGhlIGFjY2VzcyBsaW5rIGhhcyBleHBpcmVkLiBUbyBhY2Nlc3MgYWdhaW4sIHJlcXVlc3QgYSBuZXcgbGluay4iOw0KDQogICAgY29uc3QgYXNzaXN0YW5jZUJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAiI3Nlc3Npb25FeHBpcmVkIC5idG4td2hhdHNhcHAiDQogICAgKTsNCiAgICBpZiAoYXNzaXN0YW5jZUJ0bikgew0KICAgICAgYXNzaXN0YW5jZUJ0bi5ocmVmID0NCiAgICAgICAgImh0dHBzOi8vYXBpLndoYXRzYXBwLmNvbS9zZW5kP3Bob25lPSszOTM4OTg4ODM2MzQmdGV4dD1IaSwgSSBuZWVkIGEgbmV3IGFjY2VzcyBsaW5rIjsNCiAgICAgIGFzc2lzdGFuY2VCdG4uaW5uZXJIVE1MID0NCiAgICAgICAgJzxpIGNsYXNzPSJmYWIgZmEtd2hhdHNhcHAiPjwvaT4gUmVxdWVzdCBuZXcgbGluayc7DQogICAgfQ0KDQogICAgY29uc3QgYXV0aENvZGVJbnB1dCA9IHFzKCJhdXRoQ29kZSIpOw0KICAgIGlmIChhdXRoQ29kZUlucHV0KSB7DQogICAgICBhdXRoQ29kZUlucHV0LnBsYWNlaG9sZGVyID0gY3VycmVudFRva2VuQ3VzdG9tQ29kZQ0KICAgICAgICA/ICJJbnNlcmlzY2kgaWwgY29kaWNlIGRlZGljYXRvIGRlbCBsaW5rIg0KICAgICAgICA6ICJJbnNlcmlzY2kgaWwgY29kaWNlIHByaW5jaXBhbGUiOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHNldHVwSW50ZXJ2YWxzKCkgew0KICAgIHNldHVwQ29kZUNoYW5nZUxpc3RlbmVyKCk7DQoNCiAgICB0aW1lQ2hlY2tJbnRlcnZhbCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHsNCiAgICAgIGNvbnN0IGV4cGlyZWQgPSBhd2FpdCBjaGVja1RpbWVMaW1pdCgpOw0KICAgICAgaWYgKCFleHBpcmVkKSB7DQogICAgICAgIGF3YWl0IHVwZGF0ZUdsb2JhbENvZGVWZXJzaW9uKCk7DQogICAgICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSgpOw0KICAgICAgfQ0KICAgICAgLy8gYWdnaW9ybmEgc3RhdG8gZGkgbG9jayBvZ25pIHNlY29uZG8gcGVyIGNvdW50ZG93bg0KICAgICAgdXBkYXRlTG9ja1VJKCk7DQogICAgfSwgMTAwMCk7DQoNCiAgICBzZXRJbnRlcnZhbCh1cGRhdGVDaGVja2luVGltZURpc3BsYXksIDYwMDAwKTsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBBVlZJTy9TVE9QDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgaW5pdCk7DQoNCiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImJlZm9yZXVubG9hZCIsICgpID0+IHsNCiAgICBpZiAodGltZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGltZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGlmIChjb2RlQ2hlY2tJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbChjb2RlQ2hlY2tJbnRlcnZhbCk7DQogICAgaWYgKExJTktfQ0hFQ0tfSU5URVJWQUwpIGNsZWFySW50ZXJ2YWwoTElOS19DSEVDS19JTlRFUlZBTCk7DQogICAgc3RvcFRva2VuUmVhbHRpbWVMaXN0ZW5lcigpOw0KICAgIGlmIChzZXR0aW5nc1JlZikgc2V0dGluZ3NSZWYub2ZmICYmIHNldHRpbmdzUmVmLm9mZigpOw0KICB9KTsNCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gRVNQT1JUQVpJT05FIEZVTlpJT05JIEdMT0JBTEkgKGNvbXBhdGliaWxpdMODwqApDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBPYmplY3QuYXNzaWduKHdpbmRvdywgew0KICAgIC8vIHV0aWxzDQogICAgcXMsDQogICAgb24sDQogICAgc2hvd05vdGlmaWNhdGlvbiwNCiAgICBmb3JtYXRUaW1lLA0KICAgIGZldGNoV2l0aFRpbWVvdXQsDQogICAgLy8gc3RvcmFnZQ0KICAgIHNldFN0b3JhZ2UsDQogICAgZ2V0U3RvcmFnZSwNCiAgICBjbGVhclN0b3JhZ2UsDQogICAgLy8gY3J5cHRvDQogICAgZ2VuZXJhdGVIYXNoLA0KICAgIC8vIHNldHRpbmdzDQogICAgbG9hZFNldHRpbmdzRnJvbUZpcmViYXNlLA0KICAgIGFwcGx5RmlyZWJhc2VTZXR0aW5ncywNCiAgICBzZXR1cFNldHRpbmdzTGlzdGVuZXIsDQogICAgbW9uaXRvckZpcmViYXNlQ29ubmVjdGlvbiwNCiAgICAvLyB0ZW1wby9zZXNzaW9uZQ0KICAgIHNldFVzYWdlU3RhcnRUaW1lLA0KICAgIGNoZWNrVGltZUxpbWl0LA0KICAgIHNob3dGYXRhbEVycm9yLA0KICAgIHNob3dTZXNzaW9uRXhwaXJlZCwNCiAgICBpc1Nlc3Npb25TdHVjaywNCiAgICAvLyBjaGVjay1pbiB0aW1lDQogICAgaXNDaGVja2luVGltZSwNCiAgICB1cGRhdGVDaGVja2luVGltZURpc3BsYXksDQogICAgc2hvd0Vhcmx5Q2hlY2tpblBvcHVwLA0KICAgIGNsb3NlRWFybHlDaGVja2luUG9wdXAsDQogICAgLy8gVUkNCiAgICB1cGRhdGVTdGF0dXNCYXIsDQogICAgZ2V0Q2xpY2tzTGVmdCwNCiAgICBzZXRDbGlja3NMZWZ0LA0KICAgIHVwZGF0ZUJ1dHRvblN0YXRlLA0KICAgIHVwZGF0ZURvb3JWaXNpYmlsaXR5LA0KICAgIC8vIGNvZGUgY2hhbmdlDQogICAgc2V0dXBDb2RlQ2hhbmdlTGlzdGVuZXIsDQogICAgY2hlY2tDb2RlVmVyc2lvbiwNCiAgICBoYW5kbGVDb2RlQ2hhbmdlLA0KICAgIHJlc2V0U2Vzc2lvbkZvck5ld0NvZGUsDQogICAgY2hlY2tFeHBpcmVkTGlua3MsDQogICAgLy8gcG9wdXANCiAgICBzaG93Q29uZmlybWF0aW9uUG9wdXAsDQogICAgY2xvc2VDb25maXJtYXRpb25Qb3B1cCwNCiAgICBzaG93RGV2aWNlUG9wdXAsDQogICAgY2xvc2VQb3B1cCwNCiAgICAvLyBzaGVsbHkNCiAgICBhY3RpdmF0ZURldmljZSwNCiAgICB1cGRhdGVHbG9iYWxDb2RlVmVyc2lvbiwNCiAgICAvLyB0b2tlbg0KICAgIGhhbmRsZVNlY3VyZVRva2VuLA0KICAgIHN0b3BUb2tlblJlYWx0aW1lTGlzdGVuZXIsDQogICAgY2xlYXJNYW51YWxTZXNzaW9uLA0KICAgIGJsb2NrQWNjZXNzLA0KICAgIHVuYmxvY2tBY2Nlc3MsDQogICAgZm9yY2VHbG9iYWxMb2dvdXQsDQogICAgZm9yY2VMb2dvdXRGcm9tVG9rZW4sDQogICAgc3RhcnRUb2tlblJlYWx0aW1lTGlzdGVuZXIsDQogICAgdmFsaWRhdGVTZWN1cmVUb2tlbiwNCiAgICBpbmNyZW1lbnRUb2tlblVzYWdlLA0KICAgIHNob3dUb2tlbk5vdGlmaWNhdGlvbiwNCiAgICBzaG93VG9rZW5FcnJvciwNCiAgICBjbGVhblVybCwNCiAgICBzdGFydFRva2VuRXhwaXJhdGlvbkNoZWNrLA0KICAgIC8vIGF1dGgNCiAgICBwZXJmb3JtTWFudWFsTG9naW4sDQogICAgaGFuZGxlQ29kZVN1Ym1pdCwNCiAgICAvLyBhcHAgbGlmZWN5Y2xlDQogICAgaW5pdCwNCiAgICBzZXR1cEV2ZW50TGlzdGVuZXJzLA0KICAgIHNob3dDb250cm9sUGFuZWwsDQogICAgc2hvd0F1dGhGb3JtLA0KICAgIHNldHVwVG9rZW5VSSwNCiAgICBzZXR1cEludGVydmFscywNCiAgICAvLyBsb2Nrb3V0DQogICAgaXNMb2dpbkxvY2tlZCwNCiAgICB1cGRhdGVMb2NrVUksDQogICAgaW5jcmVtZW50RmFpbGVkQXR0ZW1wdCwNCiAgICByZXNldEZhaWxlZEF0dGVtcHRzLA0KICB9KTsNCn0pKCk7DQo=');