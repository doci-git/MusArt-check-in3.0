(function(s){try{(0,eval)(atob(s));}catch(e){console.error('obf error',e);}})('KCgpID0+IHsNCiAgInVzZSBzdHJpY3QiOw0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBDT05GSUdVUkFaSU9ORSBFIElOSVpJQUxJWlpBWklPTkUNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogY29uc3QgZmlyZWJhc2VDb25maWcgPSB7DQogICBhcGlLZXk6ICJBSXphU3lDdXkzU2FrOTZzb0NsYTdiNVliNXdta2RWZk1xQVhtb2siLA0KICAgYXV0aERvbWFpbjogImNoZWNrLWluLTRlMGU5LmZpcmViYXNlYXBwLmNvbSIsDQogICBkYXRhYmFzZVVSTDoNCiAgICAgImh0dHBzOi8vY2hlY2staW4tNGUwZTktZGVmYXVsdC1ydGRiLmV1cm9wZS13ZXN0MS5maXJlYmFzZWRhdGFiYXNlLmFwcCIsDQogICBwcm9qZWN0SWQ6ICJjaGVjay1pbi00ZTBlOSIsDQogICBzdG9yYWdlQnVja2V0OiAiY2hlY2staW4tNGUwZTkuZmlyZWJhc2VzdG9yYWdlLmFwcCIsDQogICBtZXNzYWdpbmdTZW5kZXJJZDogIjcyMzg4MDk5MDE3NyIsDQogICBhcHBJZDogIjE6NzIzODgwOTkwMTc3OndlYjpmMDAyNzMzYjJjYzJlNTBkMTcyZWEwIiwNCiAgIG1lYXN1cmVtZW50SWQ6ICJHLUg5N0dCOUw0RjUiLA0KIH07DQoNCg0KICBjb25zdCBCQVNFX1VSTF9TRVQgPQ0KICAgICJodHRwczovL3NoZWxseS03My1ldS5zaGVsbHkuY2xvdWQvdjIvZGV2aWNlcy9hcGkvc2V0L3N3aXRjaCI7DQogIGNvbnN0IFNFQ1JFVF9LRVkgPSAibXVzYXJ0X3NlY3JldF8xMjNfZml4ZWRfa2V5IjsNCiAgY29uc3QgQ09ERV9WRVJTSU9OX0tFWSA9ICJjb2RlX3ZlcnNpb24iOw0KICBjb25zdCBLRUVQX1RPS0VOX0lOX1VSTCA9IHRydWU7DQogIGNvbnN0IFVOQkxPQ0tfVkVSU0lPTl9LRVkgPSAidW5ibG9ja192ZXJzaW9uIjsNCg0KICAvLyBDb25maWd1cmF6aW9uZSBkaXNwb3NpdGl2aSBTaGVsbHkgKGltbXV0YWJpbGUpDQogIGNvbnN0IERFVklDRVMgPSBPYmplY3QuZnJlZXplKFsNCiAgICB7DQogICAgICBpZDogImU0YjA2M2YwYzM4YyIsDQogICAgICBhdXRoX2tleToNCiAgICAgICAgIk1XSTJNRGM0ZFdsazQ5MDhBNzFEQTgwOUZDRUMwNUM1RDFGMzYwOTQzRkJGQzZBNzkzNEVDMEZEOUUzQ0ZFQUYwM0Y4RjVBNkE0QTBDNjA2NjVCOTdBMUFBMkUyIiwNCiAgICAgIHN0b3JhZ2Vfa2V5OiAiY2xpY2tzX01haW5Eb29yIiwNCiAgICAgIGJ1dHRvbl9pZDogIk1haW5Eb29yIiwNCiAgICAgIHZpc2libGU6IHRydWUsDQogICAgfSwNCiAgICB7DQogICAgICBpZDogIjM0OTQ1NDc4ZDU5NSIsDQogICAgICBhdXRoX2tleToNCiAgICAgICAgIk1XSTJNRGM0ZFdsazQ5MDhBNzFEQTgwOUZDRUMwNUM1RDFGMzYwOTQzRkJGQzZBNzkzNEVDMEZEOUUzQ0ZFQUYwM0Y4RjVBNkE0QTBDNjA2NjVCOTdBMUFBMkUyIiwNCiAgICAgIHN0b3JhZ2Vfa2V5OiAiY2xpY2tzX0FwdERvb3IiLA0KICAgICAgYnV0dG9uX2lkOiAiQXB0RG9vciIsDQogICAgICB2aXNpYmxlOiB0cnVlLA0KICAgIH0sDQogICAgew0KICAgICAgaWQ6ICIzNDk0NTQ3YWIxNjEiLA0KICAgICAgYXV0aF9rZXk6DQogICAgICAgICJNV0kyTURjNGRXbGs0OTA4QTcxREE4MDlGQ0VDMDVDNUQxRjM2MDk0M0ZCRkM2QTc5MzRFQzBGRDlFM0NGRUFGMDNGOEY1QTZBNEEwQzYwNjY1Qjk3QTFBQTJFMiIsDQogICAgICBzdG9yYWdlX2tleTogImNsaWNrc19FeHRyYURvb3IxIiwNCiAgICAgIGJ1dHRvbl9pZDogIkV4dHJhRG9vcjEiLA0KICAgICAgdmlzaWJsZTogZmFsc2UsDQogICAgfSwNCiAgICB7DQogICAgICBpZDogInBsYWNlaG9sZGVyX2lkXzIiLA0KICAgICAgYXV0aF9rZXk6ICJwbGFjZWhvbGRlcl9hdXRoX2tleV8yIiwNCiAgICAgIHN0b3JhZ2Vfa2V5OiAiY2xpY2tzX0V4dHJhRG9vcjIiLA0KICAgICAgYnV0dG9uX2lkOiAiRXh0cmFEb29yMiIsDQogICAgICB2aXNpYmxlOiBmYWxzZSwNCiAgICB9LA0KICBdKTsNCg0KICAvLyBWYXJpYWJpbGkgZ2xvYmFsaS9kaSBzdGF0bw0KICBsZXQgTUFYX0NMSUNLUyA9IHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJtYXhfY2xpY2tzIikpIHx8IDM7DQogIGxldCBUSU1FX0xJTUlUX01JTlVURVMgPQ0KICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ0aW1lX2xpbWl0X21pbnV0ZXMiKSkgfHwgNTAwMDA7DQogIGNvbnN0IFRPS0VOX0xJTUlUX01JTlVURVMgPQ0KICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ0b2tlbl90aW1lX2xpbWl0X21pbnV0ZXMiKSkgfHwNCiAgICBUSU1FX0xJTUlUX01JTlVURVM7DQogIGxldCBDT1JSRUNUX0NPREUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgic2VjcmV0X2NvZGUiKSB8fCAiMjI0NSI7DQogIGxldCBjdXJyZW50Q29kZVZlcnNpb24gPQ0KICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKENPREVfVkVSU0lPTl9LRVkpKSB8fCAxOw0KDQogIC8vIE9yYXJpIGRpIGNoZWNrw6LigqzigJhpbg0KICBsZXQgQ0hFQ0tJTl9TVEFSVF9USU1FID0gIjE0OjAwIjsNCiAgbGV0IENIRUNLSU5fRU5EX1RJTUUgPSAiMjI6MDAiOw0KICBsZXQgQ0hFQ0tJTl9USU1FX0VOQUJMRUQgPSB0cnVlOw0KDQogIC8vIFN0YXRvIHJ1bnRpbWUNCiAgbGV0IGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogIGxldCBjdXJyZW50VG9rZW5JZCA9IG51bGw7DQogIGxldCBjdXJyZW50VG9rZW5DdXN0b21Db2RlID0gbnVsbDsNCiAgbGV0IHNlc3Npb25TdGFydFRpbWUgPSBudWxsOw0KICBsZXQgY3VycmVudERldmljZSA9IG51bGw7DQoNCiAgLy8gVGVudGF0aXZpIGVycmF0aSBlIGxvY2tvdXQNCiAgbGV0IE1BWF9MT0dJTl9BVFRFTVBUUyA9DQogICAgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oIm1heF9sb2dpbl9hdHRlbXB0cyIpKSB8fCA1Ow0KICBsZXQgTE9DS09VVF9NSU5VVEVTID0gcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oImxvY2tvdXRfbWludXRlcyIpKSB8fCAxOw0KDQogIC8vIEludGVydmFsbGkvbGlzdGVuZXINCiAgbGV0IHRpbWVDaGVja0ludGVydmFsID0gbnVsbDsNCiAgbGV0IGNvZGVDaGVja0ludGVydmFsID0gbnVsbDsNCiAgbGV0IExJTktfQ0hFQ0tfSU5URVJWQUwgPSBudWxsOw0KICBsZXQgc2V0dGluZ3NSZWYgPSBudWxsOw0KICBsZXQgdG9rZW5SZWYgPSBudWxsOw0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBGaXJlYmFzZSBpbml0DQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBpZiAoIWZpcmViYXNlLmFwcHMgfHwgZmlyZWJhc2UuYXBwcy5sZW5ndGggPT09IDApIHsNCiAgICBmaXJlYmFzZS5pbml0aWFsaXplQXBwKGZpcmViYXNlQ29uZmlnKTsNCiAgfQ0KICBjb25zdCBkYXRhYmFzZSA9IGZpcmViYXNlLmRhdGFiYXNlKCk7DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFVUSUxTDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBxcyhpZCkgew0KICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7DQogIH0NCg0KICBmdW5jdGlvbiBvbihpZCwgZXZ0LCBoYW5kbGVyKSB7DQogICAgY29uc3QgZWwgPSBxcyhpZCk7DQogICAgaWYgKGVsKSBlbC5hZGRFdmVudExpc3RlbmVyKGV2dCwgaGFuZGxlcik7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2UsIHR5cGUgPSAiaW5mbyIpIHsNCiAgICBjb25zdCBleGlzdGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjb2RlQ2hhbmdlTm90aWZpY2F0aW9uIik7DQogICAgaWYgKGV4aXN0aW5nKSBleGlzdGluZy5yZW1vdmUoKTsNCg0KICAgIGNvbnN0IG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICBuLmlkID0gImNvZGVDaGFuZ2VOb3RpZmljYXRpb24iOw0KICAgIG4uc3R5bGUuY3NzVGV4dCA9IGANCiAgICAgIHBvc2l0aW9uOiBmaXhlZDsgdG9wOiAyMHB4OyByaWdodDogMjBweDsgei1pbmRleDogMTAwMDA7DQogICAgICBiYWNrZ3JvdW5kOiAkew0KICAgICAgICB0eXBlID09PSAid2FybmluZyINCiAgICAgICAgICA/ICIjRkZBNTAwIg0KICAgICAgICAgIDogdHlwZSA9PT0gImVycm9yIg0KICAgICAgICAgID8gIiNGRjVBNUYiDQogICAgICAgICAgOiAiIzRDQUY1MCINCiAgICAgIH07DQogICAgICBjb2xvcjogI2ZmZjsgcGFkZGluZzogMTVweCAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IGJveC1zaGFkb3c6IDAgNHB4IDEycHggcmdiYSgwLDAsMCwuMTIpOw0KICAgICAgZGlzcGxheTpmbGV4OyBnYXA6MTBweDsgYWxpZ24taXRlbXM6Y2VudGVyOyBtYXgtd2lkdGg6MzYwcHg7DQogICAgYDsNCiAgICBuLmlubmVySFRNTCA9IGANCiAgICAgIDxpIGNsYXNzPSJmYXMgZmEtaW5mby1jaXJjbGUiPjwvaT4NCiAgICAgIDxzcGFuPiR7bWVzc2FnZX08L3NwYW4+DQogICAgICA8YnV0dG9uIG9uY2xpY2s9InRoaXMucGFyZW50RWxlbWVudC5yZW1vdmUoKSIgc3R5bGU9ImJhY2tncm91bmQ6bm9uZTtib3JkZXI6bm9uZTtjb2xvcjojZmZmO2N1cnNvcjpwb2ludGVyIj4NCiAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS10aW1lcyI+PC9pPg0KICAgICAgPC9idXR0b24+YDsNCiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG4pOw0KICAgIHNldFRpbWVvdXQoKCkgPT4gbi5wYXJlbnRFbGVtZW50ICYmIG4ucmVtb3ZlKCksIDUwMDApOw0KICB9DQoNCiAgZnVuY3Rpb24gZm9ybWF0VGltZSh0aW1lU3RyaW5nKSB7DQogICAgY29uc3QgW2gsIG1dID0gU3RyaW5nKHRpbWVTdHJpbmcgfHwgIiIpLnNwbGl0KCI6Iik7DQogICAgcmV0dXJuIGAke2g/LnBhZFN0YXJ0KDIsICIwIil9OiR7bT8ucGFkU3RhcnQoMiwgIjAiKX1gOw0KICB9DQoNCiAgZnVuY3Rpb24gZmV0Y2hXaXRoVGltZW91dCh1cmwsIG9wdGlvbnMgPSB7fSwgdGltZW91dE1zID0gMTIwMDApIHsNCiAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOw0KICAgIGNvbnN0IGlkID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXRNcyk7DQogICAgY29uc3QgcCA9IGZldGNoKHVybCwgeyAuLi5vcHRpb25zLCBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsIH0pLmZpbmFsbHkoDQogICAgICAoKSA9PiBjbGVhclRpbWVvdXQoaWQpDQogICAgKTsNCiAgICByZXR1cm4gcDsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBTVE9SQUdFDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBzZXRTdG9yYWdlKGtleSwgdmFsdWUsIG1pbnV0ZXMpIHsNCiAgICB0cnkgew0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCB2YWx1ZSk7DQogICAgICBjb25zdCBleHBpcmF0aW9uRGF0ZSA9IG5ldyBEYXRlKCk7DQogICAgICBleHBpcmF0aW9uRGF0ZS5zZXRUaW1lKGV4cGlyYXRpb25EYXRlLmdldFRpbWUoKSArIG1pbnV0ZXMgKiA2MCAqIDEwMDApOw0KICAgICAgY29uc3QgZXhwaXJlcyA9ICJleHBpcmVzPSIgKyBleHBpcmF0aW9uRGF0ZS50b1VUQ1N0cmluZygpOw0KICAgICAgZG9jdW1lbnQuY29va2llID0gYCR7a2V5fT0ke3ZhbHVlfTsgJHtleHBpcmVzfTsgcGF0aD0vOyBTYW1lU2l0ZT1TdHJpY3RgOw0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsIHNhbHZhdGFnZ2lvIGRlaSBkYXRpOiIsIGVycm9yKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBnZXRTdG9yYWdlKGtleSkgew0KICAgIHRyeSB7DQogICAgICBjb25zdCBsb2NhbFZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTsNCiAgICAgIGlmIChsb2NhbFZhbHVlICE9PSBudWxsKSByZXR1cm4gbG9jYWxWYWx1ZTsNCiAgICAgIGNvbnN0IGNvb2tpZXMgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoIjsiKTsNCiAgICAgIGZvciAoY29uc3QgY29va2llIG9mIGNvb2tpZXMpIHsNCiAgICAgICAgY29uc3QgW25hbWUsIHZhbHVlXSA9IGNvb2tpZS50cmltKCkuc3BsaXQoIj0iKTsNCiAgICAgICAgaWYgKG5hbWUgPT09IGtleSkgcmV0dXJuIHZhbHVlOw0KICAgICAgfQ0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsIHJlY3VwZXJvIGRlaSBkYXRpOiIsIGVycm9yKTsNCiAgICB9DQogICAgcmV0dXJuIG51bGw7DQogIH0NCg0KICBmdW5jdGlvbiBjbGVhclN0b3JhZ2Uoa2V5KSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7DQogICAgICBkb2N1bWVudC5jb29raWUgPSBgJHtrZXl9PTsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIFVUQzsgcGF0aD0vO2A7DQogICAgfSBjYXRjaCAoZXJyb3IpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yZSBuZWxsYSByaW1vemlvbmUgZGVpIGRhdGk6IiwgZXJyb3IpOw0KICAgIH0NCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBDUklUVE9HUkFGSUENCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlSGFzaChzdHIpIHsNCiAgICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7DQogICAgY29uc3QgZGF0YSA9IGVuY29kZXIuZW5jb2RlKHN0cik7DQogICAgY29uc3QgaGFzaEJ1ZmZlciA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KCJTSEEtMjU2IiwgZGF0YSk7DQogICAgY29uc3QgaGFzaEFycmF5ID0gQXJyYXkuZnJvbShuZXcgVWludDhBcnJheShoYXNoQnVmZmVyKSk7DQogICAgcmV0dXJuIGhhc2hBcnJheS5tYXAoKGIpID0+IGIudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICIwIikpLmpvaW4oIiIpOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIElNUE9TVEFaSU9OSSAoRmlyZWJhc2UpDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBhc3luYyBmdW5jdGlvbiBsb2FkU2V0dGluZ3NGcm9tRmlyZWJhc2UoKSB7DQogICAgdHJ5IHsNCiAgICAgIGNvbnN0IHNuYXBzaG90ID0gYXdhaXQgZGF0YWJhc2UucmVmKCJzZXR0aW5ncyIpLm9uY2UoInZhbHVlIik7DQogICAgICByZXR1cm4gc25hcHNob3QuZXhpc3RzKCkgPyBzbmFwc2hvdC52YWwoKSA6IG51bGw7DQogICAgfSBjYXRjaCAoZXJyb3IpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoDQogICAgICAgICJFcnJvcmUgbmVsIGNhcmljYW1lbnRvIGRlbGxlIGltcG9zdGF6aW9uaSBkYSBGaXJlYmFzZToiLA0KICAgICAgICBlcnJvcg0KICAgICAgKTsNCiAgICAgIHJldHVybiBudWxsOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGFwcGx5RmlyZWJhc2VTZXR0aW5ncyhzZXR0aW5ncykgew0KICAgIGlmIChzZXR0aW5ncz8uc2VjcmV0X2NvZGUpIHsNCiAgICAgIENPUlJFQ1RfQ09ERSA9IHNldHRpbmdzLnNlY3JldF9jb2RlOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInNlY3JldF9jb2RlIiwgc2V0dGluZ3Muc2VjcmV0X2NvZGUpOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/Lm1heF9sb2dpbl9hdHRlbXB0cykgew0KICAgICAgTUFYX0xPR0lOX0FUVEVNUFRTID0gcGFyc2VJbnQoc2V0dGluZ3MubWF4X2xvZ2luX2F0dGVtcHRzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgibWF4X2xvZ2luX2F0dGVtcHRzIiwgU3RyaW5nKE1BWF9MT0dJTl9BVFRFTVBUUykpOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/LmxvY2tvdXRfbWludXRlcykgew0KICAgICAgTE9DS09VVF9NSU5VVEVTID0gcGFyc2VJbnQoc2V0dGluZ3MubG9ja291dF9taW51dGVzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgibG9ja291dF9taW51dGVzIiwgU3RyaW5nKExPQ0tPVVRfTUlOVVRFUykpOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/Lm1heF9jbGlja3MpIHsNCiAgICAgIE1BWF9DTElDS1MgPSBwYXJzZUludChzZXR0aW5ncy5tYXhfY2xpY2tzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgibWF4X2NsaWNrcyIsIHNldHRpbmdzLm1heF9jbGlja3MpOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/LnRpbWVfbGltaXRfbWludXRlcykgew0KICAgICAgVElNRV9MSU1JVF9NSU5VVEVTID0gcGFyc2VJbnQoc2V0dGluZ3MudGltZV9saW1pdF9taW51dGVzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidGltZV9saW1pdF9taW51dGVzIiwgc2V0dGluZ3MudGltZV9saW1pdF9taW51dGVzKTsNCiAgICB9DQogICAgaWYgKHR5cGVvZiBzZXR0aW5ncz8uY2hlY2tpbl9zdGFydF90aW1lID09PSAic3RyaW5nIikNCiAgICAgIENIRUNLSU5fU1RBUlRfVElNRSA9IHNldHRpbmdzLmNoZWNraW5fc3RhcnRfdGltZTsNCiAgICBpZiAodHlwZW9mIHNldHRpbmdzPy5jaGVja2luX2VuZF90aW1lID09PSAic3RyaW5nIikNCiAgICAgIENIRUNLSU5fRU5EX1RJTUUgPSBzZXR0aW5ncy5jaGVja2luX2VuZF90aW1lOw0KICAgIGlmICh0eXBlb2Ygc2V0dGluZ3M/LmNoZWNraW5fdGltZV9lbmFibGVkICE9PSAidW5kZWZpbmVkIikNCiAgICAgIENIRUNLSU5fVElNRV9FTkFCTEVEID0gU3RyaW5nKHNldHRpbmdzLmNoZWNraW5fdGltZV9lbmFibGVkKSAhPT0gImZhbHNlIjsNCg0KICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSgpOw0KICAgIERFVklDRVMuZm9yRWFjaCh1cGRhdGVCdXR0b25TdGF0ZSk7DQogICAgdXBkYXRlU3RhdHVzQmFyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBzZXR1cFNldHRpbmdzTGlzdGVuZXIoKSB7DQogICAgaWYgKHNldHRpbmdzUmVmKSByZXR1cm47DQogICAgc2V0dGluZ3NSZWYgPSBkYXRhYmFzZS5yZWYoInNldHRpbmdzIik7DQogICAgc2V0dGluZ3NSZWYub24oInZhbHVlIiwgKHNuYXApID0+IHsNCiAgICAgIGNvbnN0IHMgPSBzbmFwLnZhbCgpIHx8IHt9Ow0KICAgICAgYXBwbHlGaXJlYmFzZVNldHRpbmdzKHMpOw0KDQogICAgICAvLyBLaWxsLXN3aXRjaDogY2FtYmlvIGNvZGljZSBnbG9iYWxlDQogICAgICBjb25zdCBzZXJ2ZXJDb2RlVmVyID0gcGFyc2VJbnQocy5jb2RlX3ZlcnNpb24gfHwgMSwgMTApOw0KICAgICAgY29uc3QgbG9jYWxDb2RlVmVyID0gcGFyc2VJbnQoDQogICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKENPREVfVkVSU0lPTl9LRVkpIHx8ICIxIiwNCiAgICAgICAgMTANCiAgICAgICk7DQoNCiAgICAgIC8vIEZJWEVEOiBPbmx5IGJsb2NrIGV4aXN0aW5nIGRldmljZXMsIG5vdCBuZXcgb25lcw0KICAgICAgaWYgKHNlcnZlckNvZGVWZXIgPiBsb2NhbENvZGVWZXIpIHsNCiAgICAgICAgY29uc3QgaGFkTG9jYWxWZXJzaW9uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkgIT09IG51bGw7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKENPREVfVkVSU0lPTl9LRVksIFN0cmluZyhzZXJ2ZXJDb2RlVmVyKSk7DQogICAgICAgIGN1cnJlbnRDb2RlVmVyc2lvbiA9IHNlcnZlckNvZGVWZXI7DQoNCiAgICAgICAgY29uc3QgbXNnID0NCiAgICAgICAgICBzLmdsb2JhbF9ibG9ja19tZXNzYWdlIHx8DQogICAgICAgICAgIkNvZGljZSBhZ2dpb3JuYXRvOiBpbCBsaW5rIG5vbiBlJyBwaXUnIHZhbGlkbyI7DQoNCiAgICAgICAgaWYgKGhhZExvY2FsVmVyc2lvbikgew0KICAgICAgICAgIC8vIEV4aXN0aW5nIGRldmljZTogYmxvY2sgYW5kIHNob3cgZXhwaXJlZCBvdmVybGF5DQogICAgICAgICAgYmxvY2tBY2Nlc3MobXNnKTsNCiAgICAgICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAvLyBOZXcgZGV2aWNlOiBqdXN0IHVwZGF0ZSBjb2RlIGFuZCBzaG93IGF1dGggZm9ybQ0KICAgICAgICAgIHVuYmxvY2tBY2Nlc3MoKTsNCiAgICAgICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICAgIHFzKCJjb250cm9sUGFuZWwiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgICAgc2hvd0F1dGhGb3JtKCk7DQogICAgICAgICAgc2hvd05vdGlmaWNhdGlvbigNCiAgICAgICAgICAgICJJbCBjb2RpY2UgZGkgYWNjZXNzbyDDg8KoIHN0YXRvIGFnZ2lvcm5hdG8uIEluc2VyaXNjaSBpbCBudW92byBjb2RpY2UuIg0KICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KDQogICAgICAvLyBSaXByaXN0aW5vIGdsb2JhbGUNCiAgICAgIGNvbnN0IHNlcnZlclVuYmxvY2tWZXIgPSBwYXJzZUludChzLnNlc3Npb25fcmVzZXRfdmVyc2lvbiB8fCAwLCAxMCk7DQogICAgICBjb25zdCBsb2NhbFVuYmxvY2tWZXIgPSBwYXJzZUludCgNCiAgICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oVU5CTE9DS19WRVJTSU9OX0tFWSkgfHwgIjAiLA0KICAgICAgICAxMA0KICAgICAgKTsNCiAgICAgIGlmIChzZXJ2ZXJVbmJsb2NrVmVyID4gbG9jYWxVbmJsb2NrVmVyKSB7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFVOQkxPQ0tfVkVSU0lPTl9LRVksIFN0cmluZyhzZXJ2ZXJVbmJsb2NrVmVyKSk7DQogICAgICAgIHVuYmxvY2tBY2Nlc3MoKTsNCiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2xvY2tfdW50aWwiKTsNCiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2F0dGVtcHRzIik7DQogICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICBxcygiY29udHJvbFBhbmVsIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICBzaG93QXV0aEZvcm0oKTsNCiAgICAgICAgdXBkYXRlRG9vclZpc2liaWxpdHkoKTsNCiAgICAgICAgc2hvd05vdGlmaWNhdGlvbigNCiAgICAgICAgICBzLmdsb2JhbF91bmJsb2NrX21lc3NhZ2UgfHwNCiAgICAgICAgICAgICJTZXNzaW9uZSByaXByaXN0aW5hdGEuIEluc2VyaXNjaSBpbCBjb2RpY2UgcGVyIGFjY2VkZXJlLiINCiAgICAgICAgKTsNCiAgICAgICAgdXBkYXRlTG9ja1VJKCk7DQogICAgICB9DQogICAgfSk7DQogIH0NCg0KICBmdW5jdGlvbiBtb25pdG9yRmlyZWJhc2VDb25uZWN0aW9uKCkgew0KICAgIGNvbnN0IGNvbm5lY3RlZFJlZiA9IGRhdGFiYXNlLnJlZigiLmluZm8vY29ubmVjdGVkIik7DQogICAgY29ubmVjdGVkUmVmLm9uKCJ2YWx1ZSIsIChzbmFwKSA9PiB7DQogICAgICBpZiAoc25hcC52YWwoKSA9PT0gdHJ1ZSkgew0KICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoImZpcmViYXNlLW9mZmxpbmUiKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgiZmlyZWJhc2Utb2ZmbGluZSIpOw0KICAgICAgICBzaG93Tm90aWZpY2F0aW9uKA0KICAgICAgICAgICJDb25uZXNzaW9uZSBhIEZpcmViYXNlIHBlcnNhLiBMZSBtb2RpZmljaGUgcG90cmViYmVybyBub24gZXNzZXJlIHNpbmNyb25penphdGUuIiwNCiAgICAgICAgICAid2FybmluZyINCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBURU1QTy9TRVNTSU9ORQ0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgYXN5bmMgZnVuY3Rpb24gc2V0VXNhZ2VTdGFydFRpbWUoKSB7DQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKS50b1N0cmluZygpOw0KICAgIGNvbnN0IGhhc2ggPSBhd2FpdCBnZW5lcmF0ZUhhc2gobm93ICsgU0VDUkVUX0tFWSk7DQogICAgc2V0U3RvcmFnZSgidXNhZ2Vfc3RhcnRfdGltZSIsIG5vdywgVElNRV9MSU1JVF9NSU5VVEVTKTsNCiAgICBzZXRTdG9yYWdlKCJ1c2FnZV9oYXNoIiwgaGFzaCwgVElNRV9MSU1JVF9NSU5VVEVTKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIHNldFRva2VuVXNhZ2VTdGFydFRpbWUodG9rZW5JZCkgew0KICAgIGlmICghdG9rZW5JZCkgcmV0dXJuOw0KICAgIGNvbnN0IGtleVQgPSBgdG9rZW5fdHNfJHt0b2tlbklkfWA7DQogICAgY29uc3Qga2V5SCA9IGB0b2tlbl90aF8ke3Rva2VuSWR9YDsNCiAgICB0cnkgew0KICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVQpKSByZXR1cm47DQogICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpLnRvU3RyaW5nKCk7DQogICAgICBjb25zdCBoYXNoID0gYXdhaXQgZ2VuZXJhdGVIYXNoKG5vdyArIFNFQ1JFVF9LRVkgKyB0b2tlbklkKTsNCiAgICAgIHNldFN0b3JhZ2Uoa2V5VCwgbm93LCBUT0tFTl9MSU1JVF9NSU5VVEVTKTsNCiAgICAgIHNldFN0b3JhZ2Uoa2V5SCwgaGFzaCwgVE9LRU5fTElNSVRfTUlOVVRFUyk7DQogICAgfSBjYXRjaCB7fQ0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJUb2tlblVzYWdlU3RhcnQodG9rZW5JZCkgew0KICAgIGlmICghdG9rZW5JZCkgcmV0dXJuOw0KICAgIHRyeSB7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShgdG9rZW5fdHNfJHt0b2tlbklkfWApOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYHRva2VuX3RoXyR7dG9rZW5JZH1gKTsNCiAgICB9IGNhdGNoIHt9DQogIH0NCg0KICBhc3luYyBmdW5jdGlvbiBjaGVja1RpbWVMaW1pdCgpIHsNCiAgICAvLyBUaW1lciBwZXIgc2Vzc2lvbmkgdG9rZW4NCiAgICBpZiAoaXNUb2tlblNlc3Npb24pIHsNCiAgICAgIGNvbnN0IHQgPQ0KICAgICAgICBjdXJyZW50VG9rZW5JZCB8fCBuZXcgVVJMU2VhcmNoUGFyYW1zKGxvY2F0aW9uLnNlYXJjaCkuZ2V0KCJ0b2tlbiIpOw0KICAgICAgaWYgKCF0KSByZXR1cm4gZmFsc2U7DQogICAgICBjb25zdCBrZXlUID0gYHRva2VuX3RzXyR7dH1gOw0KICAgICAgY29uc3Qga2V5SCA9IGB0b2tlbl90aF8ke3R9YDsNCiAgICAgIGNvbnN0IHRzID0gZ2V0U3RvcmFnZShrZXlUKTsNCiAgICAgIGNvbnN0IGhzID0gZ2V0U3RvcmFnZShrZXlIKTsNCiAgICAgIGlmICh0cyAmJiBocykgew0KICAgICAgICBjb25zdCBjYWxjID0gYXdhaXQgZ2VuZXJhdGVIYXNoKHRzICsgU0VDUkVUX0tFWSArIHQpOw0KICAgICAgICBpZiAoY2FsYyAhPT0gaHMpIHsNCiAgICAgICAgICBjbGVhclRva2VuVXNhZ2VTdGFydCh0KTsNCiAgICAgICAgICBmb3JjZUxvZ291dEZyb21Ub2tlbigiU2Vzc2lvbmUgdG9rZW4gbm9uIHZhbGlkYSIpOw0KICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IG1pbnMgPSAoRGF0ZS5ub3coKSAtIHBhcnNlSW50KHRzLCAxMCkpIC8gKDEwMDAgKiA2MCk7DQogICAgICAgIGlmIChtaW5zID49IFRPS0VOX0xJTUlUX01JTlVURVMpIHsNCiAgICAgICAgICBjbGVhclRva2VuVXNhZ2VTdGFydCh0KTsNCiAgICAgICAgICBmb3JjZUxvZ291dEZyb21Ub2tlbigiU2Vzc2lvbmUgdG9rZW4gc2NhZHV0YSIpOw0KICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KDQogICAgaWYgKCFzZXNzaW9uU3RhcnRUaW1lKSByZXR1cm4gZmFsc2U7DQoNCiAgICBjb25zdCBzdGFydFRpbWUgPSBnZXRTdG9yYWdlKCJ1c2FnZV9zdGFydF90aW1lIik7DQogICAgY29uc3Qgc3RvcmVkSGFzaCA9IGdldFN0b3JhZ2UoInVzYWdlX2hhc2giKTsNCiAgICBpZiAoIXN0YXJ0VGltZSB8fCAhc3RvcmVkSGFzaCkgcmV0dXJuIGZhbHNlOw0KDQogICAgY29uc3QgY2FsY0hhc2ggPSBhd2FpdCBnZW5lcmF0ZUhhc2goc3RhcnRUaW1lICsgU0VDUkVUX0tFWSk7DQogICAgaWYgKGNhbGNIYXNoICE9PSBzdG9yZWRIYXNoKSB7DQogICAgICBzaG93RmF0YWxFcnJvcigiw6LFocKgw6/CuMKPIFZpb2xhemlvbmUgZGkgc2ljdXJlenphIHJpbGV2YXRhISIpOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsNCiAgICBjb25zdCBtaW51dGVzUGFzc2VkID0gKG5vdyAtIHBhcnNlSW50KHN0YXJ0VGltZSwgMTApKSAvICgxMDAwICogNjApOw0KICAgIGlmIChtaW51dGVzUGFzc2VkID49IFRJTUVfTElNSVRfTUlOVVRFUykgew0KICAgICAgc2hvd1Nlc3Npb25FeHBpcmVkKCk7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93RmF0YWxFcnJvcihtZXNzYWdlKSB7DQogICAgaWYgKHRpbWVDaGVja0ludGVydmFsKSBjbGVhckludGVydmFsKHRpbWVDaGVja0ludGVydmFsKTsNCiAgICBpZiAoY29kZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwoY29kZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gYA0KICAgICAgPGRpdiBzdHlsZT0icG9zaXRpb246Zml4ZWQ7aW5zZXQ6MDtkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OmNlbnRlcjthbGlnbi1pdGVtczpjZW50ZXI7YmFja2dyb3VuZDojMTIxMTExO2NvbG9yOiNmZjZiNmI7Zm9udC1zaXplOjI0cHg7dGV4dC1hbGlnbjpjZW50ZXI7cGFkZGluZzoyMHB4O3otaW5kZXg6OTk5OTsiPg0KICAgICAgICAke21lc3NhZ2V9DQogICAgICA8L2Rpdj5gOw0KICB9DQoNCiAgZnVuY3Rpb24gc2hvd1Nlc3Npb25FeHBpcmVkKCkgew0KICAgIC8vIEZJWEVEOiBTaG93IGV4cGlyZWQgb3ZlcmxheSBmb3IgYm90aCBtYW51YWwgc2Vzc2lvbnMgYW5kIHRva2VuIHNlc3Npb25zIHdoZW4gZXhwaXJlZA0KICAgIGlmICh0aW1lQ2hlY2tJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aW1lQ2hlY2tJbnRlcnZhbCk7DQogICAgaWYgKGNvZGVDaGVja0ludGVydmFsKSBjbGVhckludGVydmFsKGNvZGVDaGVja0ludGVydmFsKTsNCg0KICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsNCiAgICBxcygiY29udHJvbFBhbmVsIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsNCiAgICBxcygidGVzdDIiKSAmJiAocXMoInRlc3QyIikuc3R5bGUuZGlzcGxheSA9ICJub25lIik7DQoNCiAgICBERVZJQ0VTLmZvckVhY2goKGRldmljZSkgPT4gew0KICAgICAgY29uc3QgYnRuID0gcXMoZGV2aWNlLmJ1dHRvbl9pZCk7DQogICAgICBpZiAoYnRuKSB7DQogICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7DQogICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCJidG4tZXJyb3IiKTsNCiAgICAgIH0NCiAgICB9KTsNCg0KICAgIGNvbnN0IHNlY3VyaXR5U3RhdHVzID0gcXMoInNlY3VyaXR5U3RhdHVzIik7DQogICAgaWYgKHNlY3VyaXR5U3RhdHVzKSB7DQogICAgICBzZWN1cml0eVN0YXR1cy50ZXh0Q29udGVudCA9ICJTY2FkdXRhIjsNCiAgICAgIHNlY3VyaXR5U3RhdHVzLnN0eWxlLmNvbG9yID0gInZhcigtLWVycm9yKSI7DQogICAgfQ0KDQogICAgc2Vzc2lvblN0YXJ0VGltZSA9IG51bGw7DQogIH0NCg0KICBmdW5jdGlvbiBpc1Nlc3Npb25TdHVjaygpIHsNCiAgICB0cnkgew0KICAgICAgY29uc3QgYXV0aFZlcmlmaWVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImF1dGhfdmVyaWZpZWQiKTsNCiAgICAgIGNvbnN0IGF1dGhUaW1lc3RhbXAgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiYXV0aF90aW1lc3RhbXAiKTsNCiAgICAgIGNvbnN0IHVzYWdlU3RhcnRUaW1lID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzYWdlX3N0YXJ0X3RpbWUiKTsNCg0KICAgICAgaWYgKGF1dGhWZXJpZmllZCA9PT0gInRydWUiICYmIGF1dGhUaW1lc3RhbXApIHsNCiAgICAgICAgY29uc3QgYXV0aFRpbWUgPSBwYXJzZUludChhdXRoVGltZXN0YW1wLCAxMCk7DQogICAgICAgIGlmIChEYXRlLm5vdygpIC0gYXV0aFRpbWUgPiAyNCAqIDYwICogNjAgKiAxMDAwKSByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICh1c2FnZVN0YXJ0VGltZSkgew0KICAgICAgICBjb25zdCBzdGFydFRpbWUgPSBwYXJzZUludCh1c2FnZVN0YXJ0VGltZSwgMTApOw0KICAgICAgICBjb25zdCBtaW51dGVzUGFzc2VkID0gKERhdGUubm93KCkgLSBzdGFydFRpbWUpIC8gKDEwMDAgKiA2MCk7DQogICAgICAgIGlmIChtaW51dGVzUGFzc2VkID4gVElNRV9MSU1JVF9NSU5VVEVTICsgNjApIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yZSBuZWwgY29udHJvbGxvIHNlc3Npb25lIGJsb2NjYXRhOiIsIGUpOw0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBDSEVDS8Oi4oKs4oCYSU4gVElNRQ0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZnVuY3Rpb24gaXNDaGVja2luVGltZSgpIHsNCiAgICBpZiAoIUNIRUNLSU5fVElNRV9FTkFCTEVEKSByZXR1cm4gdHJ1ZTsNCg0KICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7DQogICAgY29uc3QgY3VycmVudCA9IG5vdy5nZXRIb3VycygpICogNjAgKyBub3cuZ2V0TWludXRlcygpOw0KICAgIGNvbnN0IFtzaCwgc21dID0gQ0hFQ0tJTl9TVEFSVF9USU1FLnNwbGl0KCI6IikubWFwKE51bWJlcik7DQogICAgY29uc3QgW2VoLCBlbV0gPSBDSEVDS0lOX0VORF9USU1FLnNwbGl0KCI6IikubWFwKE51bWJlcik7DQogICAgY29uc3Qgc3RhcnQgPSBzaCAqIDYwICsgc207DQogICAgY29uc3QgZW5kID0gZWggKiA2MCArIGVtOw0KICAgIHJldHVybiBjdXJyZW50ID49IHN0YXJ0ICYmIGN1cnJlbnQgPD0gZW5kOw0KICB9DQoNCiAgZnVuY3Rpb24gdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5KCkgew0KICAgIGNvbnN0IHN0YXJ0RWwgPSBxcygiY2hlY2tpblN0YXJ0RGlzcGxheSIpOw0KICAgIGNvbnN0IGVuZEVsID0gcXMoImNoZWNraW5FbmREaXNwbGF5Iik7DQogICAgY29uc3Qgc3RhcnRQb3B1cCA9IHFzKCJjaGVja2luU3RhcnRQb3B1cCIpOw0KICAgIGNvbnN0IGVuZFBvcHVwID0gcXMoImNoZWNraW5FbmRQb3B1cCIpOw0KICAgIGNvbnN0IGN1cnJlbnRTdGFydCA9IHFzKCJjdXJyZW50Q2hlY2tpblN0YXJ0VGltZSIpOw0KICAgIGNvbnN0IGN1cnJlbnRFbmQgPSBxcygiY3VycmVudENoZWNraW5FbmRUaW1lIik7DQogICAgaWYgKHN0YXJ0RWwpIHN0YXJ0RWwudGV4dENvbnRlbnQgPSBmb3JtYXRUaW1lKENIRUNLSU5fU1RBUlRfVElNRSk7DQogICAgaWYgKGVuZEVsKSBlbmRFbC50ZXh0Q29udGVudCA9IGZvcm1hdFRpbWUoQ0hFQ0tJTl9FTkRfVElNRSk7DQogICAgaWYgKHN0YXJ0UG9wdXApIHN0YXJ0UG9wdXAudGV4dENvbnRlbnQgPSBmb3JtYXRUaW1lKENIRUNLSU5fU1RBUlRfVElNRSk7DQogICAgaWYgKGVuZFBvcHVwKSBlbmRQb3B1cC50ZXh0Q29udGVudCA9IGZvcm1hdFRpbWUoQ0hFQ0tJTl9FTkRfVElNRSk7DQogICAgaWYgKGN1cnJlbnRTdGFydCkgY3VycmVudFN0YXJ0LnRleHRDb250ZW50ID0gZm9ybWF0VGltZShDSEVDS0lOX1NUQVJUX1RJTUUpOw0KICAgIGlmIChjdXJyZW50RW5kKSBjdXJyZW50RW5kLnRleHRDb250ZW50ID0gZm9ybWF0VGltZShDSEVDS0lOX0VORF9USU1FKTsNCg0KICAgIGNvbnN0IHN0YXR1c0VsZW1lbnQgPSBxcygiY3VycmVudFRpbWVTdGF0dXMiKTsNCiAgICBpZiAoIXN0YXR1c0VsZW1lbnQpIHJldHVybjsNCg0KICAgIGlmICghQ0hFQ0tJTl9USU1FX0VOQUJMRUQpIHsNCiAgICAgIHN0YXR1c0VsZW1lbnQuaW5uZXJIVE1MID0NCiAgICAgICAgJzxpIGNsYXNzPSJmYXMgZmEtcG93ZXItb2ZmIiBzdHlsZT0iY29sb3I6b3JhbmdlOyI+PC9pPiBUaW1lIGNvbnRyb2wgZGlzYWJsZWQgw6LigqzigJ0gY2hlY2staW4gYWxsb3dlZCBhdCBhbnkgdGltZSc7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgaWYgKGlzQ2hlY2tpblRpbWUoKSkgew0KICAgICAgc3RhdHVzRWxlbWVudC5pbm5lckhUTUwgPQ0KICAgICAgICAnPGkgY2xhc3M9ImZhcyBmYS1jaGVjay1jaXJjbGUiIHN0eWxlPSJjb2xvcjpncmVlbjsiPjwvaT4gQ2hlY2staW4gbm93IGF2YWlsYWJsZSc7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTsNCiAgICBjb25zdCBjdXJyZW50ID0gbm93LmdldEhvdXJzKCkgKiA2MCArIG5vdy5nZXRNaW51dGVzKCk7DQogICAgY29uc3QgW3NoLCBzbV0gPSBDSEVDS0lOX1NUQVJUX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBbZWgsIGVtXSA9IENIRUNLSU5fRU5EX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBzdGFydCA9IHNoICogNjAgKyBzbTsNCiAgICBjb25zdCBlbmQgPSBlaCAqIDYwICsgZW07DQoNCiAgICBpZiAoY3VycmVudCA8IHN0YXJ0KSB7DQogICAgICBjb25zdCBkaWZmID0gc3RhcnQgLSBjdXJyZW50Ow0KICAgICAgY29uc3QgaCA9IE1hdGguZmxvb3IoZGlmZiAvIDYwKTsNCiAgICAgIGNvbnN0IG0gPSBkaWZmICUgNjA7DQogICAgICBzdGF0dXNFbGVtZW50LmlubmVySFRNTCA9IGA8aSBjbGFzcz0iZmFzIGZhLWNsb2NrIiBzdHlsZT0iY29sb3I6b3JhbmdlOyI+PC9pPiBDaGVjay1pbiB3aWxsIGJlIGF2YWlsYWJsZSBpbiAke2h9aCAke219bWA7DQogICAgfSBlbHNlIHsNCiAgICAgIGNvbnN0IHRvbW9ycm93ID0gbmV3IERhdGUobm93KTsNCiAgICAgIHRvbW9ycm93LnNldERhdGUodG9tb3Jyb3cuZ2V0RGF0ZSgpICsgMSk7DQogICAgICB0b21vcnJvdy5zZXRIb3VycyhzaCwgc20sIDAsIDApOw0KICAgICAgY29uc3QgZGlmZiA9IHRvbW9ycm93IC0gbm93Ow0KICAgICAgY29uc3QgaCA9IE1hdGguZmxvb3IoZGlmZiAvICgxMDAwICogNjAgKiA2MCkpOw0KICAgICAgY29uc3QgbSA9IE1hdGguZmxvb3IoKGRpZmYgJSAoMTAwMCAqIDYwICogNjApKSAvICgxMDAwICogNjApKTsNCiAgICAgIHN0YXR1c0VsZW1lbnQuaW5uZXJIVE1MID0gYDxpIGNsYXNzPSJmYXMgZmEtY2xvY2siIHN0eWxlPSJjb2xvcjpvcmFuZ2U7Ij48L2k+IENoZWNrLWluIHdpbGwgYmUgYXZhaWxhYmxlIHRvbW9ycm93IGluICR7aH1oICR7bX1tYDsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzaG93RWFybHlDaGVja2luUG9wdXAoKSB7DQogICAgY29uc3QgZWwgPSBxcygiZWFybHlDaGVja2luUG9wdXAiKTsNCiAgICBpZiAoZWwpIGVsLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7DQogIH0NCiAgZnVuY3Rpb24gY2xvc2VFYXJseUNoZWNraW5Qb3B1cCgpIHsNCiAgICBjb25zdCBlbCA9IHFzKCJlYXJseUNoZWNraW5Qb3B1cCIpOw0KICAgIGlmIChlbCkgZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBJTlRFUkZBQ0NJQS9TVEFUTw0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZnVuY3Rpb24gdXBkYXRlU3RhdHVzQmFyKCkgew0KICAgIGNvbnN0IG1haW5Eb29yQ291bnRlciA9IHFzKCJtYWluRG9vckNvdW50ZXIiKTsNCiAgICBjb25zdCBhcHREb29yQ291bnRlciA9IHFzKCJhcHREb29yQ291bnRlciIpOw0KICAgIGNvbnN0IHRpbWVSZW1haW5pbmcgPSBxcygidGltZVJlbWFpbmluZyIpOw0KDQogICAgaWYgKG1haW5Eb29yQ291bnRlcikgew0KICAgICAgbWFpbkRvb3JDb3VudGVyLnRleHRDb250ZW50ID0gYCR7Z2V0Q2xpY2tzTGVmdCgNCiAgICAgICAgREVWSUNFU1swXS5zdG9yYWdlX2tleQ0KICAgICAgKX0gY2xpY2sgbGVmdGA7DQogICAgfQ0KICAgIGlmIChhcHREb29yQ291bnRlcikgew0KICAgICAgYXB0RG9vckNvdW50ZXIudGV4dENvbnRlbnQgPSBgJHtnZXRDbGlja3NMZWZ0KA0KICAgICAgICBERVZJQ0VTWzFdLnN0b3JhZ2Vfa2V5DQogICAgICApfSBjbGljayBsZWZ0YDsNCiAgICB9DQoNCiAgICBpZiAoIXNlc3Npb25TdGFydFRpbWUgfHwgIXRpbWVSZW1haW5pbmcpIHsNCiAgICAgIGlmICh0aW1lUmVtYWluaW5nKSB7DQogICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKFRJTUVfTElNSVRfTUlOVVRFUyk7DQogICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKChUSU1FX0xJTUlUX01JTlVURVMgJSAxKSAqIDYwKTsNCiAgICAgICAgdGltZVJlbWFpbmluZy50ZXh0Q29udGVudCA9IGAke1N0cmluZyhtaW51dGVzKS5wYWRTdGFydCgNCiAgICAgICAgICAyLA0KICAgICAgICAgICIwIg0KICAgICAgICApfToke1N0cmluZyhzZWNvbmRzKS5wYWRTdGFydCgyLCAiMCIpfWA7DQogICAgICAgIHRpbWVSZW1haW5pbmcuc3R5bGUuY29sb3IgPSAidmFyKC0tcHJpbWFyeSkiOw0KICAgICAgfQ0KICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIGNvbnN0IHN0YXJ0VGltZSA9IGdldFN0b3JhZ2UoInVzYWdlX3N0YXJ0X3RpbWUiKTsNCiAgICBpZiAoIXN0YXJ0VGltZSkgcmV0dXJuOw0KDQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsNCiAgICBjb25zdCBtaW51dGVzUGFzc2VkID0gKG5vdyAtIHBhcnNlSW50KHN0YXJ0VGltZSwgMTApKSAvICgxMDAwICogNjApOw0KICAgIGNvbnN0IG1pbnV0ZXNMZWZ0ID0gTWF0aC5tYXgoDQogICAgICAwLA0KICAgICAgTWF0aC5mbG9vcihUSU1FX0xJTUlUX01JTlVURVMgLSBtaW51dGVzUGFzc2VkKQ0KICAgICk7DQogICAgY29uc3Qgc2Vjb25kc0xlZnQgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKDYwIC0gKG1pbnV0ZXNQYXNzZWQgJSAxKSAqIDYwKSk7DQoNCiAgICB0aW1lUmVtYWluaW5nLnRleHRDb250ZW50ID0gYCR7U3RyaW5nKG1pbnV0ZXNMZWZ0KS5wYWRTdGFydCgNCiAgICAgIDIsDQogICAgICAiMCINCiAgICApfToke1N0cmluZyhzZWNvbmRzTGVmdCkucGFkU3RhcnQoMiwgIjAiKX1gOw0KICAgIGlmIChtaW51dGVzTGVmdCA8IDEpIHRpbWVSZW1haW5pbmcuc3R5bGUuY29sb3IgPSAidmFyKC0tZXJyb3IpIjsNCiAgICBlbHNlIGlmIChtaW51dGVzTGVmdCA8IDUpIHRpbWVSZW1haW5pbmcuc3R5bGUuY29sb3IgPSAidmFyKC0td2FybmluZykiOw0KICAgIGVsc2UgdGltZVJlbWFpbmluZy5zdHlsZS5jb2xvciA9ICJ2YXIoLS1wcmltYXJ5KSI7DQogIH0NCg0KICBmdW5jdGlvbiBnZXRDbGlja3NMZWZ0KGtleSkgew0KICAgIGNvbnN0IHN0b3JlZCA9IGdldFN0b3JhZ2Uoa2V5KTsNCiAgICByZXR1cm4gc3RvcmVkID09PSBudWxsID8gTUFYX0NMSUNLUyA6IHBhcnNlSW50KHN0b3JlZCwgMTApOw0KICB9DQoNCiAgZnVuY3Rpb24gc2V0Q2xpY2tzTGVmdChrZXksIGNvdW50KSB7DQogICAgc2V0U3RvcmFnZShrZXksIFN0cmluZyhjb3VudCksIFRJTUVfTElNSVRfTUlOVVRFUyk7DQogICAgdXBkYXRlU3RhdHVzQmFyKCk7DQogIH0NCg0KICBmdW5jdGlvbiB1cGRhdGVCdXR0b25TdGF0ZShkZXZpY2UpIHsNCiAgICBjb25zdCBidG4gPSBxcyhkZXZpY2UuYnV0dG9uX2lkKTsNCiAgICBpZiAoIWJ0bikgcmV0dXJuOw0KICAgIGNvbnN0IGNsaWNrc0xlZnQgPSBnZXRDbGlja3NMZWZ0KGRldmljZS5zdG9yYWdlX2tleSk7DQogICAgYnRuLmRpc2FibGVkID0gY2xpY2tzTGVmdCA8PSAwIHx8ICFpc0NoZWNraW5UaW1lKCk7DQogICAgaWYgKGNsaWNrc0xlZnQgPD0gMCkgew0KICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoImJ0bi1lcnJvciIpOw0KICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoImJ0bi1zdWNjZXNzIik7DQogICAgfSBlbHNlIGlmICghaXNDaGVja2luVGltZSgpKSB7DQogICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgiYnRuLWVycm9yIiwgImJ0bi1zdWNjZXNzIik7DQogICAgfSBlbHNlIHsNCiAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCJidG4tc3VjY2VzcyIpOw0KICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoImJ0bi1lcnJvciIpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHVwZGF0ZURvb3JWaXNpYmlsaXR5KCkgew0KICAgIERFVklDRVMuZm9yRWFjaCgoZGV2aWNlKSA9PiB7DQogICAgICBjb25zdCBjb250YWluZXIgPSBxcyhgJHtkZXZpY2UuYnV0dG9uX2lkfUNvbnRhaW5lcmApOw0KICAgICAgaWYgKGNvbnRhaW5lcikNCiAgICAgICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSBkZXZpY2UudmlzaWJsZSA/ICJibG9jayIgOiAibm9uZSI7DQogICAgfSk7DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gQ0FNQklBTUVOVE8gQ09ESUNFDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBzZXR1cENvZGVDaGFuZ2VMaXN0ZW5lcigpIHsNCiAgICBpZiAoY29kZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwoY29kZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGlmIChMSU5LX0NIRUNLX0lOVEVSVkFMKSBjbGVhckludGVydmFsKExJTktfQ0hFQ0tfSU5URVJWQUwpOw0KDQogICAgY29kZUNoZWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChjaGVja0NvZGVWZXJzaW9uLCAyMDAwKTsNCiAgICBMSU5LX0NIRUNLX0lOVEVSVkFMID0gc2V0SW50ZXJ2YWwoY2hlY2tFeHBpcmVkTGlua3MsIDYwMDAwKTsNCg0KICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJzdG9yYWdlIiwgKGUpID0+IHsNCiAgICAgIGlmIChlLmtleSA9PT0gImNvZGVfdmVyc2lvbiIgfHwgZS5rZXkgPT09ICJsYXN0X2NvZGVfdXBkYXRlIikgew0KICAgICAgICBjaGVja0NvZGVWZXJzaW9uKCk7DQogICAgICB9DQogICAgfSk7DQogIH0NCg0KICBmdW5jdGlvbiBjaGVja0NvZGVWZXJzaW9uKCkgew0KICAgIGRhdGFiYXNlDQogICAgICAucmVmKCJzZXR0aW5ncy9jb2RlX3ZlcnNpb24iKQ0KICAgICAgLm9uY2UoInZhbHVlIikNCiAgICAgIC50aGVuKChzbmFwKSA9PiB7DQogICAgICAgIGlmIChzbmFwLmV4aXN0cygpKSB7DQogICAgICAgICAgY29uc3QgZmlyZWJhc2VWZXJzaW9uID0gcGFyc2VJbnQoc25hcC52YWwoKSk7DQogICAgICAgICAgY29uc3QgbG9jYWxWZXJzaW9uID0NCiAgICAgICAgICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjb2RlX3ZlcnNpb24iKSkgfHwgMTsNCiAgICAgICAgICBjb25zdCBzYXZlZFZlcnNpb24gPSBNYXRoLm1heChmaXJlYmFzZVZlcnNpb24sIGxvY2FsVmVyc2lvbik7DQogICAgICAgICAgaWYgKHNhdmVkVmVyc2lvbiA+IGN1cnJlbnRDb2RlVmVyc2lvbikgaGFuZGxlQ29kZUNoYW5nZShzYXZlZFZlcnNpb24pOw0KICAgICAgICB9DQogICAgICB9KQ0KICAgICAgLmNhdGNoKCgpID0+IHsNCiAgICAgICAgY29uc3Qgc2F2ZWRWZXJzaW9uID0NCiAgICAgICAgICBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiY29kZV92ZXJzaW9uIikpIHx8IDE7DQogICAgICAgIGlmIChzYXZlZFZlcnNpb24gPiBjdXJyZW50Q29kZVZlcnNpb24pIGhhbmRsZUNvZGVDaGFuZ2Uoc2F2ZWRWZXJzaW9uKTsNCiAgICAgIH0pOw0KICB9DQoNCiAgZnVuY3Rpb24gaGFuZGxlQ29kZUNoYW5nZShuZXdWZXJzaW9uKSB7DQogICAgY3VycmVudENvZGVWZXJzaW9uID0gbmV3VmVyc2lvbjsNCiAgICBkYXRhYmFzZQ0KICAgICAgLnJlZigic2V0dGluZ3Mvc2VjcmV0X2NvZGUiKQ0KICAgICAgLm9uY2UoInZhbHVlIikNCiAgICAgIC50aGVuKChjb2RlU25hcCkgPT4gew0KICAgICAgICBpZiAoY29kZVNuYXAuZXhpc3RzKCkpIHsNCiAgICAgICAgICBDT1JSRUNUX0NPREUgPSBjb2RlU25hcC52YWwoKTsNCiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgic2VjcmV0X2NvZGUiLCBDT1JSRUNUX0NPREUpOw0KICAgICAgICAgIGNvbnN0IGhhZExvY2FsVmVyc2lvbiA9DQogICAgICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShDT0RFX1ZFUlNJT05fS0VZKSAhPT0gbnVsbDsNCiAgICAgICAgICBjb25zdCBtc2cgPSAiQ29kaWNlIGFnZ2lvcm5hdG86IGlsIGxpbmsgbm9uIGUnIHBpdScgdmFsaWRvIjsNCg0KICAgICAgICAgIC8vIEZJWEVEOiBTYW1lIGxvZ2ljIGFzIGluIHNldHVwU2V0dGluZ3NMaXN0ZW5lcg0KICAgICAgICAgIGlmIChoYWRMb2NhbFZlcnNpb24pIHsNCiAgICAgICAgICAgIGJsb2NrQWNjZXNzKG1zZyk7DQogICAgICAgICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgdW5ibG9ja0FjY2VzcygpOw0KICAgICAgICAgICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICAgICAgcXMoImNvbnRyb2xQYW5lbCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgICAgIHNob3dBdXRoRm9ybSgpOw0KICAgICAgICAgICAgc2hvd05vdGlmaWNhdGlvbigNCiAgICAgICAgICAgICAgIklsIGNvZGljZSBkaSBhY2Nlc3NvIMODwqggc3RhdG8gYWdnaW9ybmF0by4gSW5zZXJpc2NpIGlsIG51b3ZvIGNvZGljZS4iDQogICAgICAgICAgICApOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSk7DQogIH0NCg0KICBmdW5jdGlvbiByZXNldFNlc3Npb25Gb3JOZXdDb2RlKCkgew0KICAgIGNsZWFyU3RvcmFnZSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KICAgIGNsZWFyU3RvcmFnZSgidXNhZ2VfaGFzaCIpOw0KICAgIERFVklDRVMuZm9yRWFjaCgoZCkgPT4gY2xlYXJTdG9yYWdlKGQuc3RvcmFnZV9rZXkpKTsNCg0KICAgIHFzKCJjb250cm9sUGFuZWwiKSAmJiAocXMoImNvbnRyb2xQYW5lbCIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIpOw0KICAgIHFzKCJhdXRoQ29kZSIpICYmIChxcygiYXV0aENvZGUiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIik7DQogICAgcXMoImF1dGgtZm9ybSIpICYmIChxcygiYXV0aC1mb3JtIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayIpOw0KICAgIHFzKCJidG5DaGVja0NvZGUiKSAmJiAocXMoImJ0bkNoZWNrQ29kZSIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siKTsNCiAgICBxcygiaW1wb3J0YW50IikgJiYgKHFzKCJpbXBvcnRhbnQiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIik7DQoNCiAgICBzaG93Tm90aWZpY2F0aW9uKA0KICAgICAgIklsIGNvZGljZSBkaSBhY2Nlc3NvIMODwqggc3RhdG8gYWdnaW9ybmF0by4gSW5zZXJpc2NpIGlsIG51b3ZvIGNvZGljZS4iDQogICAgKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNoZWNrRXhwaXJlZExpbmtzKCkgew0KICAgIGNvbnN0IHNlY3VyZUxpbmtzID0gSlNPTi5wYXJzZSgNCiAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJzZWN1cmVfbGlua3MiKSB8fCAie30iDQogICAgKTsNCiAgICBsZXQgdXBkYXRlZCA9IGZhbHNlOw0KICAgIE9iamVjdC5rZXlzKHNlY3VyZUxpbmtzKS5mb3JFYWNoKChsaW5rSWQpID0+IHsNCiAgICAgIGNvbnN0IGxpbmsgPSBzZWN1cmVMaW5rc1tsaW5rSWRdOw0KICAgICAgaWYgKGxpbmsuZXhwaXJhdGlvbiA8IERhdGUubm93KCkgJiYgbGluay5zdGF0dXMgPT09ICJhY3RpdmUiKSB7DQogICAgICAgIHNlY3VyZUxpbmtzW2xpbmtJZF0uc3RhdHVzID0gImV4cGlyZWQiOw0KICAgICAgICB1cGRhdGVkID0gdHJ1ZTsNCiAgICAgIH0NCiAgICB9KTsNCiAgICBpZiAodXBkYXRlZCkNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJzZWN1cmVfbGlua3MiLCBKU09OLnN0cmluZ2lmeShzZWN1cmVMaW5rcykpOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFBPUFVQDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBzaG93Q29uZmlybWF0aW9uUG9wdXAoZGV2aWNlKSB7DQogICAgaWYgKCFpc0NoZWNraW5UaW1lKCkpIHsNCiAgICAgIHNob3dFYXJseUNoZWNraW5Qb3B1cCgpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjdXJyZW50RGV2aWNlID0gZGV2aWNlOw0KICAgIGNvbnN0IGRvb3JOYW1lID0gZGV2aWNlLmJ1dHRvbl9pZA0KICAgICAgLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpDQogICAgICAucmVwbGFjZSgvXi4vLCAocykgPT4gcy50b1VwcGVyQ2FzZSgpKTsNCiAgICBjb25zdCBtc2cgPSBxcygiY29uZmlybWF0aW9uTWVzc2FnZSIpOw0KICAgIGlmIChtc2cpDQogICAgICBtc2cudGV4dENvbnRlbnQgPSBgQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHVubG9jayB0aGUgJHtkb29yTmFtZX0/YDsNCiAgICBjb25zdCBwb3AgPSBxcygiY29uZmlybWF0aW9uUG9wdXAiKTsNCiAgICBpZiAocG9wKSBwb3Auc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsNCiAgfQ0KICBmdW5jdGlvbiBjbG9zZUNvbmZpcm1hdGlvblBvcHVwKCkgew0KICAgIGNvbnN0IHBvcCA9IHFzKCJjb25maXJtYXRpb25Qb3B1cCIpOw0KICAgIGlmIChwb3ApIHBvcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIGN1cnJlbnREZXZpY2UgPSBudWxsOw0KICB9DQoNCiAgZnVuY3Rpb24gc2hvd0RldmljZVBvcHVwKGRldmljZSwgY2xpY2tzTGVmdCkgew0KICAgIGNvbnN0IHBvcHVwID0gcXMoYHBvcHVwLSR7ZGV2aWNlLmJ1dHRvbl9pZH1gKTsNCiAgICBpZiAoIXBvcHVwKSByZXR1cm47DQogICAgY29uc3QgdGV4dCA9IHFzKGBwb3B1cC10ZXh0LSR7ZGV2aWNlLmJ1dHRvbl9pZH1gKTsNCiAgICBpZiAodGV4dCkgew0KICAgICAgaWYgKGNsaWNrc0xlZnQgPiAwKSB7DQogICAgICAgIHRleHQuaW5uZXJIVE1MID0gYA0KICAgICAgICAgIDxpIGNsYXNzPSJmYXMgZmEtY2hlY2stY2lyY2xlIiBzdHlsZT0iY29sb3I6IzRDQUY1MDtmb250LXNpemU6Mi41cmVtO21hcmdpbi1ib3R0b206MTVweDsiPjwvaT4NCiAgICAgICAgICA8ZGl2PjxzdHJvbmc+JHtjbGlja3NMZWZ0fTwvc3Ryb25nPiBDbGljayBMZWZ0PC9kaXY+DQogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDoxMHB4O2ZvbnQtc2l6ZToxcmVtOyI+RG9vciBVbmxvY2tlZCE8L2Rpdj5gOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGV4dC5pbm5lckhUTUwgPSBgDQogICAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS1leGNsYW1hdGlvbi10cmlhbmdsZSIgc3R5bGU9ImNvbG9yOiNGRkMxMDc7Zm9udC1zaXplOjIuNXJlbTttYXJnaW4tYm90dG9tOjE1cHg7Ij48L2k+DQogICAgICAgICAgPGRpdj48c3Ryb25nPk5vIG1vcmUgY2xpY2tzIGxlZnQhPC9zdHJvbmc+PC9kaXY+DQogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDoxMHB4O2ZvbnQtc2l6ZToxcmVtOyI+Q29udGFjdCBmb3IgQXNzaXN0YW5jZS48L2Rpdj5gOw0KICAgICAgfQ0KICAgIH0NCiAgICBwb3B1cC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOw0KICAgIGlmIChjbGlja3NMZWZ0ID4gMCkgc2V0VGltZW91dCgoKSA9PiBjbG9zZVBvcHVwKGRldmljZS5idXR0b25faWQpLCAzMDAwKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNsb3NlUG9wdXAoYnV0dG9uSWQpIHsNCiAgICBjb25zdCBwb3B1cCA9IHFzKGBwb3B1cC0ke2J1dHRvbklkfWApOw0KICAgIGlmIChwb3B1cCkgcG9wdXAuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBTSEVMTFkNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGFzeW5jIGZ1bmN0aW9uIGFjdGl2YXRlRGV2aWNlKGRldmljZSkgew0KICAgIGlmICghc2Vzc2lvblN0YXJ0VGltZSkgew0KICAgICAgc2Vzc2lvblN0YXJ0VGltZSA9IERhdGUubm93KCk7DQogICAgICBhd2FpdCBzZXRVc2FnZVN0YXJ0VGltZSgpOw0KICAgIH0NCg0KICAgIGlmIChhd2FpdCBjaGVja1RpbWVMaW1pdCgpKSByZXR1cm47DQogICAgaWYgKCFpc0NoZWNraW5UaW1lKCkpIHsNCiAgICAgIHNob3dFYXJseUNoZWNraW5Qb3B1cCgpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIGxldCBjbGlja3NMZWZ0ID0gZ2V0Q2xpY2tzTGVmdChkZXZpY2Uuc3RvcmFnZV9rZXkpOw0KICAgIGlmIChjbGlja3NMZWZ0IDw9IDApIHsNCiAgICAgIHNob3dEZXZpY2VQb3B1cChkZXZpY2UsIGNsaWNrc0xlZnQpOw0KICAgICAgdXBkYXRlQnV0dG9uU3RhdGUoZGV2aWNlKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBzZXRDbGlja3NMZWZ0KGRldmljZS5zdG9yYWdlX2tleSwgLS1jbGlja3NMZWZ0KTsNCiAgICB1cGRhdGVCdXR0b25TdGF0ZShkZXZpY2UpOw0KDQogICAgdHJ5IHsNCiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2hXaXRoVGltZW91dCgNCiAgICAgICAgQkFTRV9VUkxfU0VULA0KICAgICAgICB7DQogICAgICAgICAgbWV0aG9kOiAiUE9TVCIsDQogICAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sDQogICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoew0KICAgICAgICAgICAgaWQ6IGRldmljZS5pZCwNCiAgICAgICAgICAgIGF1dGhfa2V5OiBkZXZpY2UuYXV0aF9rZXksDQogICAgICAgICAgICBjaGFubmVsOiAwLA0KICAgICAgICAgICAgb246IHRydWUsDQogICAgICAgICAgICB0dXJuOiAib24iLA0KICAgICAgICAgIH0pLA0KICAgICAgICB9LA0KICAgICAgICAxMjAwMA0KICAgICAgKTsNCg0KICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7DQogICAgICAgIHNob3dEZXZpY2VQb3B1cChkZXZpY2UsIGNsaWNrc0xlZnQpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc2V0Q2xpY2tzTGVmdChkZXZpY2Uuc3RvcmFnZV9rZXksIGNsaWNrc0xlZnQgKyAxKTsNCiAgICAgICAgdXBkYXRlQnV0dG9uU3RhdGUoZGV2aWNlKTsNCiAgICAgICAgY29uc29sZS5lcnJvcigNCiAgICAgICAgICAiRXJyb3JlIG5lbGwnYXR0aXZhemlvbmUgZGVsIGRpc3Bvc2l0aXZvOiIsDQogICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzLA0KICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c1RleHQNCiAgICAgICAgKTsNCiAgICAgIH0NCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigiQXR0aXZhemlvbmUgZGlzcG9zaXRpdm8gZmFsbGl0YToiLCBlcnJvcik7DQogICAgICBzZXRDbGlja3NMZWZ0KGRldmljZS5zdG9yYWdlX2tleSwgY2xpY2tzTGVmdCArIDEpOw0KICAgICAgdXBkYXRlQnV0dG9uU3RhdGUoZGV2aWNlKTsNCiAgICB9DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gVE9LRU4gU0lDVVJJDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBtYXliZUNsZWFuVXJsKCkgew0KICAgIGlmICghS0VFUF9UT0tFTl9JTl9VUkwpIGNsZWFuVXJsKCk7DQogIH0NCg0KICBhc3luYyBmdW5jdGlvbiBoYW5kbGVTZWN1cmVUb2tlbigpIHsNCiAgICBjb25zdCB1cmxQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpOw0KICAgIGNvbnN0IHRva2VuID0gdXJsUGFyYW1zLmdldCgidG9rZW4iKTsNCiAgICBpZiAoIXRva2VuKSB7DQogICAgICBpc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgICAgd2luZG93LmlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgICBjdXJyZW50VG9rZW5DdXN0b21Db2RlID0gbnVsbDsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQoNCiAgICB0cnkgew0KICAgICAgY29uc3Qgc25hcHNob3QgPSBhd2FpdCBkYXRhYmFzZQ0KICAgICAgICAucmVmKCJzZWN1cmVfbGlua3MvIiArIHRva2VuKQ0KICAgICAgICAub25jZSgidmFsdWUiKTsNCiAgICAgIGlmICghc25hcHNob3QuZXhpc3RzKCkpIHsNCiAgICAgICAgc2hvd1Rva2VuRXJyb3IoIkludmFsaWQgdG9rZW4iKTsNCiAgICAgICAgYmxvY2tUb2tlbk9ubHkoIkludmFsaWQgdG9rZW4iLCB0b2tlbik7DQogICAgICAgIHNob3dBdXRoRm9ybSgpOw0KICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCg0KICAgICAgY29uc3QgbGlua0RhdGEgPSBzbmFwc2hvdC52YWwoKTsNCg0KICAgICAgaWYgKGlzVG9rZW5EZXZpY2VCbG9ja2VkKHRva2VuKSkgew0KICAgICAgICBjb25zdCByID0NCiAgICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShgdG9rZW5fZGV2aWNlX3JlYXNvbl8ke3Rva2VufWApIHx8DQogICAgICAgICAgIlNlc3Npb25lIHRva2VuIHNjYWR1dGEgc3UgcXVlc3RvIGRpc3Bvc2l0aXZvIjsNCiAgICAgICAgc2hvd1Rva2VuRXJyb3Iocik7DQogICAgICAgIGJsb2NrVG9rZW5Pbmx5KHIsIHRva2VuKTsNCiAgICAgICAgc2hvd0F1dGhGb3JtKCk7DQogICAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KDQogICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVTZWN1cmVUb2tlbihsaW5rRGF0YSk7DQogICAgICBpZiAoIWlzVmFsaWQudmFsaWQpIHsNCiAgICAgICAgc2hvd1Rva2VuRXJyb3IoaXNWYWxpZC5yZWFzb24pOw0KICAgICAgICBibG9ja1Rva2VuT25seShpc1ZhbGlkLnJlYXNvbiB8fCAiQWNjZXNzIGJsb2NrZWQiLCB0b2tlbik7DQogICAgICAgIHNob3dBdXRoRm9ybSgpOw0KICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCg0KICAgICAgaXNUb2tlblNlc3Npb24gPSB0cnVlOw0KICAgICAgd2luZG93LmlzVG9rZW5TZXNzaW9uID0gdHJ1ZTsNCiAgICAgIGN1cnJlbnRUb2tlbklkID0gdG9rZW47DQogICAgICBjdXJyZW50VG9rZW5DdXN0b21Db2RlID0gbGlua0RhdGEuY3VzdG9tQ29kZSB8fCBudWxsOw0KDQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tfbWFudWFsX2xvZ2luIik7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tlZF90b2tlbiIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImJsb2NrZWRfcmVhc29uIik7DQogICAgICBjbGVhclRva2VuRGV2aWNlQmxvY2sodG9rZW4pOw0KDQogICAgICB0cnkgew0KICAgICAgICB1bmJsb2NrQWNjZXNzKCk7DQogICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgfSBjYXRjaCB7fQ0KDQogICAgICBzaG93VG9rZW5Ob3RpZmljYXRpb24oaXNWYWxpZC5yZW1haW5pbmdVc2VzLCAhIWN1cnJlbnRUb2tlbkN1c3RvbUNvZGUpOw0KICAgICAgYXdhaXQgaW5jcmVtZW50VG9rZW5Vc2FnZSh0b2tlbiwgbGlua0RhdGEpOw0KICAgICAgbWF5YmVDbGVhblVybCgpOw0KICAgICAgc3RhcnRUb2tlbkV4cGlyYXRpb25DaGVjayhsaW5rRGF0YS5leHBpcmF0aW9uKTsNCiAgICAgIHN0YXJ0VG9rZW5SZWFsdGltZUxpc3RlbmVyKHRva2VuKTsNCg0KICAgICAgc2hvd0F1dGhGb3JtKCk7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigiVG9rZW4gdmVyaWZpY2F0aW9uIGVycm9yOiIsIGVycm9yKTsNCiAgICAgIHNob3dUb2tlbkVycm9yKCJWZXJpZmljYXRpb24gZXJyb3IiKTsNCiAgICAgIGJsb2NrVG9rZW5Pbmx5KCJWZXJpZmljYXRpb24gZXJyb3IiLCB0b2tlbik7DQogICAgICBzaG93QXV0aEZvcm0oKTsNCiAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCkgew0KICAgIGlmICh0b2tlblJlZikgew0KICAgICAgdG9rZW5SZWYub2ZmKCk7DQogICAgICB0b2tlblJlZiA9IG51bGw7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJNYW51YWxTZXNzaW9uKCkgew0KICAgIHRyeSB7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oInVzYWdlX2hhc2giKTsNCiAgICAgIHNlc3Npb25TdGFydFRpbWUgPSBudWxsOw0KICAgIH0gY2F0Y2gge30NCiAgfQ0KDQogIGZ1bmN0aW9uIGJsb2NrQWNjZXNzKHJlYXNvbiA9ICJBY2Nlc3NvIGJsb2NjYXRvIiwgdG9rZW4gPSBudWxsKSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJibG9ja19tYW51YWxfbG9naW4iLCAiMSIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfcmVhc29uIiwgcmVhc29uKTsNCiAgICAgIGlmICh0b2tlbikgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfdG9rZW4iLCB0b2tlbik7DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIGJsb2NrQWNjZXNzOiIsIGUpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGJsb2NrVG9rZW5Pbmx5KHJlYXNvbiA9ICJBY2Nlc3NvIGJsb2NjYXRvIiwgdG9rZW4gPSBudWxsKSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJibG9ja2VkX3JlYXNvbiIsIHJlYXNvbik7DQogICAgICBpZiAodG9rZW4pIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJibG9ja2VkX3Rva2VuIiwgdG9rZW4pOw0KICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yZSBibG9ja1Rva2VuT25seToiLCBlKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiB1bmJsb2NrQWNjZXNzKCkgew0KICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJibG9ja19tYW51YWxfbG9naW4iKTsNCiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tlZF9yZWFzb24iKTsNCiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tlZF90b2tlbiIpOw0KICB9DQoNCiAgZnVuY3Rpb24gbWFya1Rva2VuRGV2aWNlQmxvY2tlZCh0b2tlbiwgcmVhc29uID0gIiIpIHsNCiAgICB0cnkgew0KICAgICAgaWYgKCF0b2tlbikgcmV0dXJuOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oYHRva2VuX2RldmljZV9ibG9ja18ke3Rva2VufWAsICIxIik7DQogICAgICBpZiAocmVhc29uKSBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShgdG9rZW5fZGV2aWNlX3JlYXNvbl8ke3Rva2VufWAsIHJlYXNvbik7DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIG1hcmtUb2tlbkRldmljZUJsb2NrZWQ6IiwgZSk7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gaXNUb2tlbkRldmljZUJsb2NrZWQodG9rZW4pIHsNCiAgICB0cnkgew0KICAgICAgaWYgKCF0b2tlbikgcmV0dXJuIGZhbHNlOw0KICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGB0b2tlbl9kZXZpY2VfYmxvY2tfJHt0b2tlbn1gKSA9PT0gIjEiOw0KICAgIH0gY2F0Y2ggew0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGNsZWFyVG9rZW5EZXZpY2VCbG9jayh0b2tlbikgew0KICAgIHRyeSB7DQogICAgICBpZiAoIXRva2VuKSByZXR1cm47DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShgdG9rZW5fZGV2aWNlX2Jsb2NrXyR7dG9rZW59YCk7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShgdG9rZW5fZGV2aWNlX3JlYXNvbl8ke3Rva2VufWApOw0KICAgIH0gY2F0Y2gge30NCiAgfQ0KDQogIGZ1bmN0aW9uIGhhc1Rva2VuRm9vdHByaW50KCkgew0KICAgIHRyeSB7DQogICAgICBpZiAoaXNUb2tlblNlc3Npb24pIHJldHVybiB0cnVlOw0KICAgICAgY29uc3QgdXJsVG9rID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQoInRva2VuIik7DQogICAgICBpZiAodXJsVG9rKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiYmxvY2tlZF90b2tlbiIpKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbG9jYWxTdG9yYWdlLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGNvbnN0IGsgPSBsb2NhbFN0b3JhZ2Uua2V5KGkpOw0KICAgICAgICBpZiAoayAmJiBrLmluZGV4T2YoInRva2VuX29rXyIpID09PSAwKSByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICB9IGNhdGNoIChlKSB7DQogICAgICBjb25zb2xlLndhcm4oImhhc1Rva2VuRm9vdHByaW50IGNoZWNrIGZhaWxlZDoiLCBlKTsNCiAgICB9DQogICAgcmV0dXJuIGZhbHNlOw0KICB9DQoNCiAgZnVuY3Rpb24gZm9yY2VHbG9iYWxMb2dvdXQocmVhc29uID0gIkNvZGljZSBhZ2dpb3JuYXRvOiBhY2NlZGkgZGkgbnVvdm8iKSB7DQogICAgaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICB3aW5kb3cuaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICBjbGVhck1hbnVhbFNlc3Npb24oKTsNCiAgICBjb25zdCB0ID0NCiAgICAgIGN1cnJlbnRUb2tlbklkIHx8DQogICAgICBuZXcgVVJMU2VhcmNoUGFyYW1zKGxvY2F0aW9uLnNlYXJjaCkuZ2V0KCJ0b2tlbiIpIHx8DQogICAgICBudWxsOw0KICAgIGJsb2NrVG9rZW5Pbmx5KHJlYXNvbiwgdCk7DQogICAgdHJ5IHsNCiAgICAgIGlmICh0KSBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShgdG9rZW5fb2tfJHt0fWApOw0KICAgIH0gY2F0Y2gge30NCiAgICBzaG93VG9rZW5FcnJvcihyZWFzb24pOw0KICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgIHN0b3BUb2tlblJlYWx0aW1lTGlzdGVuZXIoKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGZvcmNlTG9nb3V0RnJvbVRva2VuKHJlYXNvbiA9ICJMaW5rIG5vbiBwacODwrkgdmFsaWRvIikgew0KICAgIGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgd2luZG93LmlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgY2xlYXJNYW51YWxTZXNzaW9uKCk7DQogICAgY29uc3QgdCA9DQogICAgICBjdXJyZW50VG9rZW5JZCB8fA0KICAgICAgbmV3IFVSTFNlYXJjaFBhcmFtcyhsb2NhdGlvbi5zZWFyY2gpLmdldCgidG9rZW4iKSB8fA0KICAgICAgbnVsbDsNCiAgICBibG9ja1Rva2VuT25seShyZWFzb24sIHQpOw0KICAgIGlmICh0KSBtYXJrVG9rZW5EZXZpY2VCbG9ja2VkKHQsIHJlYXNvbiB8fCAiU2Vzc2lvbmUgdG9rZW4gc2NhZHV0YSIpOw0KICAgIHRyeSB7DQogICAgICBpZiAodCkgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYHRva2VuX29rXyR7dH1gKTsNCiAgICB9IGNhdGNoIHt9DQogICAgc2hvd1Rva2VuRXJyb3IocmVhc29uKTsNCiAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBzdGFydFRva2VuUmVhbHRpbWVMaXN0ZW5lcih0b2tlbikgew0KICAgIHN0b3BUb2tlblJlYWx0aW1lTGlzdGVuZXIoKTsNCiAgICB0b2tlblJlZiA9IGRhdGFiYXNlLnJlZigic2VjdXJlX2xpbmtzLyIgKyB0b2tlbik7DQogICAgdG9rZW5SZWYub24oInZhbHVlIiwgKHNuYXApID0+IHsNCiAgICAgIGlmICghc25hcC5leGlzdHMoKSkgew0KICAgICAgICBmb3JjZUxvZ291dEZyb21Ub2tlbigiTGluayByaW1vc3NvIik7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGQgPSBzbmFwLnZhbCgpOw0KICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsNCiAgICAgIGNvbnN0IGV4aGF1c3RlZCA9IChkLnVzZWRDb3VudCB8fCAwKSA+PSAoZC5tYXhVc2FnZSB8fCAwKTsNCiAgICAgIGNvbnN0IGV4cGlyZWQgPSAoZC5leHBpcmF0aW9uIHx8IDApIDw9IG5vdzsNCiAgICAgIGNvbnN0IHJldm9rZWQgPSBkLnN0YXR1cyAhPT0gImFjdGl2ZSI7DQogICAgICBpZiAocmV2b2tlZCB8fCBleHBpcmVkIHx8IGV4aGF1c3RlZCkgew0KICAgICAgICBjb25zdCB3aHkgPSByZXZva2VkDQogICAgICAgICAgPyAiTGluayByZXZvY2F0byINCiAgICAgICAgICA6IGV4cGlyZWQNCiAgICAgICAgICA/ICJMaW5rIHNjYWR1dG8iDQogICAgICAgICAgOiAiVXRpbGl6emkgZXNhdXJpdGkiOw0KICAgICAgICBmb3JjZUxvZ291dEZyb21Ub2tlbih3aHkpOw0KICAgICAgfQ0KICAgIH0pOw0KICB9DQoNCiAgZnVuY3Rpb24gdmFsaWRhdGVTZWN1cmVUb2tlbihsaW5rRGF0YSkgew0KICAgIHRyeSB7DQogICAgICBpZiAoIWxpbmtEYXRhKSByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJlYXNvbjogIlRva2VuIG5vbiB2YWxpZG8iIH07DQogICAgICBpZiAobGlua0RhdGEuc3RhdHVzICE9PSAiYWN0aXZlIikNCiAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJUb2tlbiByZXZvY2F0byIgfTsNCiAgICAgIGlmIChsaW5rRGF0YS5leHBpcmF0aW9uIDwgRGF0ZS5ub3coKSkNCiAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJUb2tlbiBzY2FkdXRvIiB9Ow0KICAgICAgaWYgKChsaW5rRGF0YS51c2VkQ291bnQgfHwgMCkgPj0gKGxpbmtEYXRhLm1heFVzYWdlIHx8IDApKQ0KICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIHJlYXNvbjogIlV0aWxpenppIGVzYXVyaXRpIiB9Ow0KICAgICAgY29uc3QgcmVtYWluaW5nVXNlcyA9DQogICAgICAgIChsaW5rRGF0YS5tYXhVc2FnZSB8fCAwKSAtIChsaW5rRGF0YS51c2VkQ291bnQgfHwgMCk7DQogICAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSwgcmVtYWluaW5nVXNlcyB9Ow0KICAgIH0gY2F0Y2ggew0KICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJFcnJvcmUgZGkgdmVyaWZpY2EiIH07DQogICAgfQ0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gaW5jcmVtZW50VG9rZW5Vc2FnZSh0b2tlbiwgbGlua0RhdGEpIHsNCiAgICBjb25zdCBuZXdVc2VkQ291bnQgPSAobGlua0RhdGEudXNlZENvdW50IHx8IDApICsgMTsNCiAgICBjb25zdCBuZXdTdGF0dXMgPQ0KICAgICAgbmV3VXNlZENvdW50ID49IChsaW5rRGF0YS5tYXhVc2FnZSB8fCAwKSA/ICJ1c2VkIiA6ICJhY3RpdmUiOw0KICAgIHRyeSB7DQogICAgICBhd2FpdCBkYXRhYmFzZQ0KICAgICAgICAucmVmKCJzZWN1cmVfbGlua3MvIiArIHRva2VuKQ0KICAgICAgICAudXBkYXRlKHsgdXNlZENvdW50OiBuZXdVc2VkQ291bnQsIHN0YXR1czogbmV3U3RhdHVzIH0pOw0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsbCdhZ2dpb3JuYW1lbnRvIGRlbCB0b2tlbjoiLCBlcnJvcik7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gc2hvd1Rva2VuTm90aWZpY2F0aW9uKHJlbWFpbmluZ1VzZXMsIGhhc0N1c3RvbUNvZGUpIHsNCiAgICBjb25zdCBuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7DQogICAgbi5zdHlsZS5jc3NUZXh0ID0gYA0KICAgICAgcG9zaXRpb246Zml4ZWQ7IHRvcDoyMHB4OyByaWdodDoyMHB4OyBiYWNrZ3JvdW5kOnZhcigtLXN1Y2Nlc3MpOyBjb2xvcjojZmZmOw0KICAgICAgcGFkZGluZzoxNXB4IDIwcHg7IGJvcmRlci1yYWRpdXM6OHB4OyBib3gtc2hhZG93OjAgNHB4IDEycHggcmdiYSgwLDAsMCwuMSk7DQogICAgICB6LWluZGV4OjEwMDAwOyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBhbGlnbi1pdGVtczpjZW50ZXI7IG1heC13aWR0aDozNTBweDtgOw0KICAgIGNvbnN0IGN1c3RvbSA9IGhhc0N1c3RvbUNvZGUNCiAgICAgID8gJzxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxMnB4O29wYWNpdHk6Ljk7Ij5RdWVzdG8gbGluayB1c2EgdW4gY29kaWNlIGRlZGljYXRvPC9kaXY+Jw0KICAgICAgOiAnPGRpdiBzdHlsZT0iZm9udC1zaXplOjEycHg7b3BhY2l0eTouOTsiPlF1ZXN0byBsaW5rIHVzYSBpbCBjb2RpY2UgcHJpbmNpcGFsZTwvZGl2Pic7DQogICAgbi5pbm5lckhUTUwgPSBgDQogICAgICA8aSBjbGFzcz0iZmFzIGZhLWNoZWNrLWNpcmNsZSI+PC9pPg0KICAgICAgPGRpdj4NCiAgICAgICAgPGRpdj5MaW5rIHNpY3VybyByaWNvbm9zY2l1dG88L2Rpdj4NCiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEycHg7b3BhY2l0eTouOTsiPlV0aWxpenppIHJpbWFuZW50aTogJHtyZW1haW5pbmdVc2VzfTwvZGl2Pg0KICAgICAgICAke2N1c3RvbX0NCiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEycHg7b3BhY2l0eTouOTttYXJnaW4tdG9wOjVweDsiPjxpIGNsYXNzPSJmYXMgZmEtaW5mby1jaXJjbGUiPjwvaT4gSW5zZXJpc2NpIGlsIGNvZGljZSBxdWkgc290dG88L2Rpdj4NCiAgICAgIDwvZGl2Pg0KICAgICAgPGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQucmVtb3ZlKCkiIHN0eWxlPSJiYWNrZ3JvdW5kOm5vbmU7Ym9yZGVyOm5vbmU7Y29sb3I6I2ZmZjttYXJnaW4tbGVmdDoxMHB4O2N1cnNvcjpwb2ludGVyIj4NCiAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS10aW1lcyI+PC9pPg0KICAgICAgPC9idXR0b24+YDsNCiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG4pOw0KICAgIHNldFRpbWVvdXQoKCkgPT4gbi5wYXJlbnRFbGVtZW50ICYmIG4ucmVtb3ZlKCksIDUwMDApOw0KICB9DQoNCiAgZnVuY3Rpb24gc2hvd1Rva2VuRXJyb3IocmVhc29uKSB7DQogICAgY29uc3QgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIG4uc3R5bGUuY3NzVGV4dCA9IGANCiAgICAgIHBvc2l0aW9uOmZpeGVkOyB0b3A6MjBweDsgcmlnaHQ6MjBweDsgYmFja2dyb3VuZDp2YXIoLS1lcnJvcik7IGNvbG9yOiNmZmY7DQogICAgICBwYWRkaW5nOjE1cHggMjBweDsgYm9yZGVyLXJhZGl1czo4cHg7IGJveC1zaGFkb3c6MCA0cHggMTJweCByZ2JhKDAsMCwwLC4xKTsNCiAgICAgIHotaW5kZXg6MTAwMDA7IGRpc3BsYXk6ZmxleDsgZ2FwOjEwcHg7IGFsaWduLWl0ZW1zOmNlbnRlcjsgbWF4LXdpZHRoOjMyMHB4O2A7DQogICAgbi5pbm5lckhUTUwgPSBgDQogICAgICA8aSBjbGFzcz0iZmFzIGZhLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlIj48L2k+DQogICAgICA8ZGl2Pg0KICAgICAgICA8ZGl2Pkxpbmsgbm9uIHZhbGlkbzwvZGl2Pg0KICAgICAgICA8ZGl2IHN0eWxlPSJmb250LXNpemU6MTJweDtvcGFjaXR5Oi45OyI+TW90aXZvOiAke3JlYXNvbn08L2Rpdj4NCiAgICAgIDwvZGl2Pg0KICAgICAgPGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQucmVtb3ZlKCkiIHN0eWxlPSJiYWNrZ3JvdW5kOm5vbmU7Ym9yZGVyOm5vbmU7Y29sb3I6I2ZmZjttYXJnaW4tbGVmdDoxMHB4O2N1cnNvcjpwb2ludGVyIj4NCiAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS10aW1lcyI+PC9pPg0KICAgICAgPC9idXR0b24+YDsNCiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG4pOw0KICAgIHNldFRpbWVvdXQoKCkgPT4gbi5wYXJlbnRFbGVtZW50ICYmIG4ucmVtb3ZlKCksIDUwMDApOw0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYW5VcmwoKSB7DQogICAgaWYgKHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSkgew0KICAgICAgY29uc3QgY2xlYW4gPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lOw0KICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgY2xlYW4pOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHN0YXJ0VG9rZW5FeHBpcmF0aW9uQ2hlY2soZXhwaXJhdGlvblRpbWUpIHsNCiAgICBjb25zdCBpdiA9IHNldEludGVydmFsKCgpID0+IHsNCiAgICAgIGlmIChEYXRlLm5vdygpID4gZXhwaXJhdGlvblRpbWUpIHsNCiAgICAgICAgY2xlYXJJbnRlcnZhbChpdik7DQogICAgICAgIGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgICAgICBjb25zdCB0ID0gY3VycmVudFRva2VuSWQgfHwgbnVsbDsNCiAgICAgICAgYmxvY2tUb2tlbk9ubHkoIkxpbmsgZXhwaXJlZCIsIHQpOw0KICAgICAgICBpZiAodCkgbWFya1Rva2VuRGV2aWNlQmxvY2tlZCh0LCAiTGluayBleHBpcmVkIik7DQogICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgfQ0KICAgIH0sIDEwMDApOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIEFVVEVOVElDQVpJT05FDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBpc0xvZ2luTG9ja2VkKCkgew0KICAgIHRyeSB7DQogICAgICBjb25zdCB1bnRpbCA9IHBhcnNlSW50KA0KICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibG9naW5fbG9ja191bnRpbCIpIHx8ICIwIiwNCiAgICAgICAgMTANCiAgICAgICk7DQogICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZSh1bnRpbCkgfHwgdW50aWwgPD0gMCkgcmV0dXJuIGZhbHNlOw0KICAgICAgaWYgKERhdGUubm93KCkgPCB1bnRpbCkgcmV0dXJuIHRydWU7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgibG9naW5fbG9ja191bnRpbCIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2F0dGVtcHRzIik7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfSBjYXRjaCB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gc2Vjb25kc1RvSGhNbVNzKHNlYykgew0KICAgIGNvbnN0IHMgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKHNlYykpOw0KICAgIGNvbnN0IGggPSBNYXRoLmZsb29yKHMgLyAzNjAwKTsNCiAgICBjb25zdCBtID0gTWF0aC5mbG9vcigocyAlIDM2MDApIC8gNjApOw0KICAgIGNvbnN0IHIgPSBzICUgNjA7DQogICAgaWYgKGggPiAwKQ0KICAgICAgcmV0dXJuIGAke2h9aCAke1N0cmluZyhtKS5wYWRTdGFydCgyLCAiMCIpfW0gJHtTdHJpbmcocikucGFkU3RhcnQoDQogICAgICAgIDIsDQogICAgICAgICIwIg0KICAgICAgKX1zYDsNCiAgICByZXR1cm4gYCR7U3RyaW5nKG0pLnBhZFN0YXJ0KDIsICIwIil9bSAke1N0cmluZyhyKS5wYWRTdGFydCgyLCAiMCIpfXNgOw0KICB9DQoNCiAgZnVuY3Rpb24gdXBkYXRlTG9ja1VJKCkgew0KICAgIGNvbnN0IGlucHV0ID0gcXMoImF1dGhDb2RlIik7DQogICAgY29uc3QgYnRuID0gcXMoImJ0bkNoZWNrQ29kZSIpOw0KICAgIGNvbnN0IGV4aXN0aW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImxvY2tOb3RpY2UiKTsNCiAgICBjb25zdCBsb2NrZWQgPSBpc0xvZ2luTG9ja2VkKCk7DQogICAgaWYgKGxvY2tlZCkgew0KICAgICAgaWYgKGlucHV0KSBpbnB1dC5kaXNhYmxlZCA9IHRydWU7DQogICAgICBpZiAoYnRuKSB7DQogICAgICAgIGJ0bi5kaXNhYmxlZCA9IHRydWU7DQogICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCJidG4tZXJyb3IiKTsNCiAgICAgIH0NCiAgICAgIGxldCBub3RpY2UgPSBleGlzdGluZzsNCiAgICAgIGlmICghbm90aWNlICYmIGlucHV0Py5wYXJlbnRFbGVtZW50KSB7DQogICAgICAgIG5vdGljZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgICAgICBub3RpY2UuaWQgPSAibG9ja05vdGljZSI7DQogICAgICAgIG5vdGljZS5zdHlsZS5jc3NUZXh0ID0gIm1hcmdpbi10b3A6MTBweDtjb2xvcjojZmY1YTVmO2ZvbnQtd2VpZ2h0OjYwMDsiOw0KICAgICAgICBpbnB1dC5wYXJlbnRFbGVtZW50Lmluc2VydEFkamFjZW50RWxlbWVudCgiYWZ0ZXJlbmQiLCBub3RpY2UpOw0KICAgICAgfQ0KICAgICAgaWYgKG5vdGljZSkgew0KICAgICAgICBjb25zdCB1bnRpbCA9IHBhcnNlSW50KA0KICAgICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJsb2dpbl9sb2NrX3VudGlsIikgfHwgIjAiLA0KICAgICAgICAgIDEwDQogICAgICAgICk7DQogICAgICAgIGNvbnN0IHJlbWFpbmluZ1NlYyA9IE1hdGgubWF4KA0KICAgICAgICAgIDAsDQogICAgICAgICAgTWF0aC5mbG9vcigodW50aWwgLSBEYXRlLm5vdygpKSAvIDEwMDApDQogICAgICAgICk7DQogICAgICAgIG5vdGljZS5pbm5lckhUTUwgPSBgPGkgY2xhc3M9ImZhcyBmYS1sb2NrIj48L2k+IFRvbyBtYW55IGluY29ycmVjdCBhdHRlbXB0cy4gVHJ5IGFnYWluIGluICR7c2Vjb25kc1RvSGhNbVNzKA0KICAgICAgICAgIHJlbWFpbmluZ1NlYw0KICAgICAgICApfS5gOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoaW5wdXQpIGlucHV0LmRpc2FibGVkID0gZmFsc2U7DQogICAgICBpZiAoYnRuKSB7DQogICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOw0KICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgiYnRuLWVycm9yIik7DQogICAgICB9DQogICAgICBpZiAoZXhpc3RpbmcpIGV4aXN0aW5nLnJlbW92ZSgpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGluY3JlbWVudEZhaWxlZEF0dGVtcHQoKSB7DQogICAgdHJ5IHsNCiAgICAgIGNvbnN0IGF0dGVtcHRzID0NCiAgICAgICAgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oImxvZ2luX2F0dGVtcHRzIikgfHwgIjAiLCAxMCkgKyAxOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImxvZ2luX2F0dGVtcHRzIiwgU3RyaW5nKGF0dGVtcHRzKSk7DQogICAgICBjb25zdCBsZWZ0ID0gTWF0aC5tYXgoMCwgTUFYX0xPR0lOX0FUVEVNUFRTIC0gYXR0ZW1wdHMpOw0KICAgICAgaWYgKGF0dGVtcHRzID49IE1BWF9MT0dJTl9BVFRFTVBUUykgew0KICAgICAgICBjb25zdCB1bnRpbCA9IERhdGUubm93KCkgKyBMT0NLT1VUX01JTlVURVMgKiA2MCAqIDEwMDA7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJsb2dpbl9sb2NrX3VudGlsIiwgU3RyaW5nKHVudGlsKSk7DQogICAgICAgIHNob3dOb3RpZmljYXRpb24oDQogICAgICAgICAgYFRvbyBtYW55IGZhaWxlZCBhdHRlbXB0cy4gUGFnZSBsb2NrZWQgZm9yICR7TE9DS09VVF9NSU5VVEVTfSBtaW51dGVzYCwNCiAgICAgICAgICAiZXJyb3IiDQogICAgICAgICk7DQogICAgICAgIHVwZGF0ZUxvY2tVSSgpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgV3JvbmcgY29kZS4gQXR0ZW1wdHMgbGVmdDogJHtsZWZ0fWAsICJ3YXJuaW5nIik7DQogICAgICB9DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS53YXJuKCJJbXBvc3NpYmlsZSBpbmNyZW1lbnRhcmUgaSB0ZW50YXRpdmk6IiwgZSk7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gcmVzZXRGYWlsZWRBdHRlbXB0cygpIHsNCiAgICB0cnkgew0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2F0dGVtcHRzIik7DQogICAgfSBjYXRjaCB7fQ0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gcGVyZm9ybU1hbnVhbExvZ2luKCkgew0KICAgIGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgd2luZG93LmlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgc2Vzc2lvblN0YXJ0VGltZSA9IERhdGUubm93KCk7DQogICAgYXdhaXQgc2V0VXNhZ2VTdGFydFRpbWUoKTsNCg0KICAgIGlmIChhd2FpdCBjaGVja1RpbWVMaW1pdCgpKSByZXR1cm47DQoNCiAgICB0cnkgew0KICAgICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgdW5ibG9ja0FjY2VzcygpOw0KICAgIH0gY2F0Y2gge30NCg0KICAgIHNob3dDb250cm9sUGFuZWwoKTsNCiAgICBxcygiY2hlY2tpblRpbWVJbmZvIikgJiYgKHFzKCJjaGVja2luVGltZUluZm8iKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIik7DQogICAgdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5KCk7DQogICAgREVWSUNFUy5mb3JFYWNoKHVwZGF0ZUJ1dHRvblN0YXRlKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZUNvZGVTdWJtaXQoKSB7DQogICAgaWYgKGlzTG9naW5Mb2NrZWQoKSkgew0KICAgICAgdXBkYXRlTG9ja1VJKCk7DQogICAgICByZXR1cm47DQogICAgfQ0KICAgIGNvbnN0IGNvZGVJbnB1dCA9IHFzKCJhdXRoQ29kZSIpOw0KICAgIGNvbnN0IGluc2VydGVkQ29kZSA9IChjb2RlSW5wdXQ/LnZhbHVlIHx8ICIiKS50cmltKCk7DQogICAgbGV0IGV4cGVjdGVkQ29kZSA9IENPUlJFQ1RfQ09ERTsNCg0KICAgIGlmICghaW5zZXJ0ZWRDb2RlKSB7DQogICAgICBzaG93Tm90aWZpY2F0aW9uKCJQbGVhc2UgZW50ZXIgdGhlIGFjY2VzcyBjb2RlIiwgIndhcm5pbmciKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQoNCiAgICBpZiAoaXNUb2tlblNlc3Npb24gJiYgY3VycmVudFRva2VuQ3VzdG9tQ29kZSkNCiAgICAgIGV4cGVjdGVkQ29kZSA9IGN1cnJlbnRUb2tlbkN1c3RvbUNvZGU7DQoNCiAgICBpZiAoaW5zZXJ0ZWRDb2RlICE9PSBleHBlY3RlZENvZGUpIHsNCiAgICAgIGluY3JlbWVudEZhaWxlZEF0dGVtcHQoKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgcmVzZXRGYWlsZWRBdHRlbXB0cygpOw0KDQogICAgaWYgKGlzVG9rZW5TZXNzaW9uKSB7DQogICAgICB0cnkgew0KICAgICAgICBpZiAoY3VycmVudFRva2VuSWQpDQogICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oYHRva2VuX29rXyR7Y3VycmVudFRva2VuSWR9YCwgIjEiKTsNCiAgICAgICAgaWYgKGN1cnJlbnRUb2tlbklkKSBhd2FpdCBzZXRUb2tlblVzYWdlU3RhcnRUaW1lKGN1cnJlbnRUb2tlbklkKTsNCiAgICAgICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHVuYmxvY2tBY2Nlc3MoKTsNCiAgICAgIH0gY2F0Y2gge30NCiAgICAgIHNob3dDb250cm9sUGFuZWwoKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgYXdhaXQgcGVyZm9ybU1hbnVhbExvZ2luKCk7DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gSU5JWklBTElaWkFaSU9ORSBBUFANCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGFzeW5jIGZ1bmN0aW9uIGluaXQoKSB7DQogICAgY29uc29sZS5sb2coIkluaXppYWxpenphemlvbmUgYXBwLiIpOw0KDQogICAgLy8gRklYRUQ6IEFsd2F5cyBoaWRlIG92ZXJsYXlzIG9uIHN0YXJ0dXANCiAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KDQogICAgY29uc3QgZmlyZWJhc2VTZXR0aW5ncyA9IGF3YWl0IGxvYWRTZXR0aW5nc0Zyb21GaXJlYmFzZSgpOw0KICAgIGlmIChmaXJlYmFzZVNldHRpbmdzKSBhcHBseUZpcmViYXNlU2V0dGluZ3MoZmlyZWJhc2VTZXR0aW5ncyk7DQoNCiAgICBpZiAoaXNTZXNzaW9uU3R1Y2soKSkgY29uc29sZS53YXJuKCJSaWxldmF0YSBwb3NzaWJpbGUgc2Vzc2lvbmUgYmxvY2NhdGEiKTsNCg0KICAgIC8vIEZJWEVEOiBVcGRhdGUgY3VycmVudENvZGVWZXJzaW9uIHByb3Blcmx5DQogICAgY3VycmVudENvZGVWZXJzaW9uID0gcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkpIHx8IDE7DQoNCiAgICBjb25zdCBzYXZlZENvZGVWZXJzaW9uID0NCiAgICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjb2RlX3ZlcnNpb24iKSkgfHwgMTsNCiAgICBpZiAoc2F2ZWRDb2RlVmVyc2lvbiA8IGN1cnJlbnRDb2RlVmVyc2lvbikgew0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImNvZGVfdmVyc2lvbiIsIFN0cmluZyhjdXJyZW50Q29kZVZlcnNpb24pKTsNCiAgICAgIHNob3dOb3RpZmljYXRpb24oDQogICAgICAgICJJbCBjb2RpY2UgZGkgYWNjZXNzbyDDg8KoIHN0YXRvIGFnZ2lvcm5hdG8uIEluc2VyaXNjaSBpbCBudW92byBjb2RpY2UuIg0KICAgICAgKTsNCiAgICB9DQoNCiAgICBzZXR1cEV2ZW50TGlzdGVuZXJzKCk7DQogICAgc2V0dXBTZXR0aW5nc0xpc3RlbmVyKCk7DQogICAgbW9uaXRvckZpcmViYXNlQ29ubmVjdGlvbigpOw0KDQogICAgLy8gRklYRUQ6IE9ubHkgc2hvdyBleHBpcmVkIG92ZXJsYXkgZm9yIGV4cGxpY2l0bHkgYmxvY2tlZCBkZXZpY2VzDQogICAgY29uc3QgaXNCbG9ja2VkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImJsb2NrX21hbnVhbF9sb2dpbiIpID09PSAiMSI7DQogICAgaWYgKGlzQmxvY2tlZCkgew0KICAgICAgaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgICAgc2hvd1Nlc3Npb25FeHBpcmVkKCk7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgLy8gSGFuZGxlIHRva2VuIGZpcnN0DQogICAgY29uc3QgdG9rZW5IYW5kbGVkID0gYXdhaXQgaGFuZGxlU2VjdXJlVG9rZW4oKTsNCg0KICAgIHNldHVwVG9rZW5VSSgpOw0KDQogICAgaWYgKGlzVG9rZW5TZXNzaW9uKSB1bmJsb2NrQWNjZXNzKCk7DQoNCiAgICAvLyBGSVhFRDogU2ltcGxpZmllZCBsb2dpYyBmb3Igbm9ybWFsIGxpbmtzDQogICAgaWYgKCFpc1Rva2VuU2Vzc2lvbikgew0KICAgICAgY29uc3QgZXhwaXJlZCA9IGF3YWl0IGNoZWNrVGltZUxpbWl0KCk7DQogICAgICBpZiAoIWV4cGlyZWQpIHsNCiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gZ2V0U3RvcmFnZSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KICAgICAgICBpZiAoc3RhcnRUaW1lKSB7DQogICAgICAgICAgc2Vzc2lvblN0YXJ0VGltZSA9IHBhcnNlSW50KHN0YXJ0VGltZSwgMTApOw0KICAgICAgICAgIHNob3dDb250cm9sUGFuZWwoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzaG93QXV0aEZvcm0oKTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc2hvd0F1dGhGb3JtKCk7DQogICAgICB9DQogICAgfQ0KDQogICAgdXBkYXRlRG9vclZpc2liaWxpdHkoKTsNCiAgICB1cGRhdGVMb2NrVUkoKTsNCiAgICBzZXR1cEludGVydmFscygpOw0KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51IiwgKGUpID0+IGUucHJldmVudERlZmF1bHQoKSk7DQogICAgdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5KCk7DQogIH0NCg0KICBmdW5jdGlvbiBzZXR1cEV2ZW50TGlzdGVuZXJzKCkgew0KICAgIG9uKCJidG5DaGVja0NvZGUiLCAiY2xpY2siLCBoYW5kbGVDb2RlU3VibWl0KTsNCg0KICAgIERFVklDRVMuZm9yRWFjaCgoZGV2aWNlKSA9PiB7DQogICAgICBjb25zdCBidG4gPSBxcyhkZXZpY2UuYnV0dG9uX2lkKTsNCiAgICAgIGlmIChidG4pDQogICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHNob3dDb25maXJtYXRpb25Qb3B1cChkZXZpY2UpKTsNCiAgICB9KTsNCg0KICAgIG9uKCJjb25maXJtWWVzIiwgImNsaWNrIiwgKCkgPT4gew0KICAgICAgaWYgKGN1cnJlbnREZXZpY2UpIHsNCiAgICAgICAgYWN0aXZhdGVEZXZpY2UoY3VycmVudERldmljZSk7DQogICAgICAgIGNsb3NlQ29uZmlybWF0aW9uUG9wdXAoKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgICBvbigiY29uZmlybU5vIiwgImNsaWNrIiwgY2xvc2VDb25maXJtYXRpb25Qb3B1cCk7DQoNCiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIucG9wdXAgLmJ0biIpLmZvckVhY2goKGJ1dHRvbikgPT4gew0KICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCkgew0KICAgICAgICBjb25zdCBwb3B1cCA9IHRoaXMuY2xvc2VzdCgiLnBvcHVwIik7DQogICAgICAgIGlmIChwb3B1cCkgew0KICAgICAgICAgIGNvbnN0IGlkID0gcG9wdXAuaWQucmVwbGFjZSgicG9wdXAtIiwgIiIpOw0KICAgICAgICAgIGNsb3NlUG9wdXAoaWQpOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNob3dDb250cm9sUGFuZWwoKSB7DQogICAgY29uc3QgY3AgPSBxcygiY29udHJvbFBhbmVsIik7DQogICAgaWYgKGNwKSB7DQogICAgICBjcC5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsNCiAgICAgIGNwLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIH0NCiAgICBjb25zdCByb290ID0gcXMoInRlc3QyIik7DQogICAgaWYgKHJvb3QpIHJvb3Quc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgY29uc3QgYWMgPSBxcygiYXV0aENvZGUiKTsNCiAgICBpZiAoYWMpIGFjLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgY29uc3QgYWYgPSBxcygiYXV0aC1mb3JtIik7DQogICAgaWYgKGFmKSBhZi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIGNvbnN0IGJjID0gcXMoImJ0bkNoZWNrQ29kZSIpOw0KICAgIGlmIChiYykgYmMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICBjb25zdCBpbXAgPSBxcygiaW1wb3J0YW50Iik7DQogICAgaWYgKGltcCkgaW1wLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICBjb25zdCBpbmZvID0gcXMoImNoZWNraW5UaW1lSW5mbyIpOw0KICAgIGlmIChpbmZvKSBpbmZvLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSgpOw0KICAgIERFVklDRVMuZm9yRWFjaCh1cGRhdGVCdXR0b25TdGF0ZSk7DQogICAgdXBkYXRlU3RhdHVzQmFyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93QXV0aEZvcm0oKSB7DQogICAgY29uc3QgY3AgPSBxcygiY29udHJvbFBhbmVsIik7DQogICAgaWYgKGNwKSBjcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIGNvbnN0IGFjID0gcXMoImF1dGhDb2RlIik7DQogICAgaWYgKGFjKSBhYy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgICBjb25zdCBhZiA9IHFzKCJhdXRoLWZvcm0iKTsNCiAgICBpZiAoYWYpIGFmLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIGNvbnN0IGJjID0gcXMoImJ0bkNoZWNrQ29kZSIpOw0KICAgIGlmIChiYykgYmMuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgY29uc3QgaW1wID0gcXMoImltcG9ydGFudCIpOw0KICAgIGlmIChpbXApIGltcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICB9DQoNCiAgZnVuY3Rpb24gc2V0dXBUb2tlblVJKCkgew0KICAgIGlmICghaXNUb2tlblNlc3Npb24pIHJldHVybjsNCg0KICAgIGNvbnN0IGFkbWluTGluayA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2FbaHJlZj0iYWRtaW4uaHRtbCJdJyk7DQogICAgaWYgKGFkbWluTGluaykgYWRtaW5MaW5rLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQoNCiAgICBjb25zdCBleHBpcmVkTWVzc2FnZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNzZXNzaW9uRXhwaXJlZCBwIik7DQogICAgaWYgKGV4cGlyZWRNZXNzYWdlKQ0KICAgICAgZXhwaXJlZE1lc3NhZ2UudGV4dENvbnRlbnQgPQ0KICAgICAgICAiVGhlIGFjY2VzcyBsaW5rIGhhcyBleHBpcmVkLiBUbyBhY2Nlc3MgYWdhaW4sIHJlcXVlc3QgYSBuZXcgbGluay4iOw0KDQogICAgY29uc3QgYXNzaXN0YW5jZUJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoDQogICAgICAiI3Nlc3Npb25FeHBpcmVkIC5idG4td2hhdHNhcHAiDQogICAgKTsNCiAgICBpZiAoYXNzaXN0YW5jZUJ0bikgew0KICAgICAgYXNzaXN0YW5jZUJ0bi5ocmVmID0NCiAgICAgICAgImh0dHBzOi8vYXBpLndoYXRzYXBwLmNvbS9zZW5kP3Bob25lPSszOTM4OTg4ODM2MzQmdGV4dD1IaSwgSSBuZWVkIGEgbmV3IGFjY2VzcyBsaW5rIjsNCiAgICAgIGFzc2lzdGFuY2VCdG4uaW5uZXJIVE1MID0NCiAgICAgICAgJzxpIGNsYXNzPSJmYWIgZmEtd2hhdHNhcHAiPjwvaT4gUmVxdWVzdCBuZXcgbGluayc7DQogICAgfQ0KDQogICAgY29uc3QgYXV0aENvZGVJbnB1dCA9IHFzKCJhdXRoQ29kZSIpOw0KICAgIGlmIChhdXRoQ29kZUlucHV0KSB7DQogICAgICBhdXRoQ29kZUlucHV0LnBsYWNlaG9sZGVyID0gY3VycmVudFRva2VuQ3VzdG9tQ29kZQ0KICAgICAgICA/ICJJbnNlcmlzY2kgaWwgY29kaWNlIGRlZGljYXRvIGRlbCBsaW5rIg0KICAgICAgICA6ICJJbnNlcmlzY2kgaWwgY29kaWNlIHByaW5jaXBhbGUiOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHNldHVwSW50ZXJ2YWxzKCkgew0KICAgIHNldHVwQ29kZUNoYW5nZUxpc3RlbmVyKCk7DQoNCiAgICB0aW1lQ2hlY2tJbnRlcnZhbCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHsNCiAgICAgIGNvbnN0IGV4cGlyZWQgPSBhd2FpdCBjaGVja1RpbWVMaW1pdCgpOw0KICAgICAgaWYgKCFleHBpcmVkKSB7DQogICAgICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSgpOw0KICAgICAgfQ0KICAgICAgdXBkYXRlTG9ja1VJKCk7DQogICAgfSwgMTAwMCk7DQoNCiAgICBzZXRJbnRlcnZhbCh1cGRhdGVDaGVja2luVGltZURpc3BsYXksIDYwMDAwKTsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBBVlZJTy9TVE9QDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgaW5pdCk7DQoNCiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImJlZm9yZXVubG9hZCIsICgpID0+IHsNCiAgICBpZiAodGltZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGltZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGlmIChjb2RlQ2hlY2tJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbChjb2RlQ2hlY2tJbnRlcnZhbCk7DQogICAgaWYgKExJTktfQ0hFQ0tfSU5URVJWQUwpIGNsZWFySW50ZXJ2YWwoTElOS19DSEVDS19JTlRFUlZBTCk7DQogICAgc3RvcFRva2VuUmVhbHRpbWVMaXN0ZW5lcigpOw0KICAgIGlmIChzZXR0aW5nc1JlZikgc2V0dGluZ3NSZWYub2ZmICYmIHNldHRpbmdzUmVmLm9mZigpOw0KICB9KTsNCg0KICAvLyBFeHBvcnQgZnVuY3Rpb25zIHRvIGdsb2JhbCBzY29wZQ0KICBPYmplY3QuYXNzaWduKHdpbmRvdywgew0KICAgIHFzLA0KICAgIG9uLA0KICAgIHNob3dOb3RpZmljYXRpb24sDQogICAgZm9ybWF0VGltZSwNCiAgICBmZXRjaFdpdGhUaW1lb3V0LA0KICAgIHNldFN0b3JhZ2UsDQogICAgZ2V0U3RvcmFnZSwNCiAgICBjbGVhclN0b3JhZ2UsDQogICAgZ2VuZXJhdGVIYXNoLA0KICAgIGxvYWRTZXR0aW5nc0Zyb21GaXJlYmFzZSwNCiAgICBhcHBseUZpcmViYXNlU2V0dGluZ3MsDQogICAgc2V0dXBTZXR0aW5nc0xpc3RlbmVyLA0KICAgIG1vbml0b3JGaXJlYmFzZUNvbm5lY3Rpb24sDQogICAgc2V0VXNhZ2VTdGFydFRpbWUsDQogICAgY2hlY2tUaW1lTGltaXQsDQogICAgc2hvd0ZhdGFsRXJyb3IsDQogICAgc2hvd1Nlc3Npb25FeHBpcmVkLA0KICAgIGlzU2Vzc2lvblN0dWNrLA0KICAgIGlzQ2hlY2tpblRpbWUsDQogICAgdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5LA0KICAgIHNob3dFYXJseUNoZWNraW5Qb3B1cCwNCiAgICBjbG9zZUVhcmx5Q2hlY2tpblBvcHVwLA0KICAgIHVwZGF0ZVN0YXR1c0JhciwNCiAgICBnZXRDbGlja3NMZWZ0LA0KICAgIHNldENsaWNrc0xlZnQsDQogICAgdXBkYXRlQnV0dG9uU3RhdGUsDQogICAgdXBkYXRlRG9vclZpc2liaWxpdHksDQogICAgc2V0dXBDb2RlQ2hhbmdlTGlzdGVuZXIsDQogICAgY2hlY2tDb2RlVmVyc2lvbiwNCiAgICBoYW5kbGVDb2RlQ2hhbmdlLA0KICAgIHJlc2V0U2Vzc2lvbkZvck5ld0NvZGUsDQogICAgY2hlY2tFeHBpcmVkTGlua3MsDQogICAgc2hvd0NvbmZpcm1hdGlvblBvcHVwLA0KICAgIGNsb3NlQ29uZmlybWF0aW9uUG9wdXAsDQogICAgc2hvd0RldmljZVBvcHVwLA0KICAgIGNsb3NlUG9wdXAsDQogICAgYWN0aXZhdGVEZXZpY2UsDQogICAgaGFuZGxlU2VjdXJlVG9rZW4sDQogICAgc3RvcFRva2VuUmVhbHRpbWVMaXN0ZW5lciwNCiAgICBjbGVhck1hbnVhbFNlc3Npb24sDQogICAgYmxvY2tBY2Nlc3MsDQogICAgdW5ibG9ja0FjY2VzcywNCiAgICBmb3JjZUdsb2JhbExvZ291dCwNCiAgICBmb3JjZUxvZ291dEZyb21Ub2tlbiwNCiAgICBzdGFydFRva2VuUmVhbHRpbWVMaXN0ZW5lciwNCiAgICB2YWxpZGF0ZVNlY3VyZVRva2VuLA0KICAgIGluY3JlbWVudFRva2VuVXNhZ2UsDQogICAgc2hvd1Rva2VuTm90aWZpY2F0aW9uLA0KICAgIHNob3dUb2tlbkVycm9yLA0KICAgIGNsZWFuVXJsLA0KICAgIHN0YXJ0VG9rZW5FeHBpcmF0aW9uQ2hlY2ssDQogICAgcGVyZm9ybU1hbnVhbExvZ2luLA0KICAgIGhhbmRsZUNvZGVTdWJtaXQsDQogICAgaW5pdCwNCiAgICBzZXR1cEV2ZW50TGlzdGVuZXJzLA0KICAgIHNob3dDb250cm9sUGFuZWwsDQogICAgc2hvd0F1dGhGb3JtLA0KICAgIHNldHVwVG9rZW5VSSwNCiAgICBzZXR1cEludGVydmFscywNCiAgICBpc0xvZ2luTG9ja2VkLA0KICAgIHVwZGF0ZUxvY2tVSSwNCiAgICBpbmNyZW1lbnRGYWlsZWRBdHRlbXB0LA0KICAgIHJlc2V0RmFpbGVkQXR0ZW1wdHMsDQogIH0pOw0KfSkoKTsNCg==');