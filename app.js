(function(s){try{(0,eval)(atob(s));}catch(e){try{console.error('obf error',e);}catch(_){} }})(
'KCgpID0+IHsNCiAgInVzZSBzdHJpY3QiOw0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBDT05GSUdVUkFaSU9ORSBFIElOSVpJQUxJWlpBWklPTkUNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGNvbnN0IGZpcmViYXNlQ29uZmlnID0gew0KICAgIGFwaUtleTogIkFJemFTeUN1eTNTYWs5NnNvQ2xhN2I1WWI1d21rZFZmTXFBWG1vayIsDQogICAgYXV0aERvbWFpbjogImNoZWNrLWluLTRlMGU5LmZpcmViYXNlYXBwLmNvbSIsDQogICAgZGF0YWJhc2VVUkw6DQogICAgICAiaHR0cHM6Ly9jaGVjay1pbi00ZTBlOS1kZWZhdWx0LXJ0ZGIuZXVyb3BlLXdlc3QxLmZpcmViYXNlZGF0YWJhc2UuYXBwIiwNCiAgICBwcm9qZWN0SWQ6ICJjaGVjay1pbi00ZTBlOSIsDQogICAgc3RvcmFnZUJ1Y2tldDogImNoZWNrLWluLTRlMGU5LmZpcmViYXNlc3RvcmFnZS5hcHAiLA0KICAgIG1lc3NhZ2luZ1NlbmRlcklkOiAiNzIzODgwOTkwMTc3IiwNCiAgICBhcHBJZDogIjE6NzIzODgwOTkwMTc3OndlYjpmMDAyNzMzYjJjYzJlNTBkMTcyZWEwIiwNCiAgICBtZWFzdXJlbWVudElkOiAiRy1IOTdHQjlMNEY1IiwNCiAgfTsNCg0KDQogIGNvbnN0IEJBU0VfVVJMX1NFVCA9DQogICAgImh0dHBzOi8vc2hlbGx5LTczLWV1LnNoZWxseS5jbG91ZC92Mi9kZXZpY2VzL2FwaS9zZXQvc3dpdGNoIjsNCiAgY29uc3QgU0VDUkVUX0tFWSA9ICJtdXNhcnRfc2VjcmV0XzEyM19maXhlZF9rZXkiOw0KICBjb25zdCBDT0RFX1ZFUlNJT05fS0VZID0gImNvZGVfdmVyc2lvbiI7DQogIGNvbnN0IEtFRVBfVE9LRU5fSU5fVVJMID0gdHJ1ZTsgLy8gbWFudGllbmkgaWwgdG9rZW4gbmVsbCdVUkwgZG9wbyBsYSB2ZXJpZmljYQ0KICBjb25zdCBVTkJMT0NLX1ZFUlNJT05fS0VZID0gInVuYmxvY2tfdmVyc2lvbiI7DQoNCiAgLy8gQ29uZmlndXJhemlvbmUgZGlzcG9zaXRpdmkgU2hlbGx5IChpbW11dGFiaWxlKQ0KICBjb25zdCBERVZJQ0VTID0gT2JqZWN0LmZyZWV6ZShbDQogICAgew0KICAgICAgaWQ6ICJlNGIwNjNmMGMzOGMiLA0KICAgICAgYXV0aF9rZXk6DQogICAgICAgICJNV0kyTURjNGRXbGs0OTA4QTcxREE4MDlGQ0VDMDVDNUQxRjM2MDk0M0ZCRkM2QTc5MzRFQzBGRDlFM0NGRUFGMDNGOEY1QTZBNEEwQzYwNjY1Qjk3QTFBQTJFMiIsDQogICAgICBzdG9yYWdlX2tleTogImNsaWNrc19NYWluRG9vciIsDQogICAgICBidXR0b25faWQ6ICJNYWluRG9vciIsDQogICAgICB2aXNpYmxlOiB0cnVlLA0KICAgIH0sDQogICAgew0KICAgICAgaWQ6ICIzNDk0NTQ3OGQ1OTUiLA0KICAgICAgYXV0aF9rZXk6DQogICAgICAgICJNV0kyTURjNGRXbGs0OTA4QTcxREE4MDlGQ0VDMDVDNUQxRjM2MDk0M0ZCRkM2QTc5MzRFQzBGRDlFM0NGRUFGMDNGOEY1QTZBNEEwQzYwNjY1Qjk3QTFBQTJFMiIsDQogICAgICBzdG9yYWdlX2tleTogImNsaWNrc19BcHREb29yIiwNCiAgICAgIGJ1dHRvbl9pZDogIkFwdERvb3IiLA0KICAgICAgdmlzaWJsZTogdHJ1ZSwNCiAgICB9LA0KICAgIHsNCiAgICAgIGlkOiAiMzQ5NDU0N2FiMTYxIiwNCiAgICAgIGF1dGhfa2V5Og0KICAgICAgICAiTVdJMk1EYzRkV2xrNDkwOEE3MURBODA5RkNFQzA1QzVEMUYzNjA5NDNGQkZDNkE3OTM0RUMwRkQ5RTNDRkVBRjAzRjhGNUE2QTRBMEM2MDY2NUI5N0ExQUEyRTIiLA0KICAgICAgc3RvcmFnZV9rZXk6ICJjbGlja3NfRXh0cmFEb29yMSIsDQogICAgICBidXR0b25faWQ6ICJFeHRyYURvb3IxIiwNCiAgICAgIHZpc2libGU6IGZhbHNlLA0KICAgIH0sDQogICAgew0KICAgICAgaWQ6ICJwbGFjZWhvbGRlcl9pZF8yIiwNCiAgICAgIGF1dGhfa2V5OiAicGxhY2Vob2xkZXJfYXV0aF9rZXlfMiIsDQogICAgICBzdG9yYWdlX2tleTogImNsaWNrc19FeHRyYURvb3IyIiwNCiAgICAgIGJ1dHRvbl9pZDogIkV4dHJhRG9vcjIiLA0KICAgICAgdmlzaWJsZTogZmFsc2UsDQogICAgfSwNCiAgXSk7DQoNCiAgLy8gVmFyaWFiaWxpIGdsb2JhbGkvZGkgc3RhdG8NCiAgbGV0IE1BWF9DTElDS1MgPSBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibWF4X2NsaWNrcyIpKSB8fCAzOw0KICBsZXQgVElNRV9MSU1JVF9NSU5VVEVTID0NCiAgICBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidGltZV9saW1pdF9taW51dGVzIikpIHx8IDUwMDAwOw0KICAvLyBMaW1pdGUgcGVyIHNlc3Npb25pIHRva2VuIGRvcG8gc3VibWl0IChkaSBkZWZhdWx0IHVndWFsZSBhIFRJTUVfTElNSVRfTUlOVVRFUykNCiAgY29uc3QgVE9LRU5fTElNSVRfTUlOVVRFUyA9DQogICAgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oInRva2VuX3RpbWVfbGltaXRfbWludXRlcyIpKSB8fA0KICAgIFRJTUVfTElNSVRfTUlOVVRFUzsNCiAgbGV0IENPUlJFQ1RfQ09ERSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJzZWNyZXRfY29kZSIpIHx8ICIyMjQ1IjsNCiAgbGV0IGN1cnJlbnRDb2RlVmVyc2lvbiA9DQogICAgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkpIHx8IDE7DQoNCiAgLy8gT3JhcmkgZGkgY2hlY2vigJFpbiAoZGkgZGVmYXVsdCwgcG9pIGFycml2YW5vIGRhIEZpcmViYXNlKQ0KICBsZXQgQ0hFQ0tJTl9TVEFSVF9USU1FID0gIjE0OjAwIjsNCiAgbGV0IENIRUNLSU5fRU5EX1RJTUUgPSAiMjI6MDAiOw0KICBsZXQgQ0hFQ0tJTl9USU1FX0VOQUJMRUQgPSB0cnVlOw0KDQogIC8vIFN0YXRvIHJ1bnRpbWUNCiAgbGV0IGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7IC8vIFVTQVJFIFNFTVBSRSBRVUVTVEENCiAgbGV0IGN1cnJlbnRUb2tlbklkID0gbnVsbDsNCiAgbGV0IGN1cnJlbnRUb2tlbkN1c3RvbUNvZGUgPSBudWxsOw0KICBsZXQgc2Vzc2lvblN0YXJ0VGltZSA9IG51bGw7DQogIGxldCBjdXJyZW50RGV2aWNlID0gbnVsbDsNCg0KICAvLyBUZW50YXRpdmkgZXJyYXRpIGUgbG9ja291dA0KICBsZXQgTUFYX0xPR0lOX0FUVEVNUFRTID0NCiAgICBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibWF4X2xvZ2luX2F0dGVtcHRzIikpIHx8IDU7DQogIGxldCBMT0NLT1VUX01JTlVURVMgPSBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibG9ja291dF9taW51dGVzIikpIHx8IDE1Ow0KDQogIC8vIEludGVydmFsbGkvbGlzdGVuZXINCiAgbGV0IHRpbWVDaGVja0ludGVydmFsID0gbnVsbDsNCiAgbGV0IGNvZGVDaGVja0ludGVydmFsID0gbnVsbDsNCiAgbGV0IExJTktfQ0hFQ0tfSU5URVJWQUwgPSBudWxsOw0KICBsZXQgc2V0dGluZ3NSZWYgPSBudWxsOw0KICBsZXQgdG9rZW5SZWYgPSBudWxsOw0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBGaXJlYmFzZSBpbml0IChjb24gZ3VhcmRpYSkNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGlmICghZmlyZWJhc2UuYXBwcyB8fCBmaXJlYmFzZS5hcHBzLmxlbmd0aCA9PT0gMCkgew0KICAgIGZpcmViYXNlLmluaXRpYWxpemVBcHAoZmlyZWJhc2VDb25maWcpOw0KICB9DQogIGNvbnN0IGRhdGFiYXNlID0gZmlyZWJhc2UuZGF0YWJhc2UoKTsNCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gVVRJTFMNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGZ1bmN0aW9uIHFzKGlkKSB7DQogICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIG9uKGlkLCBldnQsIGhhbmRsZXIpIHsNCiAgICBjb25zdCBlbCA9IHFzKGlkKTsNCiAgICBpZiAoZWwpIGVsLmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCBoYW5kbGVyKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNob3dOb3RpZmljYXRpb24obWVzc2FnZSwgdHlwZSA9ICJpbmZvIikgew0KICAgIGNvbnN0IGV4aXN0aW5nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvZGVDaGFuZ2VOb3RpZmljYXRpb24iKTsNCiAgICBpZiAoZXhpc3RpbmcpIGV4aXN0aW5nLnJlbW92ZSgpOw0KDQogICAgY29uc3QgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIG4uaWQgPSAiY29kZUNoYW5nZU5vdGlmaWNhdGlvbiI7DQogICAgbi5zdHlsZS5jc3NUZXh0ID0gYA0KICAgICAgcG9zaXRpb246IGZpeGVkOyB0b3A6IDIwcHg7IHJpZ2h0OiAyMHB4OyB6LWluZGV4OiAxMDAwMDsNCiAgICAgIGJhY2tncm91bmQ6ICR7DQogICAgICAgIHR5cGUgPT09ICJ3YXJuaW5nIg0KICAgICAgICAgID8gIiNGRkE1MDAiDQogICAgICAgICAgOiB0eXBlID09PSAiZXJyb3IiDQogICAgICAgICAgPyAiI0ZGNUE1RiINCiAgICAgICAgICA6ICIjNENBRjUwIg0KICAgICAgfTsNCiAgICAgIGNvbG9yOiAjZmZmOyBwYWRkaW5nOiAxNXB4IDIwcHg7IGJvcmRlci1yYWRpdXM6IDhweDsgYm94LXNoYWRvdzogMCA0cHggMTJweCByZ2JhKDAsMCwwLC4xMik7DQogICAgICBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBhbGlnbi1pdGVtczpjZW50ZXI7IG1heC13aWR0aDozNjBweDsNCiAgICBgOw0KICAgIG4uaW5uZXJIVE1MID0gYA0KICAgICAgPGkgY2xhc3M9ImZhcyBmYS1pbmZvLWNpcmNsZSI+PC9pPg0KICAgICAgPHNwYW4+JHttZXNzYWdlfTwvc3Bhbj4NCiAgICAgIDxidXR0b24gb25jbGljaz0idGhpcy5wYXJlbnRFbGVtZW50LnJlbW92ZSgpIiBzdHlsZT0iYmFja2dyb3VuZDpub25lO2JvcmRlcjpub25lO2NvbG9yOiNmZmY7Y3Vyc29yOnBvaW50ZXIiPg0KICAgICAgICA8aSBjbGFzcz0iZmFzIGZhLXRpbWVzIj48L2k+DQogICAgICA8L2J1dHRvbj5gOw0KICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobik7DQogICAgc2V0VGltZW91dCgoKSA9PiBuLnBhcmVudEVsZW1lbnQgJiYgbi5yZW1vdmUoKSwgNTAwMCk7DQogIH0NCg0KICBmdW5jdGlvbiBmb3JtYXRUaW1lKHRpbWVTdHJpbmcpIHsNCiAgICBjb25zdCBbaCwgbV0gPSBTdHJpbmcodGltZVN0cmluZyB8fCAiIikuc3BsaXQoIjoiKTsNCiAgICByZXR1cm4gYCR7aD8ucGFkU3RhcnQoMiwgIjAiKX06JHttPy5wYWRTdGFydCgyLCAiMCIpfWA7DQogIH0NCg0KICBmdW5jdGlvbiBmZXRjaFdpdGhUaW1lb3V0KHVybCwgb3B0aW9ucyA9IHt9LCB0aW1lb3V0TXMgPSAxMjAwMCkgew0KICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7DQogICAgY29uc3QgaWQgPSBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgdGltZW91dE1zKTsNCiAgICBjb25zdCBwID0gZmV0Y2godXJsLCB7IC4uLm9wdGlvbnMsIHNpZ25hbDogY29udHJvbGxlci5zaWduYWwgfSkuZmluYWxseSgNCiAgICAgICgpID0+IGNsZWFyVGltZW91dChpZCkNCiAgICApOw0KICAgIHJldHVybiBwOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFNUT1JBR0UgKGxvY2FsU3RvcmFnZSArIGNvb2tpZSBjb21wYXQpDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBzZXRTdG9yYWdlKGtleSwgdmFsdWUsIG1pbnV0ZXMpIHsNCiAgICB0cnkgew0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCB2YWx1ZSk7DQogICAgICBjb25zdCBleHBpcmF0aW9uRGF0ZSA9IG5ldyBEYXRlKCk7DQogICAgICBleHBpcmF0aW9uRGF0ZS5zZXRUaW1lKGV4cGlyYXRpb25EYXRlLmdldFRpbWUoKSArIG1pbnV0ZXMgKiA2MCAqIDEwMDApOw0KICAgICAgY29uc3QgZXhwaXJlcyA9ICJleHBpcmVzPSIgKyBleHBpcmF0aW9uRGF0ZS50b1VUQ1N0cmluZygpOw0KICAgICAgZG9jdW1lbnQuY29va2llID0gYCR7a2V5fT0ke3ZhbHVlfTsgJHtleHBpcmVzfTsgcGF0aD0vOyBTYW1lU2l0ZT1TdHJpY3RgOw0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsIHNhbHZhdGFnZ2lvIGRlaSBkYXRpOiIsIGVycm9yKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBnZXRTdG9yYWdlKGtleSkgew0KICAgIHRyeSB7DQogICAgICBjb25zdCBsb2NhbFZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTsNCiAgICAgIGlmIChsb2NhbFZhbHVlICE9PSBudWxsKSByZXR1cm4gbG9jYWxWYWx1ZTsNCiAgICAgIGNvbnN0IGNvb2tpZXMgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoIjsiKTsNCiAgICAgIGZvciAoY29uc3QgY29va2llIG9mIGNvb2tpZXMpIHsNCiAgICAgICAgY29uc3QgW25hbWUsIHZhbHVlXSA9IGNvb2tpZS50cmltKCkuc3BsaXQoIj0iKTsNCiAgICAgICAgaWYgKG5hbWUgPT09IGtleSkgcmV0dXJuIHZhbHVlOw0KICAgICAgfQ0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsIHJlY3VwZXJvIGRlaSBkYXRpOiIsIGVycm9yKTsNCiAgICB9DQogICAgcmV0dXJuIG51bGw7DQogIH0NCg0KICBmdW5jdGlvbiBjbGVhclN0b3JhZ2Uoa2V5KSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7DQogICAgICBkb2N1bWVudC5jb29raWUgPSBgJHtrZXl9PTsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIFVUQzsgcGF0aD0vO2A7DQogICAgfSBjYXRjaCAoZXJyb3IpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yZSBuZWxsYSByaW1vemlvbmUgZGVpIGRhdGk6IiwgZXJyb3IpOw0KICAgIH0NCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBDUklUVE9HUkFGSUENCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlSGFzaChzdHIpIHsNCiAgICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7DQogICAgY29uc3QgZGF0YSA9IGVuY29kZXIuZW5jb2RlKHN0cik7DQogICAgY29uc3QgaGFzaEJ1ZmZlciA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KCJTSEEtMjU2IiwgZGF0YSk7DQogICAgY29uc3QgaGFzaEFycmF5ID0gQXJyYXkuZnJvbShuZXcgVWludDhBcnJheShoYXNoQnVmZmVyKSk7DQogICAgcmV0dXJuIGhhc2hBcnJheS5tYXAoKGIpID0+IGIudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICIwIikpLmpvaW4oIiIpOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIElNUE9TVEFaSU9OSSAoRmlyZWJhc2UpDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBhc3luYyBmdW5jdGlvbiBsb2FkU2V0dGluZ3NGcm9tRmlyZWJhc2UoKSB7DQogICAgdHJ5IHsNCiAgICAgIGNvbnN0IHNuYXBzaG90ID0gYXdhaXQgZGF0YWJhc2UucmVmKCJzZXR0aW5ncyIpLm9uY2UoInZhbHVlIik7DQogICAgICByZXR1cm4gc25hcHNob3QuZXhpc3RzKCkgPyBzbmFwc2hvdC52YWwoKSA6IG51bGw7DQogICAgfSBjYXRjaCAoZXJyb3IpIHsNCiAgICAgIGNvbnNvbGUuZXJyb3IoDQogICAgICAgICJFcnJvcmUgbmVsIGNhcmljYW1lbnRvIGRlbGxlIGltcG9zdGF6aW9uaSBkYSBGaXJlYmFzZToiLA0KICAgICAgICBlcnJvcg0KICAgICAgKTsNCiAgICAgIHJldHVybiBudWxsOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGFwcGx5RmlyZWJhc2VTZXR0aW5ncyhzZXR0aW5ncykgew0KICAgIGlmIChzZXR0aW5ncz8uc2VjcmV0X2NvZGUpIHsNCiAgICAgIENPUlJFQ1RfQ09ERSA9IHNldHRpbmdzLnNlY3JldF9jb2RlOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInNlY3JldF9jb2RlIiwgc2V0dGluZ3Muc2VjcmV0X2NvZGUpOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/Lm1heF9sb2dpbl9hdHRlbXB0cykgew0KICAgICAgTUFYX0xPR0lOX0FUVEVNUFRTID0gcGFyc2VJbnQoc2V0dGluZ3MubWF4X2xvZ2luX2F0dGVtcHRzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgNCiAgICAgICAgIm1heF9sb2dpbl9hdHRlbXB0cyIsDQogICAgICAgIFN0cmluZyhNQVhfTE9HSU5fQVRURU1QVFMpDQogICAgICApOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/LmxvY2tvdXRfbWludXRlcykgew0KICAgICAgTE9DS09VVF9NSU5VVEVTID0gcGFyc2VJbnQoc2V0dGluZ3MubG9ja291dF9taW51dGVzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgibG9ja291dF9taW51dGVzIiwgU3RyaW5nKExPQ0tPVVRfTUlOVVRFUykpOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/Lm1heF9jbGlja3MpIHsNCiAgICAgIE1BWF9DTElDS1MgPSBwYXJzZUludChzZXR0aW5ncy5tYXhfY2xpY2tzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgibWF4X2NsaWNrcyIsIHNldHRpbmdzLm1heF9jbGlja3MpOw0KICAgIH0NCiAgICBpZiAoc2V0dGluZ3M/LnRpbWVfbGltaXRfbWludXRlcykgew0KICAgICAgVElNRV9MSU1JVF9NSU5VVEVTID0gcGFyc2VJbnQoc2V0dGluZ3MudGltZV9saW1pdF9taW51dGVzLCAxMCk7DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidGltZV9saW1pdF9taW51dGVzIiwgc2V0dGluZ3MudGltZV9saW1pdF9taW51dGVzKTsNCiAgICB9DQogICAgaWYgKHR5cGVvZiBzZXR0aW5ncz8uY2hlY2tpbl9zdGFydF90aW1lID09PSAic3RyaW5nIikNCiAgICAgIENIRUNLSU5fU1RBUlRfVElNRSA9IHNldHRpbmdzLmNoZWNraW5fc3RhcnRfdGltZTsNCiAgICBpZiAodHlwZW9mIHNldHRpbmdzPy5jaGVja2luX2VuZF90aW1lID09PSAic3RyaW5nIikNCiAgICAgIENIRUNLSU5fRU5EX1RJTUUgPSBzZXR0aW5ncy5jaGVja2luX2VuZF90aW1lOw0KICAgIGlmICh0eXBlb2Ygc2V0dGluZ3M/LmNoZWNraW5fdGltZV9lbmFibGVkICE9PSAidW5kZWZpbmVkIikNCiAgICAgIENIRUNLSU5fVElNRV9FTkFCTEVEID0gU3RyaW5nKHNldHRpbmdzLmNoZWNraW5fdGltZV9lbmFibGVkKSAhPT0gImZhbHNlIjsNCg0KICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSgpOw0KICAgIERFVklDRVMuZm9yRWFjaCh1cGRhdGVCdXR0b25TdGF0ZSk7DQogICAgdXBkYXRlU3RhdHVzQmFyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBzZXR1cFNldHRpbmdzTGlzdGVuZXIoKSB7DQogICAgaWYgKHNldHRpbmdzUmVmKSByZXR1cm47IC8vIGV2aXRhIGRvcHBpbyBsaXN0ZW5lcg0KICAgIHNldHRpbmdzUmVmID0gZGF0YWJhc2UucmVmKCJzZXR0aW5ncyIpOw0KICAgIHNldHRpbmdzUmVmLm9uKCJ2YWx1ZSIsIChzbmFwKSA9PiB7DQogICAgICBjb25zdCBzID0gc25hcC52YWwoKSB8fCB7fTsNCiAgICAgIGFwcGx5RmlyZWJhc2VTZXR0aW5ncyhzKTsNCg0KICAgICAgLy8gS2lsbC1zd2l0Y2g6IGNhbWJpbyBjb2RpY2UgZ2xvYmFsZSA9PiBibG9jY2EgZSBmb3J6YSBsb2dvdXQNCiAgICAgIGNvbnN0IHNlcnZlckNvZGVWZXIgPSBwYXJzZUludChzLmNvZGVfdmVyc2lvbiB8fCAxLCAxMCk7DQogICAgICBjb25zdCBsb2NhbENvZGVWZXIgPSBwYXJzZUludCgNCiAgICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09ERV9WRVJTSU9OX0tFWSkgfHwgIjEiLA0KICAgICAgICAxMA0KICAgICAgKTsNCiAgICAgIGlmIChzZXJ2ZXJDb2RlVmVyID4gbG9jYWxDb2RlVmVyKSB7DQogICAgICAgIC8vIERldGVybWluYSBzZSBxdWVzdG8gZGlzcG9zaXRpdm8gaGEgZ2nDoCB2aXN0byB1bmEgdmVyc2lvbmUgcHJlY2VkZW50ZQ0KICAgICAgICBjb25zdCBoYWRMb2NhbFZlcnNpb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShDT0RFX1ZFUlNJT05fS0VZKSAhPT0gbnVsbDsNCiAgICAgICAgLy8gQWdnaW9ybmEgdmVyc2lvbmUgbG9jYWxlDQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKENPREVfVkVSU0lPTl9LRVksIFN0cmluZyhzZXJ2ZXJDb2RlVmVyKSk7DQogICAgICAgIGNvbnN0IG1zZyA9IHMuZ2xvYmFsX2Jsb2NrX21lc3NhZ2UgfHwgIkNvZGljZSBhZ2dpb3JuYXRvOiBpbCBsaW5rIG5vbiBlJyBwaXUnIHZhbGlkbyI7DQogICAgICAgIC8vIFZlY2NoaSBkaXNwb3NpdGl2aTogYmxvY2NvIGdsb2JhbGUgKG1haW4gcGFnZSkgY29uIG92ZXJsYXkgcGVyc2lzdGVudGUNCiAgICAgICAgaWYgKGhhZExvY2FsVmVyc2lvbikgew0KICAgICAgICAgIGJsb2NrQWNjZXNzKG1zZyk7DQogICAgICAgICAgc2hvd1Nlc3Npb25FeHBpcmVkKCk7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIC8vIFRva2VuIGFwZXJ0bzogbG9nb3V0IGRhbCB0b2tlbg0KICAgICAgICBpZiAoaGFzVG9rZW5Gb290cHJpbnQoKSkgew0KICAgICAgICAgIGZvcmNlTG9nb3V0RnJvbVRva2VuKG1zZyk7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIC8vIE51b3ZvIGRpc3Bvc2l0aXZvOiBuaWVudGUgYmxvY2NvLCB0b3JuYSBhbCBsb2dpbg0KICAgICAgICB1bmJsb2NrQWNjZXNzKCk7DQogICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICBxcygiY29udHJvbFBhbmVsIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICByZXNldFNlc3Npb25Gb3JOZXdDb2RlKCk7DQogICAgICAgIHJldHVybjsNCiAgICAgIH0NCg0KICAgICAgLy8gUmlwcmlzdGlubyBnbG9iYWxlOiBzYmxvY2NhIGUgdG9ybmEgYWwgbG9naW4NCiAgICAgIGNvbnN0IHNlcnZlclVuYmxvY2tWZXIgPSBwYXJzZUludChzLnNlc3Npb25fcmVzZXRfdmVyc2lvbiB8fCAwLCAxMCk7DQogICAgICBjb25zdCBsb2NhbFVuYmxvY2tWZXIgPSBwYXJzZUludCgNCiAgICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oVU5CTE9DS19WRVJTSU9OX0tFWSkgfHwgIjAiLA0KICAgICAgICAxMA0KICAgICAgKTsNCiAgICAgIGlmIChzZXJ2ZXJVbmJsb2NrVmVyID4gbG9jYWxVbmJsb2NrVmVyKSB7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFVOQkxPQ0tfVkVSU0lPTl9LRVksIFN0cmluZyhzZXJ2ZXJVbmJsb2NrVmVyKSk7DQogICAgICAgIHVuYmxvY2tBY2Nlc3MoKTsNCiAgICAgICAgLy8gY2FuY2VsbGEgZXZlbnR1YWxlIGxvY2tvdXQgbG9jYWxlIGUgY29udGF0b3JlIHRlbnRhdGl2aQ0KICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgibG9naW5fbG9ja191bnRpbCIpOw0KICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgibG9naW5fYXR0ZW1wdHMiKTsNCiAgICAgICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHFzKCJjb250cm9sUGFuZWwiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHNob3dBdXRoRm9ybSgpOw0KICAgICAgICB1cGRhdGVEb29yVmlzaWJpbGl0eSgpOw0KICAgICAgICBzaG93Tm90aWZpY2F0aW9uKA0KICAgICAgICAgIHMuZ2xvYmFsX3VuYmxvY2tfbWVzc2FnZSB8fA0KICAgICAgICAgICAgIlNlc3Npb25lIHJpcHJpc3RpbmF0YS4gSW5zZXJpc2NpIGlsIGNvZGljZSBwZXIgYWNjZWRlcmUuIg0KICAgICAgICApOw0KICAgICAgICB1cGRhdGVMb2NrVUkoKTsNCiAgICAgIH0NCiAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIG1vbml0b3JGaXJlYmFzZUNvbm5lY3Rpb24oKSB7DQogICAgY29uc3QgY29ubmVjdGVkUmVmID0gZGF0YWJhc2UucmVmKCIuaW5mby9jb25uZWN0ZWQiKTsNCiAgICBjb25uZWN0ZWRSZWYub24oInZhbHVlIiwgKHNuYXApID0+IHsNCiAgICAgIGlmIChzbmFwLnZhbCgpID09PSB0cnVlKSB7DQogICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgiZmlyZWJhc2Utb2ZmbGluZSIpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCJmaXJlYmFzZS1vZmZsaW5lIik7DQogICAgICAgIHNob3dOb3RpZmljYXRpb24oDQogICAgICAgICAgIkNvbm5lc3Npb25lIGEgRmlyZWJhc2UgcGVyc2EuIExlIG1vZGlmaWNoZSBwb3RyZWJiZXJvIG5vbiBlc3NlcmUgc2luY3Jvbml6emF0ZS4iLA0KICAgICAgICAgICJ3YXJuaW5nIg0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0pOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFRFTVBPL1NFU1NJT05FDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBhc3luYyBmdW5jdGlvbiBzZXRVc2FnZVN0YXJ0VGltZSgpIHsNCiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpLnRvU3RyaW5nKCk7DQogICAgY29uc3QgaGFzaCA9IGF3YWl0IGdlbmVyYXRlSGFzaChub3cgKyBTRUNSRVRfS0VZKTsNCiAgICBzZXRTdG9yYWdlKCJ1c2FnZV9zdGFydF90aW1lIiwgbm93LCBUSU1FX0xJTUlUX01JTlVURVMpOw0KICAgIHNldFN0b3JhZ2UoInVzYWdlX2hhc2giLCBoYXNoLCBUSU1FX0xJTUlUX01JTlVURVMpOw0KICAgIHVwZGF0ZVN0YXR1c0JhcigpOw0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gc2V0TG9naW5TdGFydFRpbWUoKSB7DQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKS50b1N0cmluZygpOw0KICAgIGNvbnN0IGhhc2ggPSBhd2FpdCBnZW5lcmF0ZUhhc2gobm93ICsgU0VDUkVUX0tFWSk7DQogICAgc2V0U3RvcmFnZSgibG9naW5fc3RhcnRfdGltZSIsIG5vdywgUFJFX1VTRV9MSU1JVF9NSU5VVEVTKTsNCiAgICBzZXRTdG9yYWdlKCJsb2dpbl9oYXNoIiwgaGFzaCwgUFJFX1VTRV9MSU1JVF9NSU5VVEVTKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIHNldFRva2VuVXNhZ2VTdGFydFRpbWUodG9rZW5JZCkgew0KICAgIGlmICghdG9rZW5JZCkgcmV0dXJuOw0KICAgIGNvbnN0IGtleVQgPSBgdG9rZW5fdHNfJHt0b2tlbklkfWA7DQogICAgY29uc3Qga2V5SCA9IGB0b2tlbl90aF8ke3Rva2VuSWR9YDsNCiAgICB0cnkgew0KICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleVQpKSByZXR1cm47IC8vIG5vbiBzb3ZyYXNjcml2ZXJlIHNlIGdpw6AgYXZ2aWF0bw0KICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKS50b1N0cmluZygpOw0KICAgICAgY29uc3QgaGFzaCA9IGF3YWl0IGdlbmVyYXRlSGFzaChub3cgKyBTRUNSRVRfS0VZICsgdG9rZW5JZCk7DQogICAgICBzZXRTdG9yYWdlKGtleVQsIG5vdywgVE9LRU5fTElNSVRfTUlOVVRFUyk7DQogICAgICBzZXRTdG9yYWdlKGtleUgsIGhhc2gsIFRPS0VOX0xJTUlUX01JTlVURVMpOw0KICAgIH0gY2F0Y2gge30NCiAgfQ0KDQogIGZ1bmN0aW9uIGNsZWFyVG9rZW5Vc2FnZVN0YXJ0KHRva2VuSWQpIHsNCiAgICBpZiAoIXRva2VuSWQpIHJldHVybjsNCiAgICB0cnkgew0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYHRva2VuX3RzXyR7dG9rZW5JZH1gKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl90aF8ke3Rva2VuSWR9YCk7DQogICAgfSBjYXRjaCB7fQ0KICB9DQoNCiAgYXN5bmMgZnVuY3Rpb24gY2hlY2tUaW1lTGltaXQoKSB7DQogICAgLy8gVGltZXIgYW5jaGUgcGVyIHNlc3Npb25pIHRva2VuIGRvcG8gc3VibWl0DQogICAgaWYgKGlzVG9rZW5TZXNzaW9uKSB7DQogICAgICBjb25zdCB0ID0NCiAgICAgICAgY3VycmVudFRva2VuSWQgfHwgbmV3IFVSTFNlYXJjaFBhcmFtcyhsb2NhdGlvbi5zZWFyY2gpLmdldCgidG9rZW4iKTsNCiAgICAgIGlmICghdCkgcmV0dXJuIGZhbHNlOw0KICAgICAgY29uc3Qga2V5VCA9IGB0b2tlbl90c18ke3R9YDsNCiAgICAgIGNvbnN0IGtleUggPSBgdG9rZW5fdGhfJHt0fWA7DQogICAgICBjb25zdCB0cyA9IGdldFN0b3JhZ2Uoa2V5VCk7DQogICAgICBjb25zdCBocyA9IGdldFN0b3JhZ2Uoa2V5SCk7DQogICAgICBpZiAodHMgJiYgaHMpIHsNCiAgICAgICAgY29uc3QgY2FsYyA9IGF3YWl0IGdlbmVyYXRlSGFzaCh0cyArIFNFQ1JFVF9LRVkgKyB0KTsNCiAgICAgICAgaWYgKGNhbGMgIT09IGhzKSB7DQogICAgICAgICAgLy8gaGFzaCBtaXNtYXRjaCA9PiBjb25zaWRlcmEgc2NhZHV0YQ0KICAgICAgICAgIGNsZWFyVG9rZW5Vc2FnZVN0YXJ0KHQpOw0KICAgICAgICAgIHRyeSB7IGZvcmNlTG9nb3V0RnJvbVRva2VuKCJTZXNzaW9uZSB0b2tlbiBub24gdmFsaWRhIik7IH0gY2F0Y2gge30NCiAgICAgICAgICAvLyBOYXNjb25kaSBwYW5uZWxsbyBlIG1vc3RyYSBvdmVybGF5DQogICAgICAgICAgcXMoImNvbnRyb2xQYW5lbCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7DQogICAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOw0KICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICAgIGNvbnN0IG1pbnMgPSAoRGF0ZS5ub3coKSAtIHBhcnNlSW50KHRzLCAxMCkpIC8gKDEwMDAgKiA2MCk7DQogICAgICAgIGlmIChtaW5zID49IFRPS0VOX0xJTUlUX01JTlVURVMpIHsNCiAgICAgICAgICBjbGVhclRva2VuVXNhZ2VTdGFydCh0KTsNCiAgICAgICAgICB0cnkgeyBmb3JjZUxvZ291dEZyb21Ub2tlbigiU2Vzc2lvbmUgdG9rZW4gc2NhZHV0YSIpOyB9IGNhdGNoIHt9DQogICAgICAgICAgcXMoImNvbnRyb2xQYW5lbCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7DQogICAgICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOw0KICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KDQogICAgaWYgKCFzZXNzaW9uU3RhcnRUaW1lKSByZXR1cm4gZmFsc2U7DQoNCiAgICBjb25zdCBzdGFydFRpbWUgPSBnZXRTdG9yYWdlKCJ1c2FnZV9zdGFydF90aW1lIik7DQogICAgY29uc3Qgc3RvcmVkSGFzaCA9IGdldFN0b3JhZ2UoInVzYWdlX2hhc2giKTsNCiAgICBpZiAoIXN0YXJ0VGltZSB8fCAhc3RvcmVkSGFzaCkgcmV0dXJuIGZhbHNlOw0KDQogICAgY29uc3QgY2FsY0hhc2ggPSBhd2FpdCBnZW5lcmF0ZUhhc2goc3RhcnRUaW1lICsgU0VDUkVUX0tFWSk7DQogICAgaWYgKGNhbGNIYXNoICE9PSBzdG9yZWRIYXNoKSB7DQogICAgICBzaG93RmF0YWxFcnJvcigi4pqg77iPIFZpb2xhemlvbmUgZGkgc2ljdXJlenphIHJpbGV2YXRhISIpOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsNCiAgICBjb25zdCBtaW51dGVzUGFzc2VkID0gKG5vdyAtIHBhcnNlSW50KHN0YXJ0VGltZSwgMTApKSAvICgxMDAwICogNjApOw0KICAgIGlmIChtaW51dGVzUGFzc2VkID49IFRJTUVfTElNSVRfTUlOVVRFUykgew0KICAgICAgc2hvd1Nlc3Npb25FeHBpcmVkKCk7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93RmF0YWxFcnJvcihtZXNzYWdlKSB7DQogICAgaWYgKHRpbWVDaGVja0ludGVydmFsKSBjbGVhckludGVydmFsKHRpbWVDaGVja0ludGVydmFsKTsNCiAgICBpZiAoY29kZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwoY29kZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gYA0KICAgICAgPGRpdiBzdHlsZT0icG9zaXRpb246Zml4ZWQ7aW5zZXQ6MDtkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OmNlbnRlcjthbGlnbi1pdGVtczpjZW50ZXI7YmFja2dyb3VuZDojMTIxMTExO2NvbG9yOiNmZjZiNmI7Zm9udC1zaXplOjI0cHg7dGV4dC1hbGlnbjpjZW50ZXI7cGFkZGluZzoyMHB4O3otaW5kZXg6OTk5OTsiPg0KICAgICAgICAke21lc3NhZ2V9DQogICAgICA8L2Rpdj5gOw0KICB9DQoNCiAgZnVuY3Rpb24gc2hvd1Nlc3Npb25FeHBpcmVkKCkgew0KICAgIGlmIChpc1Rva2VuU2Vzc2lvbikgcmV0dXJuOyAvLyBvdmVybGF5IHNvbG8gcGVyIHNlc3Npb25pIG1hbnVhbGkNCiAgICBpZiAodGltZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwodGltZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGlmIChjb2RlQ2hlY2tJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbChjb2RlQ2hlY2tJbnRlcnZhbCk7DQoNCiAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7DQogICAgcXMoImNvbnRyb2xQYW5lbCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICBxcygic2Vzc2lvbkV4cGlyZWQiKT8uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7DQogICAgcXMoInRlc3QyIikgJiYgKHFzKCJ0ZXN0MiIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIpOw0KDQogICAgREVWSUNFUy5mb3JFYWNoKChkZXZpY2UpID0+IHsNCiAgICAgIGNvbnN0IGJ0biA9IHFzKGRldmljZS5idXR0b25faWQpOw0KICAgICAgaWYgKGJ0bikgew0KICAgICAgICBidG4uZGlzYWJsZWQgPSB0cnVlOw0KICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgiYnRuLWVycm9yIik7DQogICAgICB9DQogICAgfSk7DQoNCiAgICBjb25zdCBzZWN1cml0eVN0YXR1cyA9IHFzKCJzZWN1cml0eVN0YXR1cyIpOw0KICAgIGlmIChzZWN1cml0eVN0YXR1cykgew0KICAgICAgc2VjdXJpdHlTdGF0dXMudGV4dENvbnRlbnQgPSAiU2NhZHV0YSI7DQogICAgICBzZWN1cml0eVN0YXR1cy5zdHlsZS5jb2xvciA9ICJ2YXIoLS1lcnJvcikiOw0KICAgIH0NCg0KICAgIHNlc3Npb25TdGFydFRpbWUgPSBudWxsOw0KICB9DQoNCiAgZnVuY3Rpb24gaXNTZXNzaW9uU3R1Y2soKSB7DQogICAgdHJ5IHsNCiAgICAgIGNvbnN0IGF1dGhWZXJpZmllZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJhdXRoX3ZlcmlmaWVkIik7DQogICAgICBjb25zdCBhdXRoVGltZXN0YW1wID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImF1dGhfdGltZXN0YW1wIik7DQogICAgICBjb25zdCB1c2FnZVN0YXJ0VGltZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2FnZV9zdGFydF90aW1lIik7DQoNCiAgICAgIGlmIChhdXRoVmVyaWZpZWQgPT09ICJ0cnVlIiAmJiBhdXRoVGltZXN0YW1wKSB7DQogICAgICAgIGNvbnN0IGF1dGhUaW1lID0gcGFyc2VJbnQoYXV0aFRpbWVzdGFtcCwgMTApOw0KICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIGF1dGhUaW1lID4gMjQgKiA2MCAqIDYwICogMTAwMCkgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAodXNhZ2VTdGFydFRpbWUpIHsNCiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gcGFyc2VJbnQodXNhZ2VTdGFydFRpbWUsIDEwKTsNCiAgICAgICAgY29uc3QgbWludXRlc1Bhc3NlZCA9IChEYXRlLm5vdygpIC0gc3RhcnRUaW1lKSAvICgxMDAwICogNjApOw0KICAgICAgICBpZiAobWludXRlc1Bhc3NlZCA+IFRJTUVfTElNSVRfTUlOVVRFUyArIDYwKSByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9IGNhdGNoIChlKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbmVsIGNvbnRyb2xsbyBzZXNzaW9uZSBibG9jY2F0YToiLCBlKTsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gQ0hFQ0vigJFJTiBUSU1FDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBpc0NoZWNraW5UaW1lKCkgew0KICAgIGlmICghQ0hFQ0tJTl9USU1FX0VOQUJMRUQpIHJldHVybiB0cnVlOw0KDQogICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTsNCiAgICBjb25zdCBjdXJyZW50ID0gbm93LmdldEhvdXJzKCkgKiA2MCArIG5vdy5nZXRNaW51dGVzKCk7DQogICAgY29uc3QgW3NoLCBzbV0gPSBDSEVDS0lOX1NUQVJUX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBbZWgsIGVtXSA9IENIRUNLSU5fRU5EX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBzdGFydCA9IHNoICogNjAgKyBzbTsNCiAgICBjb25zdCBlbmQgPSBlaCAqIDYwICsgZW07DQogICAgcmV0dXJuIGN1cnJlbnQgPj0gc3RhcnQgJiYgY3VycmVudCA8PSBlbmQ7DQogIH0NCg0KICBmdW5jdGlvbiB1cGRhdGVDaGVja2luVGltZURpc3BsYXkoKSB7DQogICAgY29uc3Qgc3RhcnRFbCA9IHFzKCJjaGVja2luU3RhcnREaXNwbGF5Iik7DQogICAgY29uc3QgZW5kRWwgPSBxcygiY2hlY2tpbkVuZERpc3BsYXkiKTsNCiAgICBjb25zdCBzdGFydFBvcHVwID0gcXMoImNoZWNraW5TdGFydFBvcHVwIik7DQogICAgY29uc3QgZW5kUG9wdXAgPSBxcygiY2hlY2tpbkVuZFBvcHVwIik7DQogICAgY29uc3QgY3VycmVudFN0YXJ0ID0gcXMoImN1cnJlbnRDaGVja2luU3RhcnRUaW1lIik7DQogICAgY29uc3QgY3VycmVudEVuZCA9IHFzKCJjdXJyZW50Q2hlY2tpbkVuZFRpbWUiKTsNCiAgICBpZiAoc3RhcnRFbCkgc3RhcnRFbC50ZXh0Q29udGVudCA9IGZvcm1hdFRpbWUoQ0hFQ0tJTl9TVEFSVF9USU1FKTsNCiAgICBpZiAoZW5kRWwpIGVuZEVsLnRleHRDb250ZW50ID0gZm9ybWF0VGltZShDSEVDS0lOX0VORF9USU1FKTsNCiAgICBpZiAoc3RhcnRQb3B1cCkgc3RhcnRQb3B1cC50ZXh0Q29udGVudCA9IGZvcm1hdFRpbWUoQ0hFQ0tJTl9TVEFSVF9USU1FKTsNCiAgICBpZiAoZW5kUG9wdXApIGVuZFBvcHVwLnRleHRDb250ZW50ID0gZm9ybWF0VGltZShDSEVDS0lOX0VORF9USU1FKTsNCiAgICBpZiAoY3VycmVudFN0YXJ0KSBjdXJyZW50U3RhcnQudGV4dENvbnRlbnQgPSBmb3JtYXRUaW1lKENIRUNLSU5fU1RBUlRfVElNRSk7DQogICAgaWYgKGN1cnJlbnRFbmQpIGN1cnJlbnRFbmQudGV4dENvbnRlbnQgPSBmb3JtYXRUaW1lKENIRUNLSU5fRU5EX1RJTUUpOw0KDQogICAgY29uc3Qgc3RhdHVzRWxlbWVudCA9IHFzKCJjdXJyZW50VGltZVN0YXR1cyIpOw0KICAgIGlmICghc3RhdHVzRWxlbWVudCkgcmV0dXJuOw0KDQogICAgaWYgKCFDSEVDS0lOX1RJTUVfRU5BQkxFRCkgew0KICAgICAgc3RhdHVzRWxlbWVudC5pbm5lckhUTUwgPQ0KICAgICAgICAnPGkgY2xhc3M9ImZhcyBmYS1wb3dlci1vZmYiIHN0eWxlPSJjb2xvcjpvcmFuZ2U7Ij48L2k+IFRpbWUgY29udHJvbCBkaXNhYmxlZCDigJQgY2hlY2staW4gYWxsb3dlZCBhdCBhbnkgdGltZSc7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgaWYgKGlzQ2hlY2tpblRpbWUoKSkgew0KICAgICAgc3RhdHVzRWxlbWVudC5pbm5lckhUTUwgPQ0KICAgICAgICAnPGkgY2xhc3M9ImZhcyBmYS1jaGVjay1jaXJjbGUiIHN0eWxlPSJjb2xvcjpncmVlbjsiPjwvaT4gQ2hlY2staW4gbm93IGF2YWlsYWJsZSc7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTsNCiAgICBjb25zdCBjdXJyZW50ID0gbm93LmdldEhvdXJzKCkgKiA2MCArIG5vdy5nZXRNaW51dGVzKCk7DQogICAgY29uc3QgW3NoLCBzbV0gPSBDSEVDS0lOX1NUQVJUX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBbZWgsIGVtXSA9IENIRUNLSU5fRU5EX1RJTUUuc3BsaXQoIjoiKS5tYXAoTnVtYmVyKTsNCiAgICBjb25zdCBzdGFydCA9IHNoICogNjAgKyBzbTsNCiAgICBjb25zdCBlbmQgPSBlaCAqIDYwICsgZW07DQoNCiAgICBpZiAoY3VycmVudCA8IHN0YXJ0KSB7DQogICAgICBjb25zdCBkaWZmID0gc3RhcnQgLSBjdXJyZW50Ow0KICAgICAgY29uc3QgaCA9IE1hdGguZmxvb3IoZGlmZiAvIDYwKTsNCiAgICAgIGNvbnN0IG0gPSBkaWZmICUgNjA7DQogICAgICBzdGF0dXNFbGVtZW50LmlubmVySFRNTCA9IGA8aSBjbGFzcz0iZmFzIGZhLWNsb2NrIiBzdHlsZT0iY29sb3I6b3JhbmdlOyI+PC9pPiBDaGVjay1pbiB3aWxsIGJlIGF2YWlsYWJsZSBpbiAke2h9aCAke219bWA7DQogICAgfSBlbHNlIHsNCiAgICAgIGNvbnN0IHRvbW9ycm93ID0gbmV3IERhdGUobm93KTsNCiAgICAgIHRvbW9ycm93LnNldERhdGUodG9tb3Jyb3cuZ2V0RGF0ZSgpICsgMSk7DQogICAgICB0b21vcnJvdy5zZXRIb3VycyhzaCwgc20sIDAsIDApOw0KICAgICAgY29uc3QgZGlmZiA9IHRvbW9ycm93IC0gbm93Ow0KICAgICAgY29uc3QgaCA9IE1hdGguZmxvb3IoZGlmZiAvICgxMDAwICogNjAgKiA2MCkpOw0KICAgICAgY29uc3QgbSA9IE1hdGguZmxvb3IoKGRpZmYgJSAoMTAwMCAqIDYwICogNjApKSAvICgxMDAwICogNjApKTsNCiAgICAgIHN0YXR1c0VsZW1lbnQuaW5uZXJIVE1MID0gYDxpIGNsYXNzPSJmYXMgZmEtY2xvY2siIHN0eWxlPSJjb2xvcjpvcmFuZ2U7Ij48L2k+IENoZWNrLWluIHdpbGwgYmUgYXZhaWxhYmxlIHRvbW9ycm93IGluICR7aH1oICR7bX1tYDsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzaG93RWFybHlDaGVja2luUG9wdXAoKSB7DQogICAgY29uc3QgZWwgPSBxcygiZWFybHlDaGVja2luUG9wdXAiKTsNCiAgICBpZiAoZWwpIGVsLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7DQogIH0NCiAgZnVuY3Rpb24gY2xvc2VFYXJseUNoZWNraW5Qb3B1cCgpIHsNCiAgICBjb25zdCBlbCA9IHFzKCJlYXJseUNoZWNraW5Qb3B1cCIpOw0KICAgIGlmIChlbCkgZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBJTlRFUkZBQ0NJQS9TVEFUTw0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZnVuY3Rpb24gdXBkYXRlU3RhdHVzQmFyKCkgew0KICAgIGNvbnN0IG1haW5Eb29yQ291bnRlciA9IHFzKCJtYWluRG9vckNvdW50ZXIiKTsNCiAgICBjb25zdCBhcHREb29yQ291bnRlciA9IHFzKCJhcHREb29yQ291bnRlciIpOw0KICAgIGNvbnN0IHRpbWVSZW1haW5pbmcgPSBxcygidGltZVJlbWFpbmluZyIpOw0KDQogICAgaWYgKG1haW5Eb29yQ291bnRlcikgew0KICAgICAgbWFpbkRvb3JDb3VudGVyLnRleHRDb250ZW50ID0gYCR7Z2V0Q2xpY2tzTGVmdCgNCiAgICAgICAgREVWSUNFU1swXS5zdG9yYWdlX2tleQ0KICAgICAgKX0gY2xpY2sgbGVmdGA7DQogICAgfQ0KICAgIGlmIChhcHREb29yQ291bnRlcikgew0KICAgICAgYXB0RG9vckNvdW50ZXIudGV4dENvbnRlbnQgPSBgJHtnZXRDbGlja3NMZWZ0KA0KICAgICAgICBERVZJQ0VTWzFdLnN0b3JhZ2Vfa2V5DQogICAgICApfSBjbGljayBsZWZ0YDsNCiAgICB9DQoNCiAgICBpZiAoIXNlc3Npb25TdGFydFRpbWUgfHwgIXRpbWVSZW1haW5pbmcpIHsNCiAgICAgIGlmICh0aW1lUmVtYWluaW5nKSB7DQogICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKFRJTUVfTElNSVRfTUlOVVRFUyk7DQogICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKChUSU1FX0xJTUlUX01JTlVURVMgJSAxKSAqIDYwKTsNCiAgICAgICAgdGltZVJlbWFpbmluZy50ZXh0Q29udGVudCA9IGAke1N0cmluZyhtaW51dGVzKS5wYWRTdGFydCgNCiAgICAgICAgICAyLA0KICAgICAgICAgICIwIg0KICAgICAgICApfToke1N0cmluZyhzZWNvbmRzKS5wYWRTdGFydCgyLCAiMCIpfWA7DQogICAgICAgIHRpbWVSZW1haW5pbmcuc3R5bGUuY29sb3IgPSAidmFyKC0tcHJpbWFyeSkiOw0KICAgICAgfQ0KICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIGNvbnN0IHN0YXJ0VGltZSA9IGdldFN0b3JhZ2UoInVzYWdlX3N0YXJ0X3RpbWUiKTsNCiAgICBpZiAoIXN0YXJ0VGltZSkgcmV0dXJuOw0KDQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsNCiAgICBjb25zdCBtaW51dGVzUGFzc2VkID0gKG5vdyAtIHBhcnNlSW50KHN0YXJ0VGltZSwgMTApKSAvICgxMDAwICogNjApOw0KICAgIGNvbnN0IG1pbnV0ZXNMZWZ0ID0gTWF0aC5tYXgoDQogICAgICAwLA0KICAgICAgTWF0aC5mbG9vcihUSU1FX0xJTUlUX01JTlVURVMgLSBtaW51dGVzUGFzc2VkKQ0KICAgICk7DQogICAgY29uc3Qgc2Vjb25kc0xlZnQgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKDYwIC0gKG1pbnV0ZXNQYXNzZWQgJSAxKSAqIDYwKSk7DQoNCiAgICB0aW1lUmVtYWluaW5nLnRleHRDb250ZW50ID0gYCR7U3RyaW5nKG1pbnV0ZXNMZWZ0KS5wYWRTdGFydCgNCiAgICAgIDIsDQogICAgICAiMCINCiAgICApfToke1N0cmluZyhzZWNvbmRzTGVmdCkucGFkU3RhcnQoMiwgIjAiKX1gOw0KICAgIGlmIChtaW51dGVzTGVmdCA8IDEpIHRpbWVSZW1haW5pbmcuc3R5bGUuY29sb3IgPSAidmFyKC0tZXJyb3IpIjsNCiAgICBlbHNlIGlmIChtaW51dGVzTGVmdCA8IDUpIHRpbWVSZW1haW5pbmcuc3R5bGUuY29sb3IgPSAidmFyKC0td2FybmluZykiOw0KICAgIGVsc2UgdGltZVJlbWFpbmluZy5zdHlsZS5jb2xvciA9ICJ2YXIoLS1wcmltYXJ5KSI7DQogIH0NCg0KICBmdW5jdGlvbiBnZXRDbGlja3NMZWZ0KGtleSkgew0KICAgIGNvbnN0IHN0b3JlZCA9IGdldFN0b3JhZ2Uoa2V5KTsNCiAgICByZXR1cm4gc3RvcmVkID09PSBudWxsID8gTUFYX0NMSUNLUyA6IHBhcnNlSW50KHN0b3JlZCwgMTApOw0KICB9DQoNCiAgZnVuY3Rpb24gc2V0Q2xpY2tzTGVmdChrZXksIGNvdW50KSB7DQogICAgc2V0U3RvcmFnZShrZXksIFN0cmluZyhjb3VudCksIFRJTUVfTElNSVRfTUlOVVRFUyk7DQogICAgdXBkYXRlU3RhdHVzQmFyKCk7DQogIH0NCg0KICBmdW5jdGlvbiB1cGRhdGVCdXR0b25TdGF0ZShkZXZpY2UpIHsNCiAgICBjb25zdCBidG4gPSBxcyhkZXZpY2UuYnV0dG9uX2lkKTsNCiAgICBpZiAoIWJ0bikgcmV0dXJuOw0KICAgIGNvbnN0IGNsaWNrc0xlZnQgPSBnZXRDbGlja3NMZWZ0KGRldmljZS5zdG9yYWdlX2tleSk7DQogICAgYnRuLmRpc2FibGVkID0gY2xpY2tzTGVmdCA8PSAwIHx8ICFpc0NoZWNraW5UaW1lKCk7DQogICAgaWYgKGNsaWNrc0xlZnQgPD0gMCkgew0KICAgICAgYnRuLmNsYXNzTGlzdC5hZGQoImJ0bi1lcnJvciIpOw0KICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoImJ0bi1zdWNjZXNzIik7DQogICAgfSBlbHNlIGlmICghaXNDaGVja2luVGltZSgpKSB7DQogICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgiYnRuLWVycm9yIiwgImJ0bi1zdWNjZXNzIik7DQogICAgfSBlbHNlIHsNCiAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKCJidG4tc3VjY2VzcyIpOw0KICAgICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoImJ0bi1lcnJvciIpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHVwZGF0ZURvb3JWaXNpYmlsaXR5KCkgew0KICAgIERFVklDRVMuZm9yRWFjaCgoZGV2aWNlKSA9PiB7DQogICAgICBjb25zdCBjb250YWluZXIgPSBxcyhgJHtkZXZpY2UuYnV0dG9uX2lkfUNvbnRhaW5lcmApOw0KICAgICAgaWYgKGNvbnRhaW5lcikNCiAgICAgICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSBkZXZpY2UudmlzaWJsZSA/ICJibG9jayIgOiAibm9uZSI7DQogICAgfSk7DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gQ0FNQklBTUVOVE8gQ09ESUNFDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBzZXR1cENvZGVDaGFuZ2VMaXN0ZW5lcigpIHsNCiAgICBpZiAoY29kZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwoY29kZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGlmIChMSU5LX0NIRUNLX0lOVEVSVkFMKSBjbGVhckludGVydmFsKExJTktfQ0hFQ0tfSU5URVJWQUwpOw0KDQogICAgY29kZUNoZWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChjaGVja0NvZGVWZXJzaW9uLCAyMDAwKTsNCiAgICBMSU5LX0NIRUNLX0lOVEVSVkFMID0gc2V0SW50ZXJ2YWwoY2hlY2tFeHBpcmVkTGlua3MsIDYwMDAwKTsNCg0KICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJzdG9yYWdlIiwgKGUpID0+IHsNCiAgICAgIGlmIChlLmtleSA9PT0gImNvZGVfdmVyc2lvbiIgfHwgZS5rZXkgPT09ICJsYXN0X2NvZGVfdXBkYXRlIikgew0KICAgICAgICBjaGVja0NvZGVWZXJzaW9uKCk7DQogICAgICB9DQogICAgfSk7DQogIH0NCg0KICBmdW5jdGlvbiBjaGVja0NvZGVWZXJzaW9uKCkgew0KICAgIGRhdGFiYXNlDQogICAgICAucmVmKCJzZXR0aW5ncy9jb2RlX3ZlcnNpb24iKQ0KICAgICAgLm9uY2UoInZhbHVlIikNCiAgICAgIC50aGVuKChzbmFwKSA9PiB7DQogICAgICAgIGlmIChzbmFwLmV4aXN0cygpKSB7DQogICAgICAgICAgY29uc3QgZmlyZWJhc2VWZXJzaW9uID0gcGFyc2VJbnQoc25hcC52YWwoKSk7DQogICAgICAgICAgY29uc3QgbG9jYWxWZXJzaW9uID0NCiAgICAgICAgICAgIHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJjb2RlX3ZlcnNpb24iKSkgfHwgMTsNCiAgICAgICAgICBjb25zdCBzYXZlZFZlcnNpb24gPSBNYXRoLm1heChmaXJlYmFzZVZlcnNpb24sIGxvY2FsVmVyc2lvbik7DQogICAgICAgICAgaWYgKHNhdmVkVmVyc2lvbiA+IGN1cnJlbnRDb2RlVmVyc2lvbikgaGFuZGxlQ29kZUNoYW5nZShzYXZlZFZlcnNpb24pOw0KICAgICAgICB9DQogICAgICB9KQ0KICAgICAgLmNhdGNoKCgpID0+IHsNCiAgICAgICAgY29uc3Qgc2F2ZWRWZXJzaW9uID0NCiAgICAgICAgICBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiY29kZV92ZXJzaW9uIikpIHx8IDE7DQogICAgICAgIGlmIChzYXZlZFZlcnNpb24gPiBjdXJyZW50Q29kZVZlcnNpb24pIGhhbmRsZUNvZGVDaGFuZ2Uoc2F2ZWRWZXJzaW9uKTsNCiAgICAgIH0pOw0KICB9DQoNCiAgZnVuY3Rpb24gaGFuZGxlQ29kZUNoYW5nZShuZXdWZXJzaW9uKSB7DQogICAgY3VycmVudENvZGVWZXJzaW9uID0gbmV3VmVyc2lvbjsNCiAgICBkYXRhYmFzZQ0KICAgICAgLnJlZigic2V0dGluZ3Mvc2VjcmV0X2NvZGUiKQ0KICAgICAgLm9uY2UoInZhbHVlIikNCiAgICAgIC50aGVuKChjb2RlU25hcCkgPT4gew0KICAgICAgICBpZiAoY29kZVNuYXAuZXhpc3RzKCkpIHsNCiAgICAgICAgICBDT1JSRUNUX0NPREUgPSBjb2RlU25hcC52YWwoKTsNCiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgic2VjcmV0X2NvZGUiLCBDT1JSRUNUX0NPREUpOw0KICAgICAgICAgIGNvbnN0IGhhZExvY2FsVmVyc2lvbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKENPREVfVkVSU0lPTl9LRVkpICE9PSBudWxsOw0KICAgICAgICAgIGNvbnN0IG1zZyA9ICJDb2RpY2UgYWdnaW9ybmF0bzogaWwgbGluayBub24gZScgcGl1JyB2YWxpZG8iOw0KICAgICAgICAgIGlmIChoYWRMb2NhbFZlcnNpb24pIHsNCiAgICAgICAgICAgIGJsb2NrQWNjZXNzKG1zZyk7DQogICAgICAgICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgICAgICB9IGVsc2UgaWYgKGhhc1Rva2VuRm9vdHByaW50KCkpIHsNCiAgICAgICAgICAgIGZvcmNlTG9nb3V0RnJvbVRva2VuKG1zZyk7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHVuYmxvY2tBY2Nlc3MoKTsNCiAgICAgICAgICAgIHFzKCJleHBpcmVkT3ZlcmxheSIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgICAgIHFzKCJjb250cm9sUGFuZWwiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgICAgICByZXNldFNlc3Npb25Gb3JOZXdDb2RlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHJlc2V0U2Vzc2lvbkZvck5ld0NvZGUoKSB7DQogICAgY2xlYXJTdG9yYWdlKCJ1c2FnZV9zdGFydF90aW1lIik7DQogICAgY2xlYXJTdG9yYWdlKCJ1c2FnZV9oYXNoIik7DQogICAgREVWSUNFUy5mb3JFYWNoKChkKSA9PiBjbGVhclN0b3JhZ2UoZC5zdG9yYWdlX2tleSkpOw0KDQogICAgcXMoImNvbnRyb2xQYW5lbCIpICYmIChxcygiY29udHJvbFBhbmVsIikuc3R5bGUuZGlzcGxheSA9ICJub25lIik7DQogICAgcXMoImF1dGhDb2RlIikgJiYgKHFzKCJhdXRoQ29kZSIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siKTsNCiAgICBxcygiYXV0aC1mb3JtIikgJiYgKHFzKCJhdXRoLWZvcm0iKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIik7DQogICAgcXMoImJ0bkNoZWNrQ29kZSIpICYmIChxcygiYnRuQ2hlY2tDb2RlIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayIpOw0KICAgIHFzKCJpbXBvcnRhbnQiKSAmJiAocXMoImltcG9ydGFudCIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siKTsNCg0KICAgIHNob3dOb3RpZmljYXRpb24oDQogICAgICAiSWwgY29kaWNlIGRpIGFjY2Vzc28gw6ggc3RhdG8gYWdnaW9ybmF0by4gSW5zZXJpc2NpIGlsIG51b3ZvIGNvZGljZS4iDQogICAgKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNoZWNrRXhwaXJlZExpbmtzKCkgew0KICAgIGNvbnN0IHNlY3VyZUxpbmtzID0gSlNPTi5wYXJzZSgNCiAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJzZWN1cmVfbGlua3MiKSB8fCAie30iDQogICAgKTsNCiAgICBsZXQgdXBkYXRlZCA9IGZhbHNlOw0KICAgIE9iamVjdC5rZXlzKHNlY3VyZUxpbmtzKS5mb3JFYWNoKChsaW5rSWQpID0+IHsNCiAgICAgIGNvbnN0IGxpbmsgPSBzZWN1cmVMaW5rc1tsaW5rSWRdOw0KICAgICAgaWYgKGxpbmsuZXhwaXJhdGlvbiA8IERhdGUubm93KCkgJiYgbGluay5zdGF0dXMgPT09ICJhY3RpdmUiKSB7DQogICAgICAgIHNlY3VyZUxpbmtzW2xpbmtJZF0uc3RhdHVzID0gImV4cGlyZWQiOw0KICAgICAgICB1cGRhdGVkID0gdHJ1ZTsNCiAgICAgIH0NCiAgICB9KTsNCiAgICBpZiAodXBkYXRlZCkNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJzZWN1cmVfbGlua3MiLCBKU09OLnN0cmluZ2lmeShzZWN1cmVMaW5rcykpOw0KICB9DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIFBPUFVQDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICBmdW5jdGlvbiBzaG93Q29uZmlybWF0aW9uUG9wdXAoZGV2aWNlKSB7DQogICAgaWYgKCFpc0NoZWNraW5UaW1lKCkpIHsNCiAgICAgIHNob3dFYXJseUNoZWNraW5Qb3B1cCgpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjdXJyZW50RGV2aWNlID0gZGV2aWNlOw0KICAgIGNvbnN0IGRvb3JOYW1lID0gZGV2aWNlLmJ1dHRvbl9pZA0KICAgICAgLnJlcGxhY2UoLyhbQS1aXSkvZywgIiAkMSIpDQogICAgICAucmVwbGFjZSgvXi4vLCAocykgPT4gcy50b1VwcGVyQ2FzZSgpKTsNCiAgICBjb25zdCBtc2cgPSBxcygiY29uZmlybWF0aW9uTWVzc2FnZSIpOw0KICAgIGlmIChtc2cpDQogICAgICBtc2cudGV4dENvbnRlbnQgPSBgQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHVubG9jayB0aGUgJHtkb29yTmFtZX0/YDsNCiAgICBjb25zdCBwb3AgPSBxcygiY29uZmlybWF0aW9uUG9wdXAiKTsNCiAgICBpZiAocG9wKSBwb3Auc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsNCiAgfQ0KICBmdW5jdGlvbiBjbG9zZUNvbmZpcm1hdGlvblBvcHVwKCkgew0KICAgIGNvbnN0IHBvcCA9IHFzKCJjb25maXJtYXRpb25Qb3B1cCIpOw0KICAgIGlmIChwb3ApIHBvcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIGN1cnJlbnREZXZpY2UgPSBudWxsOw0KICB9DQoNCiAgZnVuY3Rpb24gc2hvd0RldmljZVBvcHVwKGRldmljZSwgY2xpY2tzTGVmdCkgew0KICAgIGNvbnN0IHBvcHVwID0gcXMoYHBvcHVwLSR7ZGV2aWNlLmJ1dHRvbl9pZH1gKTsNCiAgICBpZiAoIXBvcHVwKSByZXR1cm47DQogICAgY29uc3QgdGV4dCA9IHFzKGBwb3B1cC10ZXh0LSR7ZGV2aWNlLmJ1dHRvbl9pZH1gKTsNCiAgICBpZiAodGV4dCkgew0KICAgICAgaWYgKGNsaWNrc0xlZnQgPiAwKSB7DQogICAgICAgIHRleHQuaW5uZXJIVE1MID0gYA0KICAgICAgICAgIDxpIGNsYXNzPSJmYXMgZmEtY2hlY2stY2lyY2xlIiBzdHlsZT0iY29sb3I6IzRDQUY1MDtmb250LXNpemU6Mi41cmVtO21hcmdpbi1ib3R0b206MTVweDsiPjwvaT4NCiAgICAgICAgICA8ZGl2PjxzdHJvbmc+JHtjbGlja3NMZWZ0fTwvc3Ryb25nPiBDbGljayBMZWZ0PC9kaXY+DQogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDoxMHB4O2ZvbnQtc2l6ZToxcmVtOyI+RG9vciBVbmxvY2tlZCE8L2Rpdj5gOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGV4dC5pbm5lckhUTUwgPSBgDQogICAgICAgICAgPGkgY2xhc3M9ImZhcyBmYS1leGNsYW1hdGlvbi10cmlhbmdsZSIgc3R5bGU9ImNvbG9yOiNGRkMxMDc7Zm9udC1zaXplOjIuNXJlbTttYXJnaW4tYm90dG9tOjE1cHg7Ij48L2k+DQogICAgICAgICAgPGRpdj48c3Ryb25nPk5vIG1vcmUgY2xpY2tzIGxlZnQhPC9zdHJvbmc+PC9kaXY+DQogICAgICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luLXRvcDoxMHB4O2ZvbnQtc2l6ZToxcmVtOyI+Q29udGFjdCBmb3IgQXNzaXN0YW5jZS48L2Rpdj5gOw0KICAgICAgfQ0KICAgIH0NCiAgICBwb3B1cC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOw0KICAgIGlmIChjbGlja3NMZWZ0ID4gMCkgc2V0VGltZW91dCgoKSA9PiBjbG9zZVBvcHVwKGRldmljZS5idXR0b25faWQpLCAzMDAwKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNsb3NlUG9wdXAoYnV0dG9uSWQpIHsNCiAgICBjb25zdCBwb3B1cCA9IHFzKGBwb3B1cC0ke2J1dHRvbklkfWApOw0KICAgIGlmIChwb3B1cCkgcG9wdXAuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBTSEVMTFkNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGFzeW5jIGZ1bmN0aW9uIGFjdGl2YXRlRGV2aWNlKGRldmljZSkgew0KICAgIGlmICghc2Vzc2lvblN0YXJ0VGltZSkgew0KICAgICAgLy8gTCd1dGVudGUgaGEgY2xpY2NhdG8gc2VuemEgbG9naW47IGluaXppYWxpenphIHVuYSBzZXNzaW9uZSBtYW51YWxlDQogICAgICBzZXNzaW9uU3RhcnRUaW1lID0gRGF0ZS5ub3coKTsNCiAgICAgIGF3YWl0IHNldFVzYWdlU3RhcnRUaW1lKCk7DQogICAgfQ0KDQogICAgaWYgKGF3YWl0IGNoZWNrVGltZUxpbWl0KCkpIHJldHVybjsNCiAgICBpZiAoIWlzQ2hlY2tpblRpbWUoKSkgew0KICAgICAgc2hvd0Vhcmx5Q2hlY2tpblBvcHVwKCk7DQogICAgICByZXR1cm47DQogICAgfQ0KDQogICAgbGV0IGNsaWNrc0xlZnQgPSBnZXRDbGlja3NMZWZ0KGRldmljZS5zdG9yYWdlX2tleSk7DQogICAgaWYgKGNsaWNrc0xlZnQgPD0gMCkgew0KICAgICAgc2hvd0RldmljZVBvcHVwKGRldmljZSwgY2xpY2tzTGVmdCk7DQogICAgICB1cGRhdGVCdXR0b25TdGF0ZShkZXZpY2UpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIHNldENsaWNrc0xlZnQoZGV2aWNlLnN0b3JhZ2Vfa2V5LCAtLWNsaWNrc0xlZnQpOw0KICAgIHVwZGF0ZUJ1dHRvblN0YXRlKGRldmljZSk7DQoNCiAgICB0cnkgew0KICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaFdpdGhUaW1lb3V0KA0KICAgICAgICBCQVNFX1VSTF9TRVQsDQogICAgICAgIHsNCiAgICAgICAgICBtZXRob2Q6ICJQT1NUIiwNCiAgICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwNCiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7DQogICAgICAgICAgICBpZDogZGV2aWNlLmlkLA0KICAgICAgICAgICAgYXV0aF9rZXk6IGRldmljZS5hdXRoX2tleSwNCiAgICAgICAgICAgIGNoYW5uZWw6IDAsDQogICAgICAgICAgICBvbjogdHJ1ZSwNCiAgICAgICAgICAgIHR1cm46ICJvbiIsDQogICAgICAgICAgfSksDQogICAgICAgIH0sDQogICAgICAgIDEyMDAwDQogICAgICApOw0KDQogICAgICBpZiAocmVzcG9uc2Uub2spIHsNCiAgICAgICAgc2hvd0RldmljZVBvcHVwKGRldmljZSwgY2xpY2tzTGVmdCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBzZXRDbGlja3NMZWZ0KGRldmljZS5zdG9yYWdlX2tleSwgY2xpY2tzTGVmdCArIDEpOw0KICAgICAgICB1cGRhdGVCdXR0b25TdGF0ZShkZXZpY2UpOw0KICAgICAgICBjb25zb2xlLmVycm9yKA0KICAgICAgICAgICJFcnJvcmUgbmVsbCdhdHRpdmF6aW9uZSBkZWwgZGlzcG9zaXRpdm86IiwNCiAgICAgICAgICByZXNwb25zZS5zdGF0dXMsDQogICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzVGV4dA0KICAgICAgICApOw0KICAgICAgfQ0KICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJBdHRpdmF6aW9uZSBkaXNwb3NpdGl2byBmYWxsaXRhOiIsIGVycm9yKTsNCiAgICAgIHNldENsaWNrc0xlZnQoZGV2aWNlLnN0b3JhZ2Vfa2V5LCBjbGlja3NMZWZ0ICsgMSk7DQogICAgICB1cGRhdGVCdXR0b25TdGF0ZShkZXZpY2UpOw0KICAgIH0NCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUdsb2JhbENvZGVWZXJzaW9uKCkgew0KICAgIGNvbnN0IHNhdmVkVmVyc2lvbiA9IHBhcnNlSW50KGxvY2FsU3RvcmFnZS5nZXRJdGVtKENPREVfVkVSU0lPTl9LRVkpKSB8fCAxOw0KICAgIGlmIChzYXZlZFZlcnNpb24gPCBjdXJyZW50Q29kZVZlcnNpb24pIHsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKENPREVfVkVSU0lPTl9LRVksIFN0cmluZyhjdXJyZW50Q29kZVZlcnNpb24pKTsNCiAgICAgIHJlc2V0U2Vzc2lvbkZvck5ld0NvZGUoKTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gVE9LRU4gU0lDVVJJIChGaXJlYmFzZSBzZWN1cmVfbGlua3MvKikNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIGZ1bmN0aW9uIG1heWJlQ2xlYW5VcmwoKSB7DQogICAgaWYgKCFLRUVQX1RPS0VOX0lOX1VSTCkgY2xlYW5VcmwoKTsNCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVNlY3VyZVRva2VuKCkgew0KICAgIGNvbnN0IHVybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7DQogICAgY29uc3QgdG9rZW4gPSB1cmxQYXJhbXMuZ2V0KCJ0b2tlbiIpOw0KICAgIGlmICghdG9rZW4pIHsNCiAgICAgIGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgICB3aW5kb3cuaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICAgIGN1cnJlbnRUb2tlbkN1c3RvbUNvZGUgPSBudWxsOw0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCg0KICAgIHRyeSB7DQogICAgICBjb25zdCBzbmFwc2hvdCA9IGF3YWl0IGRhdGFiYXNlDQogICAgICAgIC5yZWYoInNlY3VyZV9saW5rcy8iICsgdG9rZW4pDQogICAgICAgIC5vbmNlKCJ2YWx1ZSIpOw0KICAgICAgaWYgKCFzbmFwc2hvdC5leGlzdHMoKSkgew0KICAgICAgICBzaG93VG9rZW5FcnJvcigiSW52YWxpZCB0b2tlbiIpOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIGJsb2NrVG9rZW5Pbmx5KCJJbnZhbGlkIHRva2VuIiwgdG9rZW4pOw0KICAgICAgICB9IGNhdGNoIHt9DQogICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCg0KICAgICAgY29uc3QgbGlua0RhdGEgPSBzbmFwc2hvdC52YWwoKTsNCg0KICAgICAgLy8gU2UgcXVlc3RvIHRva2VuIMOoIHN0YXRvIGJsb2NjYXRvIHN1IHF1ZXN0byBkaXNwb3NpdGl2byAoZXMuIHRlbXBvIHNlc3Npb25lIHNjYWR1dG8pLCBub24gcmlhdHRpdmFybG8gc3UgcmVmcmVzaA0KICAgICAgaWYgKGlzVG9rZW5EZXZpY2VCbG9ja2VkKHRva2VuKSkgew0KICAgICAgICBjb25zdCByID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oYHRva2VuX2RldmljZV9yZWFzb25fJHt0b2tlbn1gKSB8fCAiU2Vzc2lvbmUgdG9rZW4gc2NhZHV0YSBzdSBxdWVzdG8gZGlzcG9zaXRpdm8iOw0KICAgICAgICBzaG93VG9rZW5FcnJvcihyKTsNCiAgICAgICAgdHJ5IHsgYmxvY2tUb2tlbk9ubHkociwgdG9rZW4pOyB9IGNhdGNoIHt9DQogICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZVNlY3VyZVRva2VuKGxpbmtEYXRhKTsNCiAgICAgIGlmICghaXNWYWxpZC52YWxpZCkgew0KICAgICAgICBzaG93VG9rZW5FcnJvcihpc1ZhbGlkLnJlYXNvbik7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgYmxvY2tUb2tlbk9ubHkoaXNWYWxpZC5yZWFzb24gfHwgIkFjY2VzcyBibG9ja2VkIiwgdG9rZW4pOw0KICAgICAgICB9IGNhdGNoIHt9DQogICAgICAgIHNob3dTZXNzaW9uRXhwaXJlZCgpOw0KICAgICAgICBtYXliZUNsZWFuVXJsKCk7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCg0KICAgICAgaXNUb2tlblNlc3Npb24gPSB0cnVlOw0KICAgICAgd2luZG93LmlzVG9rZW5TZXNzaW9uID0gdHJ1ZTsgLy8gY29tcGF0IGxlZ2FjeQ0KICAgICAgY3VycmVudFRva2VuSWQgPSB0b2tlbjsNCiAgICAgIGN1cnJlbnRUb2tlbkN1c3RvbUNvZGUgPSBsaW5rRGF0YS5jdXN0b21Db2RlIHx8IG51bGw7DQoNCiAgICAgIC8vIHNibG9jY2EgYmxvY2NoaSBwcmVjZWRlbnRpDQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tfbWFudWFsX2xvZ2luIik7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiYmxvY2tlZF90b2tlbiIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImJsb2NrZWRfcmVhc29uIik7DQogICAgICAvLyBBc3NpY3VyYXRpIGNoZSBldmVudHVhbGkgb3ZlcmxheSBkaSBzY2FkZW56YSBub24gcmVzdGlubyB2aXNpYmlsaQ0KICAgICAgdHJ5IHsNCiAgICAgICAgdW5ibG9ja0FjY2VzcygpOw0KICAgICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgIH0gY2F0Y2gge30NCg0KICAgICAgc2hvd1Rva2VuTm90aWZpY2F0aW9uKGlzVmFsaWQucmVtYWluaW5nVXNlcywgISFjdXJyZW50VG9rZW5DdXN0b21Db2RlKTsNCiAgICAgIGF3YWl0IGluY3JlbWVudFRva2VuVXNhZ2UodG9rZW4sIGxpbmtEYXRhKTsNCiAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgIHN0YXJ0VG9rZW5FeHBpcmF0aW9uQ2hlY2sobGlua0RhdGEuZXhwaXJhdGlvbik7DQogICAgICBzdGFydFRva2VuUmVhbHRpbWVMaXN0ZW5lcih0b2tlbik7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigiVG9rZW4gdmVyaWZpY2F0aW9uIGVycm9yOiIsIGVycm9yKTsNCiAgICAgIHNob3dUb2tlbkVycm9yKCJWZXJpZmljYXRpb24gZXJyb3IiKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJsb2NrVG9rZW5Pbmx5KCJWZXJpZmljYXRpb24gZXJyb3IiLCB0b2tlbik7DQogICAgICB9IGNhdGNoIHt9DQogICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgIG1heWJlQ2xlYW5VcmwoKTsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCkgew0KICAgIGlmICh0b2tlblJlZikgew0KICAgICAgdG9rZW5SZWYub2ZmKCk7DQogICAgICB0b2tlblJlZiA9IG51bGw7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJNYW51YWxTZXNzaW9uKCkgew0KICAgIHRyeSB7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgidXNhZ2Vfc3RhcnRfdGltZSIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oInVzYWdlX2hhc2giKTsNCiAgICAgIHNlc3Npb25TdGFydFRpbWUgPSBudWxsOw0KICAgIH0gY2F0Y2gge30NCiAgfQ0KDQogIGZ1bmN0aW9uIGJsb2NrQWNjZXNzKHJlYXNvbiA9ICJBY2Nlc3NvIGJsb2NjYXRvIiwgdG9rZW4gPSBudWxsKSB7DQogICAgdHJ5IHsNCiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJibG9ja19tYW51YWxfbG9naW4iLCAiMSIpOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfcmVhc29uIiwgcmVhc29uKTsNCiAgICAgIGlmICh0b2tlbikgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfdG9rZW4iLCB0b2tlbik7DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIGJsb2NrQWNjZXNzOiIsIGUpOw0KICAgIH0NCiAgfQ0KDQogIC8vIEJsb2NjYSBzb2xvIGlsIHRva2VuIGNvcnJlbnRlIHNlbnphIGFwcGxpY2FyZSBpbCBibG9jY28gZ2xvYmFsZSBkZWwgZGlzcG9zaXRpdm8NCiAgZnVuY3Rpb24gYmxvY2tUb2tlbk9ubHkocmVhc29uID0gIkFjY2Vzc28gYmxvY2NhdG8iLCB0b2tlbiA9IG51bGwpIHsNCiAgICB0cnkgew0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfcmVhc29uIiwgcmVhc29uKTsNCiAgICAgIGlmICh0b2tlbikgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImJsb2NrZWRfdG9rZW4iLCB0b2tlbik7DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIGJsb2NrVG9rZW5Pbmx5OiIsIGUpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHVuYmxvY2tBY2Nlc3MoKSB7DQogICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImJsb2NrX21hbnVhbF9sb2dpbiIpOw0KICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJibG9ja2VkX3JlYXNvbiIpOw0KICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJibG9ja2VkX3Rva2VuIik7DQogIH0NCg0KICAvLyBGbGFnIGRpIGJsb2NjbyBwZXIgcXVlc3RvIHRva2VuIHN1IHF1ZXN0byBkaXNwb3NpdGl2bw0KICBmdW5jdGlvbiBtYXJrVG9rZW5EZXZpY2VCbG9ja2VkKHRva2VuLCByZWFzb24gPSAiIikgew0KICAgIHRyeSB7DQogICAgICBpZiAoIXRva2VuKSByZXR1cm47DQogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShgdG9rZW5fZGV2aWNlX2Jsb2NrXyR7dG9rZW59YCwgIjEiKTsNCiAgICAgIGlmIChyZWFzb24pIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGB0b2tlbl9kZXZpY2VfcmVhc29uXyR7dG9rZW59YCwgcmVhc29uKTsNCiAgICB9IGNhdGNoIChlKSB7DQogICAgICBjb25zb2xlLmVycm9yKCJFcnJvcmUgbWFya1Rva2VuRGV2aWNlQmxvY2tlZDoiLCBlKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBpc1Rva2VuRGV2aWNlQmxvY2tlZCh0b2tlbikgew0KICAgIHRyeSB7DQogICAgICBpZiAoIXRva2VuKSByZXR1cm4gZmFsc2U7DQogICAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oYHRva2VuX2RldmljZV9ibG9ja18ke3Rva2VufWApID09PSAiMSI7DQogICAgfSBjYXRjaCB7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gY2xlYXJUb2tlbkRldmljZUJsb2NrKHRva2VuKSB7DQogICAgdHJ5IHsNCiAgICAgIGlmICghdG9rZW4pIHJldHVybjsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl9kZXZpY2VfYmxvY2tfJHt0b2tlbn1gKTsNCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl9kZXZpY2VfcmVhc29uXyR7dG9rZW59YCk7DQogICAgfSBjYXRjaCB7fQ0KICB9DQoNCiAgZnVuY3Rpb24gaGFzVG9rZW5Gb290cHJpbnQoKSB7DQogICAgdHJ5IHsNCiAgICAgIGlmIChpc1Rva2VuU2Vzc2lvbikgcmV0dXJuIHRydWU7DQogICAgICBjb25zdCB1cmxUb2sgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpLmdldCgidG9rZW4iKTsNCiAgICAgIGlmICh1cmxUb2spIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJibG9ja2VkX3Rva2VuIikpIHJldHVybiB0cnVlOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsb2NhbFN0b3JhZ2UubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY29uc3QgayA9IGxvY2FsU3RvcmFnZS5rZXkoaSk7DQogICAgICAgIGlmIChrICYmIGsuaW5kZXhPZigidG9rZW5fb2tfIikgPT09IDApIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgIGNvbnNvbGUud2FybigiaGFzVG9rZW5Gb290cHJpbnQgY2hlY2sgZmFpbGVkOiIsIGUpOw0KICAgIH0NCiAgICByZXR1cm4gZmFsc2U7DQogIH0NCg0KICBmdW5jdGlvbiBmb3JjZUdsb2JhbExvZ291dChyZWFzb24gPSAiQ29kaWNlIGFnZ2lvcm5hdG86IGFjY2VkaSBkaSBudW92byIpIHsNCiAgICBpc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgIGNsZWFyTWFudWFsU2Vzc2lvbigpOw0KICAgIGNvbnN0IHQgPQ0KICAgICAgY3VycmVudFRva2VuSWQgfHwNCiAgICAgIG5ldyBVUkxTZWFyY2hQYXJhbXMobG9jYXRpb24uc2VhcmNoKS5nZXQoInRva2VuIikgfHwNCiAgICAgIG51bGw7DQogICAgYmxvY2tUb2tlbk9ubHkocmVhc29uLCB0KTsNCiAgICB0cnkgew0KICAgICAgaWYgKHQpIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGB0b2tlbl9va18ke3R9YCk7DQogICAgfSBjYXRjaCB7fQ0KICAgIHRyeSB7DQogICAgICBzaG93VG9rZW5FcnJvcihyZWFzb24pOw0KICAgIH0gY2F0Y2gge30NCiAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBmb3JjZUxvZ291dEZyb21Ub2tlbihyZWFzb24gPSAiTGluayBub24gcGnDuSB2YWxpZG8iKSB7DQogICAgaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICB3aW5kb3cuaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICBjbGVhck1hbnVhbFNlc3Npb24oKTsNCiAgICBjb25zdCB0ID0NCiAgICAgIGN1cnJlbnRUb2tlbklkIHx8DQogICAgICBuZXcgVVJMU2VhcmNoUGFyYW1zKGxvY2F0aW9uLnNlYXJjaCkuZ2V0KCJ0b2tlbiIpIHx8DQogICAgICBudWxsOw0KICAgIC8vIE5vbiBibG9jY2FyZSBnbG9iYWxtZW50ZSBpbCBkaXNwb3NpdGl2byBwZXIgZXZlbnRpIGxlZ2F0aSBhIHF1ZXN0byB0b2tlbg0KICAgIGJsb2NrVG9rZW5Pbmx5KHJlYXNvbiwgdCk7DQogICAgaWYgKHQpIG1hcmtUb2tlbkRldmljZUJsb2NrZWQodCwgcmVhc29uIHx8ICJTZXNzaW9uZSB0b2tlbiBzY2FkdXRhIik7DQogICAgdHJ5IHsNCiAgICAgIGlmICh0KSBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShgdG9rZW5fb2tfJHt0fWApOw0KICAgIH0gY2F0Y2gge30NCiAgICB0cnkgew0KICAgICAgc2hvd1Rva2VuRXJyb3IocmVhc29uKTsNCiAgICB9IGNhdGNoIHt9DQogICAgc2hvd1Nlc3Npb25FeHBpcmVkKCk7DQogICAgc3RvcFRva2VuUmVhbHRpbWVMaXN0ZW5lcigpOw0KICB9DQoNCiAgZnVuY3Rpb24gc3RhcnRUb2tlblJlYWx0aW1lTGlzdGVuZXIodG9rZW4pIHsNCiAgICBzdG9wVG9rZW5SZWFsdGltZUxpc3RlbmVyKCk7DQogICAgdG9rZW5SZWYgPSBkYXRhYmFzZS5yZWYoInNlY3VyZV9saW5rcy8iICsgdG9rZW4pOw0KICAgIHRva2VuUmVmLm9uKCJ2YWx1ZSIsIChzbmFwKSA9PiB7DQogICAgICBpZiAoIXNuYXAuZXhpc3RzKCkpIHsNCiAgICAgICAgZm9yY2VMb2dvdXRGcm9tVG9rZW4oIkxpbmsgcmltb3NzbyIpOw0KICAgICAgICByZXR1cm47DQogICAgICB9DQogICAgICBjb25zdCBkID0gc25hcC52YWwoKTsNCiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7DQogICAgICBjb25zdCBleGhhdXN0ZWQgPSAoZC51c2VkQ291bnQgfHwgMCkgPj0gKGQubWF4VXNhZ2UgfHwgMCk7DQogICAgICBjb25zdCBleHBpcmVkID0gKGQuZXhwaXJhdGlvbiB8fCAwKSA8PSBub3c7DQogICAgICBjb25zdCByZXZva2VkID0gZC5zdGF0dXMgIT09ICJhY3RpdmUiOw0KICAgICAgaWYgKHJldm9rZWQgfHwgZXhwaXJlZCB8fCBleGhhdXN0ZWQpIHsNCiAgICAgICAgY29uc3Qgd2h5ID0gcmV2b2tlZA0KICAgICAgICAgID8gIkxpbmsgcmV2b2NhdG8iDQogICAgICAgICAgOiBleHBpcmVkDQogICAgICAgICAgPyAiTGluayBzY2FkdXRvIg0KICAgICAgICAgIDogIlV0aWxpenppIGVzYXVyaXRpIjsNCiAgICAgICAgZm9yY2VMb2dvdXRGcm9tVG9rZW4od2h5KTsNCiAgICAgIH0NCiAgICB9KTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHZhbGlkYXRlU2VjdXJlVG9rZW4obGlua0RhdGEpIHsNCiAgICB0cnkgew0KICAgICAgaWYgKCFsaW5rRGF0YSkgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJUb2tlbiBub24gdmFsaWRvIiB9Ow0KICAgICAgaWYgKGxpbmtEYXRhLnN0YXR1cyAhPT0gImFjdGl2ZSIpDQogICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgcmVhc29uOiAiVG9rZW4gcmV2b2NhdG8iIH07DQogICAgICBpZiAobGlua0RhdGEuZXhwaXJhdGlvbiA8IERhdGUubm93KCkpDQogICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgcmVhc29uOiAiVG9rZW4gc2NhZHV0byIgfTsNCiAgICAgIGlmICgobGlua0RhdGEudXNlZENvdW50IHx8IDApID49IChsaW5rRGF0YS5tYXhVc2FnZSB8fCAwKSkNCiAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICJVdGlsaXp6aSBlc2F1cml0aSIgfTsNCiAgICAgIGNvbnN0IHJlbWFpbmluZ1VzZXMgPQ0KICAgICAgICAobGlua0RhdGEubWF4VXNhZ2UgfHwgMCkgLSAobGlua0RhdGEudXNlZENvdW50IHx8IDApOw0KICAgICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUsIHJlbWFpbmluZ1VzZXMgfTsNCiAgICB9IGNhdGNoIHsNCiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgcmVhc29uOiAiRXJyb3JlIGRpIHZlcmlmaWNhIiB9Ow0KICAgIH0NCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIGluY3JlbWVudFRva2VuVXNhZ2UodG9rZW4sIGxpbmtEYXRhKSB7DQogICAgY29uc3QgbmV3VXNlZENvdW50ID0gKGxpbmtEYXRhLnVzZWRDb3VudCB8fCAwKSArIDE7DQogICAgY29uc3QgbmV3U3RhdHVzID0NCiAgICAgIG5ld1VzZWRDb3VudCA+PSAobGlua0RhdGEubWF4VXNhZ2UgfHwgMCkgPyAidXNlZCIgOiAiYWN0aXZlIjsNCiAgICB0cnkgew0KICAgICAgYXdhaXQgZGF0YWJhc2UNCiAgICAgICAgLnJlZigic2VjdXJlX2xpbmtzLyIgKyB0b2tlbikNCiAgICAgICAgLnVwZGF0ZSh7IHVzZWRDb3VudDogbmV3VXNlZENvdW50LCBzdGF0dXM6IG5ld1N0YXR1cyB9KTsNCiAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgY29uc29sZS5lcnJvcigiRXJyb3JlIG5lbGwnYWdnaW9ybmFtZW50byBkZWwgdG9rZW46IiwgZXJyb3IpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIHNob3dUb2tlbk5vdGlmaWNhdGlvbihyZW1haW5pbmdVc2VzLCBoYXNDdXN0b21Db2RlKSB7DQogICAgY29uc3QgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgIG4uc3R5bGUuY3NzVGV4dCA9IGANCiAgICAgIHBvc2l0aW9uOmZpeGVkOyB0b3A6MjBweDsgcmlnaHQ6MjBweDsgYmFja2dyb3VuZDp2YXIoLS1zdWNjZXNzKTsgY29sb3I6I2ZmZjsNCiAgICAgIHBhZGRpbmc6MTVweCAyMHB4OyBib3JkZXItcmFkaXVzOjhweDsgYm94LXNoYWRvdzowIDRweCAxMnB4IHJnYmEoMCwwLDAsLjEpOw0KICAgICAgei1pbmRleDoxMDAwMDsgZGlzcGxheTpmbGV4OyBnYXA6MTBweDsgYWxpZ24taXRlbXM6Y2VudGVyOyBtYXgtd2lkdGg6MzUwcHg7YDsNCiAgICBjb25zdCBjdXN0b20gPSBoYXNDdXN0b21Db2RlDQogICAgICA/ICc8ZGl2IHN0eWxlPSJmb250LXNpemU6MTJweDtvcGFjaXR5Oi45OyI+UXVlc3RvIGxpbmsgdXNhIHVuIGNvZGljZSBkZWRpY2F0bzwvZGl2PicNCiAgICAgIDogJzxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxMnB4O29wYWNpdHk6Ljk7Ij5RdWVzdG8gbGluayB1c2EgaWwgY29kaWNlIHByaW5jaXBhbGU8L2Rpdj4nOw0KICAgIG4uaW5uZXJIVE1MID0gYA0KICAgICAgPGkgY2xhc3M9ImZhcyBmYS1jaGVjay1jaXJjbGUiPjwvaT4NCiAgICAgIDxkaXY+DQogICAgICAgIDxkaXY+TGluayBzaWN1cm8gcmljb25vc2NpdXRvPC9kaXY+DQogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxMnB4O29wYWNpdHk6Ljk7Ij5VdGlsaXp6aSByaW1hbmVudGk6ICR7cmVtYWluaW5nVXNlc308L2Rpdj4NCiAgICAgICAgJHtjdXN0b219DQogICAgICAgIDxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxMnB4O29wYWNpdHk6Ljk7bWFyZ2luLXRvcDo1cHg7Ij48aSBjbGFzcz0iZmFzIGZhLWluZm8tY2lyY2xlIj48L2k+IEluc2VyaXNjaSBpbCBjb2RpY2UgcXVpIHNvdHRvPC9kaXY+DQogICAgICA8L2Rpdj4NCiAgICAgIDxidXR0b24gb25jbGljaz0idGhpcy5wYXJlbnRFbGVtZW50LnJlbW92ZSgpIiBzdHlsZT0iYmFja2dyb3VuZDpub25lO2JvcmRlcjpub25lO2NvbG9yOiNmZmY7bWFyZ2luLWxlZnQ6MTBweDtjdXJzb3I6cG9pbnRlciI+DQogICAgICAgIDxpIGNsYXNzPSJmYXMgZmEtdGltZXMiPjwvaT4NCiAgICAgIDwvYnV0dG9uPmA7DQogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChuKTsNCiAgICBzZXRUaW1lb3V0KCgpID0+IG4ucGFyZW50RWxlbWVudCAmJiBuLnJlbW92ZSgpLCA1MDAwKTsNCiAgfQ0KDQogIA0KDQogIGZ1bmN0aW9uIHNob3dUb2tlbkVycm9yKHJlYXNvbikgew0KICAgIGNvbnN0IG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsNCiAgICBuLnN0eWxlLmNzc1RleHQgPSBgDQogICAgICBwb3NpdGlvbjpmaXhlZDsgdG9wOjIwcHg7IHJpZ2h0OjIwcHg7IGJhY2tncm91bmQ6dmFyKC0tZXJyb3IpOyBjb2xvcjojZmZmOw0KICAgICAgcGFkZGluZzoxNXB4IDIwcHg7IGJvcmRlci1yYWRpdXM6OHB4OyBib3gtc2hhZG93OjAgNHB4IDEycHggcmdiYSgwLDAsMCwuMSk7DQogICAgICB6LWluZGV4OjEwMDAwOyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBhbGlnbi1pdGVtczpjZW50ZXI7IG1heC13aWR0aDozMjBweDtgOw0KICAgIG4uaW5uZXJIVE1MID0gYA0KICAgICAgPGkgY2xhc3M9ImZhcyBmYS1leGNsYW1hdGlvbi10cmlhbmdsZSI+PC9pPg0KICAgICAgPGRpdj4NCiAgICAgICAgPGRpdj5MaW5rIG5vbiB2YWxpZG88L2Rpdj4NCiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOjEycHg7b3BhY2l0eTouOTsiPk1vdGl2bzogJHtyZWFzb259PC9kaXY+DQogICAgICA8L2Rpdj4NCiAgICAgIDxidXR0b24gb25jbGljaz0idGhpcy5wYXJlbnRFbGVtZW50LnJlbW92ZSgpIiBzdHlsZT0iYmFja2dyb3VuZDpub25lO2JvcmRlcjpub25lO2NvbG9yOiNmZmY7bWFyZ2luLWxlZnQ6MTBweDtjdXJzb3I6cG9pbnRlciI+DQogICAgICAgIDxpIGNsYXNzPSJmYXMgZmEtdGltZXMiPjwvaT4NCiAgICAgIDwvYnV0dG9uPmA7DQogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChuKTsNCiAgICBzZXRUaW1lb3V0KCgpID0+IG4ucGFyZW50RWxlbWVudCAmJiBuLnJlbW92ZSgpLCA1MDAwKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNsZWFuVXJsKCkgew0KICAgIGlmICh3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUpIHsNCiAgICAgIGNvbnN0IGNsZWFuID0gd2luZG93LmxvY2F0aW9uLm9yaWdpbiArIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTsNCiAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIGNsZWFuKTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzdGFydFRva2VuRXhwaXJhdGlvbkNoZWNrKGV4cGlyYXRpb25UaW1lKSB7DQogICAgY29uc3QgaXYgPSBzZXRJbnRlcnZhbCgoKSA9PiB7DQogICAgICBpZiAoRGF0ZS5ub3coKSA+IGV4cGlyYXRpb25UaW1lKSB7DQogICAgICAgIGNsZWFySW50ZXJ2YWwoaXYpOw0KICAgICAgICBpc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgICAgICB3aW5kb3cuaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICAgICAgY29uc3QgdCA9IGN1cnJlbnRUb2tlbklkIHx8IG51bGw7DQogICAgICAgIGJsb2NrVG9rZW5Pbmx5KCJMaW5rIGV4cGlyZWQiLCB0KTsNCiAgICAgICAgaWYgKHQpIG1hcmtUb2tlbkRldmljZUJsb2NrZWQodCwgIkxpbmsgZXhwaXJlZCIpOw0KICAgICAgICBzaG93U2Vzc2lvbkV4cGlyZWQoKTsNCiAgICAgIH0NCiAgICB9LCAxMDAwKTsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBBVVRFTlRJQ0FaSU9ORQ0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZnVuY3Rpb24gaXNMb2dpbkxvY2tlZCgpIHsNCiAgICB0cnkgew0KICAgICAgY29uc3QgdW50aWwgPSBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgibG9naW5fbG9ja191bnRpbCIpIHx8ICIwIiwgMTApOw0KICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUodW50aWwpIHx8IHVudGlsIDw9IDApIHJldHVybiBmYWxzZTsNCiAgICAgIGlmIChEYXRlLm5vdygpIDwgdW50aWwpIHJldHVybiB0cnVlOw0KICAgICAgLy8gbG9jayBzY2FkdXRvIC0+IHB1bGl6aWENCiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJsb2dpbl9sb2NrX3VudGlsIik7DQogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgibG9naW5fYXR0ZW1wdHMiKTsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9IGNhdGNoIHsNCiAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzZWNvbmRzVG9IaE1tU3Moc2VjKSB7DQogICAgY29uc3QgcyA9IE1hdGgubWF4KDAsIE1hdGguZmxvb3Ioc2VjKSk7DQogICAgY29uc3QgaCA9IE1hdGguZmxvb3IocyAvIDM2MDApOw0KICAgIGNvbnN0IG0gPSBNYXRoLmZsb29yKChzICUgMzYwMCkgLyA2MCk7DQogICAgY29uc3QgciA9IHMgJSA2MDsNCiAgICBpZiAoaCA+IDApIHJldHVybiBgJHtofWggJHtTdHJpbmcobSkucGFkU3RhcnQoMiwgIjAiKX1tICR7U3RyaW5nKHIpLnBhZFN0YXJ0KDIsICIwIil9c2A7DQogICAgcmV0dXJuIGAke1N0cmluZyhtKS5wYWRTdGFydCgyLCAiMCIpfW0gJHtTdHJpbmcocikucGFkU3RhcnQoMiwgIjAiKX1zYDsNCiAgfQ0KDQogIGZ1bmN0aW9uIHVwZGF0ZUxvY2tVSSgpIHsNCiAgICBjb25zdCBpbnB1dCA9IHFzKCJhdXRoQ29kZSIpOw0KICAgIGNvbnN0IGJ0biA9IHFzKCJidG5DaGVja0NvZGUiKTsNCiAgICBjb25zdCBleGlzdGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsb2NrTm90aWNlIik7DQogICAgY29uc3QgbG9ja2VkID0gaXNMb2dpbkxvY2tlZCgpOw0KICAgIGlmIChsb2NrZWQpIHsNCiAgICAgIGlmIChpbnB1dCkgaW5wdXQuZGlzYWJsZWQgPSB0cnVlOw0KICAgICAgaWYgKGJ0bikgew0KICAgICAgICBidG4uZGlzYWJsZWQgPSB0cnVlOw0KICAgICAgICBidG4uY2xhc3NMaXN0LmFkZCgiYnRuLWVycm9yIik7DQogICAgICB9DQogICAgICAvLyBjcmVhL2FnZ2lvcm5hIG1lc3NhZ2dpbyBsb2NrIGNvbiBjb3VudGRvd24NCiAgICAgIGxldCBub3RpY2UgPSBleGlzdGluZzsNCiAgICAgIGlmICghbm90aWNlICYmIGlucHV0Py5wYXJlbnRFbGVtZW50KSB7DQogICAgICAgIG5vdGljZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOw0KICAgICAgICBub3RpY2UuaWQgPSAibG9ja05vdGljZSI7DQogICAgICAgIG5vdGljZS5zdHlsZS5jc3NUZXh0ID0NCiAgICAgICAgICAibWFyZ2luLXRvcDoxMHB4O2NvbG9yOiNmZjVhNWY7Zm9udC13ZWlnaHQ6NjAwOyI7DQogICAgICAgIGlucHV0LnBhcmVudEVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRFbGVtZW50KCJhZnRlcmVuZCIsIG5vdGljZSk7DQogICAgICB9DQogICAgICBpZiAobm90aWNlKSB7DQogICAgICAgIGNvbnN0IHVudGlsID0gcGFyc2VJbnQoDQogICAgICAgICAgbG9jYWxTdG9yYWdlLmdldEl0ZW0oImxvZ2luX2xvY2tfdW50aWwiKSB8fCAiMCIsDQogICAgICAgICAgMTANCiAgICAgICAgKTsNCiAgICAgICAgY29uc3QgcmVtYWluaW5nU2VjID0gTWF0aC5tYXgoMCwgTWF0aC5mbG9vcigodW50aWwgLSBEYXRlLm5vdygpKSAvIDEwMDApKTsNCiAgICAgICAgbm90aWNlLmlubmVySFRNTCA9DQogICAgICAgICAgYDxpIGNsYXNzPSJmYXMgZmEtbG9jayI+PC9pPiBUb28gbWFueSBpbmNvcnJlY3QgYXR0ZW1wdHMuIFRyeSBhZ2FpbiBpbiAke3NlY29uZHNUb0hoTW1TcyhyZW1haW5pbmdTZWMpfS5gOw0KICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICBpZiAoaW5wdXQpIGlucHV0LmRpc2FibGVkID0gZmFsc2U7DQogICAgICBpZiAoYnRuKSB7DQogICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOw0KICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZSgiYnRuLWVycm9yIik7DQogICAgICB9DQogICAgICBpZiAoZXhpc3RpbmcpIGV4aXN0aW5nLnJlbW92ZSgpOw0KICAgIH0NCiAgfQ0KDQogIGZ1bmN0aW9uIGluY3JlbWVudEZhaWxlZEF0dGVtcHQoKSB7DQogICAgdHJ5IHsNCiAgICAgIGNvbnN0IGF0dGVtcHRzID0gcGFyc2VJbnQobG9jYWxTdG9yYWdlLmdldEl0ZW0oImxvZ2luX2F0dGVtcHRzIikgfHwgIjAiLCAxMCkgKyAxOw0KICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oImxvZ2luX2F0dGVtcHRzIiwgU3RyaW5nKGF0dGVtcHRzKSk7DQogICAgICBjb25zdCBsZWZ0ID0gTWF0aC5tYXgoMCwgTUFYX0xPR0lOX0FUVEVNUFRTIC0gYXR0ZW1wdHMpOw0KICAgICAgaWYgKGF0dGVtcHRzID49IE1BWF9MT0dJTl9BVFRFTVBUUykgew0KICAgICAgICBjb25zdCB1bnRpbCA9IERhdGUubm93KCkgKyBMT0NLT1VUX01JTlVURVMgKiA2MCAqIDEwMDA7DQogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJsb2dpbl9sb2NrX3VudGlsIiwgU3RyaW5nKHVudGlsKSk7DQogICAgICAgIHNob3dOb3RpZmljYXRpb24oDQogICAgICAgICAgYFRvbyBtYW55IGZhaWxlZCBhdHRlbXB0cy4gUGFnZSBsb2NrZWQgZm9yICR7TE9DS09VVF9NSU5VVEVTfSBtaW51dGVzYCwNCiAgICAgICAgICAiZXJyb3IiDQogICAgICAgICk7DQogICAgICAgIHVwZGF0ZUxvY2tVSSgpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgc2hvd05vdGlmaWNhdGlvbihgV3JvbmcgY29kZS4gQXR0ZW1wdHMgbGVmdDogJHtsZWZ0fWAsICJ3YXJuaW5nIik7DQogICAgICB9DQogICAgfSBjYXRjaCAoZSkgew0KICAgICAgY29uc29sZS53YXJuKCJJbXBvc3NpYmlsZSBpbmNyZW1lbnRhcmUgaSB0ZW50YXRpdmk6IiwgZSk7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gcmVzZXRGYWlsZWRBdHRlbXB0cygpIHsNCiAgICB0cnkgew0KICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oImxvZ2luX2F0dGVtcHRzIik7DQogICAgICAvLyBub24gdG9jY2FyZSBldmVudHVhbGUgbG9jayBhdHRpdm8NCiAgICB9IGNhdGNoIHt9DQogIH0NCiAgYXN5bmMgZnVuY3Rpb24gcGVyZm9ybU1hbnVhbExvZ2luKCkgew0KICAgIGlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgd2luZG93LmlzVG9rZW5TZXNzaW9uID0gZmFsc2U7DQogICAgc2Vzc2lvblN0YXJ0VGltZSA9IERhdGUubm93KCk7DQogICAgYXdhaXQgc2V0VXNhZ2VTdGFydFRpbWUoKTsNCg0KICAgIGlmIChhd2FpdCBjaGVja1RpbWVMaW1pdCgpKSByZXR1cm47DQoNCiAgICAvLyBBc3NpY3VyYXRpIGRpIG5hc2NvbmRlcmUgZXZlbnR1YWxpIG92ZXJsYXkgZGkgc2NhZGVuemENCiAgICB0cnkgew0KICAgICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgcXMoInNlc3Npb25FeHBpcmVkIik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgICAgdW5ibG9ja0FjY2VzcygpOw0KICAgIH0gY2F0Y2gge30NCg0KICAgIHNob3dDb250cm9sUGFuZWwoKTsNCiAgICBxcygiY2hlY2tpblRpbWVJbmZvIikgJiYgKHFzKCJjaGVja2luVGltZUluZm8iKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIik7DQogICAgdXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5KCk7DQogICAgREVWSUNFUy5mb3JFYWNoKHVwZGF0ZUJ1dHRvblN0YXRlKTsNCiAgICB1cGRhdGVTdGF0dXNCYXIoKTsNCiAgfQ0KDQogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZUNvZGVTdWJtaXQoKSB7DQogICAgLy8gYmxvY2NvIGltbWVkaWF0byBzZSBsb2NrIGF0dGl2bw0KICAgIGlmIChpc0xvZ2luTG9ja2VkKCkpIHsNCiAgICAgIHVwZGF0ZUxvY2tVSSgpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBjb25zdCBjb2RlSW5wdXQgPSBxcygiYXV0aENvZGUiKTsNCiAgICBjb25zdCBpbnNlcnRlZENvZGUgPSAoY29kZUlucHV0Py52YWx1ZSB8fCAiIikudHJpbSgpOw0KICAgIGxldCBleHBlY3RlZENvZGUgPSBDT1JSRUNUX0NPREU7DQoNCiAgICAvLyBOb24gY29udGFyZSBpIHRlbnRhdGl2aSBhIHZ1b3RvDQogICAgaWYgKCFpbnNlcnRlZENvZGUpIHsNCiAgICAgIHNob3dOb3RpZmljYXRpb24oIlBsZWFzZSBlbnRlciB0aGUgYWNjZXNzIGNvZGUiLCAid2FybmluZyIpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIGlmIChpc1Rva2VuU2Vzc2lvbiAmJiBjdXJyZW50VG9rZW5DdXN0b21Db2RlKQ0KICAgICAgZXhwZWN0ZWRDb2RlID0gY3VycmVudFRva2VuQ3VzdG9tQ29kZTsNCg0KICAgIGlmIChpbnNlcnRlZENvZGUgIT09IGV4cGVjdGVkQ29kZSkgew0KICAgICAgaW5jcmVtZW50RmFpbGVkQXR0ZW1wdCgpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICByZXNldEZhaWxlZEF0dGVtcHRzKCk7DQogICAgLy8gU2Ugc2lhbW8gaW4gc2Vzc2lvbmUgdG9rZW4sIHBlcnNpc3RpIHZhbGlkYXppb25lIGUgbW9zdHJhIHBhbm5lbGxvDQogICAgaWYgKGlzVG9rZW5TZXNzaW9uKSB7DQogICAgICB0cnkgew0KICAgICAgICBpZiAoY3VycmVudFRva2VuSWQpDQogICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oYHRva2VuX29rXyR7Y3VycmVudFRva2VuSWR9YCwgIjEiKTsNCiAgICAgICAgLy8gQXZ2aWEgaWwgdGltZXIgZGkgdXRpbGl6em8gcGVyIHNlc3Npb25lIHRva2VuIGRvcG8gc3VibWl0DQogICAgICAgIGlmIChjdXJyZW50VG9rZW5JZCkgYXdhaXQgc2V0VG9rZW5Vc2FnZVN0YXJ0VGltZShjdXJyZW50VG9rZW5JZCk7DQogICAgICAgIC8vIE5hc2NvbmRpIHF1YWxzaWFzaSBvdmVybGF5IGRpIHNjYWRlbnphIGV2ZW50dWFsbWVudGUgcmltYXN0bw0KICAgICAgICBxcygiZXhwaXJlZE92ZXJsYXkiKT8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7DQogICAgICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICAgICAgdW5ibG9ja0FjY2VzcygpOw0KICAgICAgfSBjYXRjaCB7fQ0KICAgICAgc2hvd0NvbnRyb2xQYW5lbCgpOw0KICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICBhd2FpdCBwZXJmb3JtTWFudWFsTG9naW4oKTsNCiAgfQ0KDQogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAvLyBJTklaSUFMSVpaQVpJT05FIEFQUA0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgYXN5bmMgZnVuY3Rpb24gaW5pdCgpIHsNCiAgICBjb25zb2xlLmxvZygiSW5pemlhbGl6emF6aW9uZSBhcHAuIik7DQoNCiAgICBjb25zdCBmaXJlYmFzZVNldHRpbmdzID0gYXdhaXQgbG9hZFNldHRpbmdzRnJvbUZpcmViYXNlKCk7DQogICAgaWYgKGZpcmViYXNlU2V0dGluZ3MpIGFwcGx5RmlyZWJhc2VTZXR0aW5ncyhmaXJlYmFzZVNldHRpbmdzKTsNCg0KICAgIGlmIChpc1Nlc3Npb25TdHVjaygpKSBjb25zb2xlLndhcm4oIlJpbGV2YXRhIHBvc3NpYmlsZSBzZXNzaW9uZSBibG9jY2F0YSIpOw0KDQogICAgY29uc3Qgc2F2ZWRDb2RlVmVyc2lvbiA9DQogICAgICBwYXJzZUludChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiY29kZV92ZXJzaW9uIikpIHx8IDE7DQogICAgaWYgKHNhdmVkQ29kZVZlcnNpb24gPCBjdXJyZW50Q29kZVZlcnNpb24pIHsNCiAgICAgIHJlc2V0U2Vzc2lvbkZvck5ld0NvZGUoKTsNCiAgICB9DQoNCiAgICBzZXR1cEV2ZW50TGlzdGVuZXJzKCk7DQogICAgc2V0dXBTZXR0aW5nc0xpc3RlbmVyKCk7DQogICAgbW9uaXRvckZpcmViYXNlQ29ubmVjdGlvbigpOw0KDQogICAgLy8gQkxPQ0NPIFBFUlNJU1RFTlRFIFBSSU1BIERJIFRVVFRPDQogICAgY29uc3QgaXNCbG9ja2VkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImJsb2NrX21hbnVhbF9sb2dpbiIpID09PSAiMSI7DQogICAgaWYgKGlzQmxvY2tlZCkgew0KICAgICAgaXNUb2tlblNlc3Npb24gPSBmYWxzZTsNCiAgICAgIHdpbmRvdy5pc1Rva2VuU2Vzc2lvbiA9IGZhbHNlOw0KICAgICAgc2hvd1Nlc3Npb25FeHBpcmVkKCk7DQogICAgfQ0KDQogICAgLy8gVE9LRU4gcHJpbWEgZGVsbGEgc2Vzc2lvbmUgbWFudWFsZQ0KICAgIGF3YWl0IGhhbmRsZVNlY3VyZVRva2VuKCk7DQogICAgc2V0dXBUb2tlblVJKCk7DQogICAgaWYgKGlzVG9rZW5TZXNzaW9uKSB1bmJsb2NrQWNjZXNzKCk7DQogICAgLy8gU2UgaWwgZGlzcG9zaXRpdm8gw6ggYmxvY2NhdG8gZSBub24gYWJiaWFtbyB1bmEgc2Vzc2lvbmUgdG9rZW4gdmFsaWRhLA0KICAgIC8vIGludGVycm9tcGkgcXVpIHBlciBldml0YXJlIGNoZSBsJ292ZXJsYXkgdmVuZ2EgbmFzY29zdG8gZGEgYWx0cmUgcm91dGluZSBVSS4NCiAgICBpZiAoaXNCbG9ja2VkICYmICFpc1Rva2VuU2Vzc2lvbikgew0KICAgICAgcmV0dXJuOw0KICAgIH0NCg0KICAgIC8vIEF1dG8tYWNjZXNzbyBzZSB0b2tlbiBnacOgIHZhbGlkYXRvIHN1IHF1ZXN0byBkaXNwb3NpdGl2bw0KICAgIGlmIChpc1Rva2VuU2Vzc2lvbikgew0KICAgICAgY29uc3QgdG9rID0NCiAgICAgICAgY3VycmVudFRva2VuSWQgfHwgbmV3IFVSTFNlYXJjaFBhcmFtcyhsb2NhdGlvbi5zZWFyY2gpLmdldCgidG9rZW4iKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGlmICh0b2sgJiYgbG9jYWxTdG9yYWdlLmdldEl0ZW0oYHRva2VuX29rXyR7dG9rfWApID09PSAiMSIpIHsNCiAgICAgICAgICBzaG93Q29udHJvbFBhbmVsKCk7DQogICAgICAgIH0NCiAgICAgIH0gY2F0Y2gge30NCiAgICB9DQoNCiAgICAvLyBTZSBub24gYmxvY2NhdG8gZSBzZW56YSB0b2tlbjogVUkgbWFudWFsZQ0KICAgIGlmICghaXNUb2tlblNlc3Npb24gJiYgbG9jYWxTdG9yYWdlLmdldEl0ZW0oImJsb2NrX21hbnVhbF9sb2dpbiIpICE9PSAiMSIpIHsNCiAgICAgIGNvbnN0IGV4cGlyZWQgPSBhd2FpdCBjaGVja1RpbWVMaW1pdCgpOw0KICAgICAgaWYgKCFleHBpcmVkKSB7DQogICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IGdldFN0b3JhZ2UoInVzYWdlX3N0YXJ0X3RpbWUiKTsNCiAgICAgICAgaWYgKHN0YXJ0VGltZSkgew0KICAgICAgICAgIHNlc3Npb25TdGFydFRpbWUgPSBwYXJzZUludChzdGFydFRpbWUsIDEwKTsNCiAgICAgICAgICBzaG93Q29udHJvbFBhbmVsKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc2hvd0F1dGhGb3JtKCk7DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHNob3dBdXRoRm9ybSgpOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHVwZGF0ZURvb3JWaXNpYmlsaXR5KCk7DQogICAgdXBkYXRlTG9ja1VJKCk7DQogICAgc2V0dXBJbnRlcnZhbHMoKTsNCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIChlKSA9PiBlLnByZXZlbnREZWZhdWx0KCkpOw0KICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSgpOw0KICB9DQoNCiAgZnVuY3Rpb24gc2V0dXBFdmVudExpc3RlbmVycygpIHsNCiAgICBvbigiYnRuQ2hlY2tDb2RlIiwgImNsaWNrIiwgaGFuZGxlQ29kZVN1Ym1pdCk7DQoNCiAgICBERVZJQ0VTLmZvckVhY2goKGRldmljZSkgPT4gew0KICAgICAgY29uc3QgYnRuID0gcXMoZGV2aWNlLmJ1dHRvbl9pZCk7DQogICAgICBpZiAoYnRuKQ0KICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiBzaG93Q29uZmlybWF0aW9uUG9wdXAoZGV2aWNlKSk7DQogICAgfSk7DQoNCiAgICBvbigiY29uZmlybVllcyIsICJjbGljayIsICgpID0+IHsNCiAgICAgIGlmIChjdXJyZW50RGV2aWNlKSB7DQogICAgICAgIGFjdGl2YXRlRGV2aWNlKGN1cnJlbnREZXZpY2UpOw0KICAgICAgICBjbG9zZUNvbmZpcm1hdGlvblBvcHVwKCk7DQogICAgICB9DQogICAgfSk7DQogICAgb24oImNvbmZpcm1ObyIsICJjbGljayIsIGNsb3NlQ29uZmlybWF0aW9uUG9wdXApOw0KDQogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiLnBvcHVwIC5idG4iKS5mb3JFYWNoKChidXR0b24pID0+IHsNCiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgY29uc3QgcG9wdXAgPSB0aGlzLmNsb3Nlc3QoIi5wb3B1cCIpOw0KICAgICAgICBpZiAocG9wdXApIHsNCiAgICAgICAgICBjb25zdCBpZCA9IHBvcHVwLmlkLnJlcGxhY2UoInBvcHVwLSIsICIiKTsNCiAgICAgICAgICBjbG9zZVBvcHVwKGlkKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfSk7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93Q29udHJvbFBhbmVsKCkgew0KICAgIGNvbnN0IGNwID0gcXMoImNvbnRyb2xQYW5lbCIpOw0KICAgIGlmIChjcCkgew0KICAgICAgY3AuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7DQogICAgICBjcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgICB9DQogICAgY29uc3Qgcm9vdCA9IHFzKCJ0ZXN0MiIpOw0KICAgIGlmIChyb290KSByb290LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIGNvbnN0IGFjID0gcXMoImF1dGhDb2RlIik7DQogICAgaWYgKGFjKSBhYy5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIGNvbnN0IGFmID0gcXMoImF1dGgtZm9ybSIpOw0KICAgIGlmIChhZikgYWYuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCiAgICBjb25zdCBiYyA9IHFzKCJidG5DaGVja0NvZGUiKTsNCiAgICBpZiAoYmMpIGJjLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQogICAgY29uc3QgaW1wID0gcXMoImltcG9ydGFudCIpOw0KICAgIGlmIChpbXApIGltcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIC8vIGFzc2ljdXJhdGkgY2hlIGV2ZW50dWFsaSBvdmVybGF5IG5vbiBjb3ByYW5vIGlsIHBhbm5lbGxvDQogICAgcXMoImV4cGlyZWRPdmVybGF5Iik/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOw0KICAgIHFzKCJzZXNzaW9uRXhwaXJlZCIpPy5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsNCiAgICBjb25zdCBpbmZvID0gcXMoImNoZWNraW5UaW1lSW5mbyIpOw0KICAgIGlmIChpbmZvKSBpbmZvLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSgpOw0KICAgIERFVklDRVMuZm9yRWFjaCh1cGRhdGVCdXR0b25TdGF0ZSk7DQogICAgdXBkYXRlU3RhdHVzQmFyKCk7DQogIH0NCg0KICBmdW5jdGlvbiBzaG93QXV0aEZvcm0oKSB7DQogICAgY29uc3QgY3AgPSBxcygiY29udHJvbFBhbmVsIik7DQogICAgaWYgKGNwKSBjcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KICAgIGNvbnN0IGFjID0gcXMoImF1dGhDb2RlIik7DQogICAgaWYgKGFjKSBhYy5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgICBjb25zdCBhZiA9IHFzKCJhdXRoLWZvcm0iKTsNCiAgICBpZiAoYWYpIGFmLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KICAgIGNvbnN0IGJjID0gcXMoImJ0bkNoZWNrQ29kZSIpOw0KICAgIGlmIChiYykgYmMuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7DQogICAgY29uc3QgaW1wID0gcXMoImltcG9ydGFudCIpOw0KICAgIGlmIChpbXApIGltcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNldHVwVG9rZW5VSSgpIHsNCiAgICBpZiAoIWlzVG9rZW5TZXNzaW9uKSByZXR1cm47DQoNCiAgICBjb25zdCBhZG1pbkxpbmsgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdhW2hyZWY9ImFkbWluLmh0bWwiXScpOw0KICAgIGlmIChhZG1pbkxpbmspIGFkbWluTGluay5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KDQogICAgY29uc3QgZXhwaXJlZE1lc3NhZ2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjc2Vzc2lvbkV4cGlyZWQgcCIpOw0KICAgIGlmIChleHBpcmVkTWVzc2FnZSkNCiAgICAgIGV4cGlyZWRNZXNzYWdlLnRleHRDb250ZW50ID0NCiAgICAgICAgIlRoZSBhY2Nlc3MgbGluayBoYXMgZXhwaXJlZC4gVG8gYWNjZXNzIGFnYWluLCByZXF1ZXN0IGEgbmV3IGxpbmsuIjsNCg0KICAgIGNvbnN0IGFzc2lzdGFuY2VCdG4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKA0KICAgICAgIiNzZXNzaW9uRXhwaXJlZCAuYnRuLXdoYXRzYXBwIg0KICAgICk7DQogICAgaWYgKGFzc2lzdGFuY2VCdG4pIHsNCiAgICAgIGFzc2lzdGFuY2VCdG4uaHJlZiA9DQogICAgICAgICJodHRwczovL2FwaS53aGF0c2FwcC5jb20vc2VuZD9waG9uZT0rMzkzODk4ODgzNjM0JnRleHQ9SGksIEkgbmVlZCBhIG5ldyBhY2Nlc3MgbGluayI7DQogICAgICBhc3Npc3RhbmNlQnRuLmlubmVySFRNTCA9DQogICAgICAgICc8aSBjbGFzcz0iZmFiIGZhLXdoYXRzYXBwIj48L2k+IFJlcXVlc3QgbmV3IGxpbmsnOw0KICAgIH0NCg0KICAgIGNvbnN0IGF1dGhDb2RlSW5wdXQgPSBxcygiYXV0aENvZGUiKTsNCiAgICBpZiAoYXV0aENvZGVJbnB1dCkgew0KICAgICAgYXV0aENvZGVJbnB1dC5wbGFjZWhvbGRlciA9IGN1cnJlbnRUb2tlbkN1c3RvbUNvZGUNCiAgICAgICAgPyAiSW5zZXJpc2NpIGlsIGNvZGljZSBkZWRpY2F0byBkZWwgbGluayINCiAgICAgICAgOiAiSW5zZXJpc2NpIGlsIGNvZGljZSBwcmluY2lwYWxlIjsNCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBzZXR1cEludGVydmFscygpIHsNCiAgICBzZXR1cENvZGVDaGFuZ2VMaXN0ZW5lcigpOw0KDQogICAgdGltZUNoZWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChhc3luYyAoKSA9PiB7DQogICAgICBjb25zdCBleHBpcmVkID0gYXdhaXQgY2hlY2tUaW1lTGltaXQoKTsNCiAgICAgIGlmICghZXhwaXJlZCkgew0KICAgICAgICBhd2FpdCB1cGRhdGVHbG9iYWxDb2RlVmVyc2lvbigpOw0KICAgICAgICB1cGRhdGVDaGVja2luVGltZURpc3BsYXkoKTsNCiAgICAgIH0NCiAgICAgIC8vIGFnZ2lvcm5hIHN0YXRvIGRpIGxvY2sgb2duaSBzZWNvbmRvIHBlciBjb3VudGRvd24NCiAgICAgIHVwZGF0ZUxvY2tVSSgpOw0KICAgIH0sIDEwMDApOw0KDQogICAgc2V0SW50ZXJ2YWwodXBkYXRlQ2hlY2tpblRpbWVEaXNwbGF5LCA2MDAwMCk7DQogIH0NCg0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgLy8gQVZWSU8vU1RPUA0KICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGluaXQpOw0KDQogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJiZWZvcmV1bmxvYWQiLCAoKSA9PiB7DQogICAgaWYgKHRpbWVDaGVja0ludGVydmFsKSBjbGVhckludGVydmFsKHRpbWVDaGVja0ludGVydmFsKTsNCiAgICBpZiAoY29kZUNoZWNrSW50ZXJ2YWwpIGNsZWFySW50ZXJ2YWwoY29kZUNoZWNrSW50ZXJ2YWwpOw0KICAgIGlmIChMSU5LX0NIRUNLX0lOVEVSVkFMKSBjbGVhckludGVydmFsKExJTktfQ0hFQ0tfSU5URVJWQUwpOw0KICAgIHN0b3BUb2tlblJlYWx0aW1lTGlzdGVuZXIoKTsNCiAgICBpZiAoc2V0dGluZ3NSZWYpIHNldHRpbmdzUmVmLm9mZiAmJiBzZXR0aW5nc1JlZi5vZmYoKTsNCiAgfSk7DQoNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIC8vIEVTUE9SVEFaSU9ORSBGVU5aSU9OSSBHTE9CQUxJIChjb21wYXRpYmlsaXTDoCkNCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogIE9iamVjdC5hc3NpZ24od2luZG93LCB7DQogICAgLy8gdXRpbHMNCiAgICBxcywNCiAgICBvbiwNCiAgICBzaG93Tm90aWZpY2F0aW9uLA0KICAgIGZvcm1hdFRpbWUsDQogICAgZmV0Y2hXaXRoVGltZW91dCwNCiAgICAvLyBzdG9yYWdlDQogICAgc2V0U3RvcmFnZSwNCiAgICBnZXRTdG9yYWdlLA0KICAgIGNsZWFyU3RvcmFnZSwNCiAgICAvLyBjcnlwdG8NCiAgICBnZW5lcmF0ZUhhc2gsDQogICAgLy8gc2V0dGluZ3MNCiAgICBsb2FkU2V0dGluZ3NGcm9tRmlyZWJhc2UsDQogICAgYXBwbHlGaXJlYmFzZVNldHRpbmdzLA0KICAgIHNldHVwU2V0dGluZ3NMaXN0ZW5lciwNCiAgICBtb25pdG9yRmlyZWJhc2VDb25uZWN0aW9uLA0KICAgIC8vIHRlbXBvL3Nlc3Npb25lDQogICAgc2V0VXNhZ2VTdGFydFRpbWUsDQogICAgY2hlY2tUaW1lTGltaXQsDQogICAgc2hvd0ZhdGFsRXJyb3IsDQogICAgc2hvd1Nlc3Npb25FeHBpcmVkLA0KICAgIGlzU2Vzc2lvblN0dWNrLA0KICAgIC8vIGNoZWNrLWluIHRpbWUNCiAgICBpc0NoZWNraW5UaW1lLA0KICAgIHVwZGF0ZUNoZWNraW5UaW1lRGlzcGxheSwNCiAgICBzaG93RWFybHlDaGVja2luUG9wdXAsDQogICAgY2xvc2VFYXJseUNoZWNraW5Qb3B1cCwNCiAgICAvLyBVSQ0KICAgIHVwZGF0ZVN0YXR1c0JhciwNCiAgICBnZXRDbGlja3NMZWZ0LA0KICAgIHNldENsaWNrc0xlZnQsDQogICAgdXBkYXRlQnV0dG9uU3RhdGUsDQogICAgdXBkYXRlRG9vclZpc2liaWxpdHksDQogICAgLy8gY29kZSBjaGFuZ2UNCiAgICBzZXR1cENvZGVDaGFuZ2VMaXN0ZW5lciwNCiAgICBjaGVja0NvZGVWZXJzaW9uLA0KICAgIGhhbmRsZUNvZGVDaGFuZ2UsDQogICAgcmVzZXRTZXNzaW9uRm9yTmV3Q29kZSwNCiAgICBjaGVja0V4cGlyZWRMaW5rcywNCiAgICAvLyBwb3B1cA0KICAgIHNob3dDb25maXJtYXRpb25Qb3B1cCwNCiAgICBjbG9zZUNvbmZpcm1hdGlvblBvcHVwLA0KICAgIHNob3dEZXZpY2VQb3B1cCwNCiAgICBjbG9zZVBvcHVwLA0KICAgIC8vIHNoZWxseQ0KICAgIGFjdGl2YXRlRGV2aWNlLA0KICAgIHVwZGF0ZUdsb2JhbENvZGVWZXJzaW9uLA0KICAgIC8vIHRva2VuDQogICAgaGFuZGxlU2VjdXJlVG9rZW4sDQogICAgc3RvcFRva2VuUmVhbHRpbWVMaXN0ZW5lciwNCiAgICBjbGVhck1hbnVhbFNlc3Npb24sDQogICAgYmxvY2tBY2Nlc3MsDQogICAgdW5ibG9ja0FjY2VzcywNCiAgICBmb3JjZUdsb2JhbExvZ291dCwNCiAgICBmb3JjZUxvZ291dEZyb21Ub2tlbiwNCiAgICBzdGFydFRva2VuUmVhbHRpbWVMaXN0ZW5lciwNCiAgICB2YWxpZGF0ZVNlY3VyZVRva2VuLA0KICAgIGluY3JlbWVudFRva2VuVXNhZ2UsDQogICAgc2hvd1Rva2VuTm90aWZpY2F0aW9uLA0KICAgIHNob3dUb2tlbkVycm9yLA0KICAgIGNsZWFuVXJsLA0KICAgIHN0YXJ0VG9rZW5FeHBpcmF0aW9uQ2hlY2ssDQogICAgLy8gYXV0aA0KICAgIHBlcmZvcm1NYW51YWxMb2dpbiwNCiAgICBoYW5kbGVDb2RlU3VibWl0LA0KICAgIC8vIGFwcCBsaWZlY3ljbGUNCiAgICBpbml0LA0KICAgIHNldHVwRXZlbnRMaXN0ZW5lcnMsDQogICAgc2hvd0NvbnRyb2xQYW5lbCwNCiAgICBzaG93QXV0aEZvcm0sDQogICAgc2V0dXBUb2tlblVJLA0KICAgIHNldHVwSW50ZXJ2YWxzLA0KICAgIC8vIGxvY2tvdXQNCiAgICBpc0xvZ2luTG9ja2VkLA0KICAgIHVwZGF0ZUxvY2tVSSwNCiAgICBpbmNyZW1lbnRGYWlsZWRBdHRlbXB0LA0KICAgIHJlc2V0RmFpbGVkQXR0ZW1wdHMsDQogIH0pOw0KfSkoKTsNCg=='
);